<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ifelif.cn","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/config.min.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="正经人谁写日记">
<meta property="og:url" content="https://ifelif.cn/page/2/index.html">
<meta property="og:site_name" content="正经人谁写日记">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="filefi">
<meta property="article:tag" content="blog,javascript,nodejs,vue,python,C&#x2F;C++,golang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://ifelif.cn/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>正经人谁写日记</title>
  

  <script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/third-party/analytics/baidu-analytics.min.js"></script>
  <script async src="https://hm.baidu.com/hm.js?3f08a6c1407c206aa070325c05c2844d"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="正经人谁写日记" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">正经人谁写日记</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-专题"><a href="/topics/" rel="section"><i class="fa fa-book fa-fw"></i>专题</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="filefi"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">filefi</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/filefi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;filefi" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://filefi.github.io/" title="https:&#x2F;&#x2F;filefi.github.io" rel="noopener" target="_blank">github home page</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/filefi" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2022/cheat_engine_tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/cheat_engine_tutorial/" class="post-title-link" itemprop="url">CheatEngine Tutorial</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-16 21:41:21" itemprop="dateCreated datePublished" datetime="2022-02-16T21:41:21+08:00">2022-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-12 23:05:22" itemprop="dateModified" datetime="2022-06-12T23:05:22+08:00">2022-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PWN/" itemprop="url" rel="index"><span itemprop="name">PWN</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CheatEngine-Tutorial"><a href="#CheatEngine-Tutorial" class="headerlink" title="CheatEngine Tutorial"></a>CheatEngine Tutorial</h1><h2 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h2><p><img src="/2022/cheat_engine_tutorial/image-20220215145201605.png"></p>
<h3 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h3><pre class="language-text" data-language="text"><code class="language-text">Welcome to the Cheat Engine Tutorial (v3.6)

This tutorial will teach you the basics of cheating in video games. It will also show you foundational aspects of using Cheat Engine (or CE for short). Follow the steps below to get started.

1: Open Cheat Engine if it currently isn't running.
2: Click on the "Open Process" icon (it's the top-left icon with the computer on it, below "File".).
3: With the Process List window now open, look for this tutorial's process in the list. It will look something like "00001F98-Tutorial-x86_64.exe" or "0000047C-Tutorial-i386.exe". (The first 8 numbers/letters will probably be different.)
4: Once you've found the process, click on it to select it, then click the "Open" button. (Don't worry about all the other buttons right now. You can learn about them later if you're interested.)

Congratulations! If you did everything correctly, the process window should be gone with Cheat Engine now attached to the tutorial (you will see the process name towards the top-center of CE).

Click the "Next" button below to continue, or fill in the password and click the "OK" button to proceed to that step.)

If you're having problems, simply head over to forum.cheatengine.org, then click on "Tutorials" to view beginner-friendly guides!</code></pre>

<h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><h4 id="步骤1：选择要附加的进程"><a href="#步骤1：选择要附加的进程" class="headerlink" title="步骤1：选择要附加的进程"></a>步骤1：选择要附加的进程</h4><p><img src="/2022/cheat_engine_tutorial/image-20220215145836858.png"></p>
<p><img src="/2022/cheat_engine_tutorial/image-20220215150314077.png"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/cheat_engine_tutorial/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2017/BIG-IP-Local-Traffic-Manager-Concepts-v11-5-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/BIG-IP-Local-Traffic-Manager-Concepts-v11-5-0/" class="post-title-link" itemprop="url">BIG-IP Local Traffic Manager Concepts v11.5.0</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-11-30 11:30:15" itemprop="dateCreated datePublished" datetime="2017-11-30T11:30:15+08:00">2017-11-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-12 23:05:22" itemprop="dateModified" datetime="2022-06-12T23:05:22+08:00">2022-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/F5/" itemprop="url" rel="index"><span itemprop="name">F5</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>本文是 F5官方文档 <a target="_blank" rel="noopener" href="https://techdocs.f5.com/kb/en-us/products/big-ip_ltm/manuals/product/ltm-concepts-11-5-0.html">BIG-IP Local Traffic Manager Concepts v11.5.0</a> 的中文翻译版。初次于2017年11月30日发布在 <a target="_blank" rel="noopener" href="https://github.com/filefi/CN_BIG-IP_Local_Traffic_Manager_Concepts_v11.5.0">此repo</a>。</p>
</blockquote>
<h1 id="第1章-介绍本地流量管理器（Local-Traffic-Manager）"><a href="#第1章-介绍本地流量管理器（Local-Traffic-Manager）" class="headerlink" title="第1章 介绍本地流量管理器（Local Traffic Manager）"></a>第1章 介绍本地流量管理器（Local Traffic Manager）</h1><h2 id="1-1-什么是BIG-IP本地流量管理器？"><a href="#1-1-什么是BIG-IP本地流量管理器？" class="headerlink" title="1.1 什么是BIG-IP本地流量管理器？"></a>1.1 什么是BIG-IP本地流量管理器？</h2><p>BIG-IP本地流量管理（Local Traffic Manager）控制流入或流出局域网LAN（包括内联网intranet）的网络流量。</p>
<p>出于智能地调整网络服务器上负载的目的，LTM的一个常用功能是它拦截和重定向入站网络流量的能力。但是，调整服务器负载并不是唯一的本地流量管理方式。</p>
<p>LTM包含了各种功能，例如，执行检查和转换报头和内容数据，管理基于SSL证书的认证，以及压缩HTTP响应。这样做，BIG-IP系统不仅会定向流量到适合的服务器资源，而且还通过执行Web服务器通常执行的任务来增强了网络安全，并释放了服务器资源。</p>
<blockquote>
<p>注意： BIG-IP LTM是组成BIG-IP产品系列的几种产品之一。BIG-IP产品线中的所有产品都运行在强大的流量管理操作系统（Traffic Management Operating System）（通常称为TMOS）上。</p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2017/BIG-IP-Local-Traffic-Manager-Concepts-v11-5-0/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2017/BIG-IP-System-iRules-Concepts-v11-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/BIG-IP-System-iRules-Concepts-v11-6/" class="post-title-link" itemprop="url">BIG-IP System iRules Concepts v11.6</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-11-30 09:05:31" itemprop="dateCreated datePublished" datetime="2017-11-30T09:05:31+08:00">2017-11-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-12 23:05:22" itemprop="dateModified" datetime="2022-06-12T23:05:22+08:00">2022-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/F5/" itemprop="url" rel="index"><span itemprop="name">F5</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>本文是 F5官方文档 <a target="_blank" rel="noopener" href="https://support.f5.com/kb/en-us/products/big-ip_ltm/manuals/product/bigip-system-irules-concepts-11-6-0.html">BIG-IP System iRules Concepts v11.6</a> 的中文翻译版。初次于2017年11月30日发布在 <a target="_blank" rel="noopener" href="https://github.com/filefi/CN_BIG-IP_System_iRules_Concepts_v11.6">此repo</a>。</p>
</blockquote>
<h1 id="1-iRules介绍"><a href="#1-iRules介绍" class="headerlink" title="1 iRules介绍"></a>1 iRules介绍</h1><h2 id="什么是iRule"><a href="#什么是iRule" class="headerlink" title="什么是iRule"></a>什么是iRule</h2><p>iRule是BIG-IP本地流量管理器（LTM）中的一个强大而灵活的功能，你可以用它来管理你的网络流量。使用基于行业标准工具命令语言（Tcl）的语法，iRules功能不仅允许您根据报头数据（header data）选择Pools，还可以通过搜索您自定义的任何类型的内容数据来定向流量。因此，iRules功能显著地增强了您自定义内容交换（content switching）以适应您确切需求的能力。</p>
<blockquote>
<p>重要：有关iRules语法的完整和详细信息，请参阅F5 Networks DevCentral网站 <a target="_blank" rel="noopener" href="http://devcentral.f5.com.请注意,irules必须符合标准的tcl语法规则/">http://devcentral.f5.com。请注意，iRules必须符合标准的Tcl语法规则</a>; 因此，有关Tcl语法的更多信息，请参见 <a target="_blank" rel="noopener" href="http://tmml.sourceforge.net/doc/tcl/index.html%E3%80%82">http://tmml.sourceforge.net/doc/tcl/index.html。</a></p>
</blockquote>
<p>如果您想要单独的连接来命中（target）除为Virtual Server定义的默认Pool之外的Pool，则你就可以写这样一个iRule脚本。iRules允许您更直接地指定要将流量定向到你想要的目的地。使用iRules，您不仅可以将流量发送到Pool，还可以向单个Pool Member，端口或URI发送流量。您创建的iRules可以很简单，也可以很复杂，具体取决于您的内容交换（content-switching）需求。</p>
<pre class="language-tcl" data-language="tcl"><code class="language-tcl">when CLIENT_ACCEPTED <span class="token punctuation">&#123;</span>
    <span class="token builtin">if</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">[</span>IP::addr <span class="token punctuation">[</span>IP::client_addr<span class="token punctuation">]</span> equals 10.10.10.10<span class="token punctuation">]</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
        pool my_pool 
    <span class="token punctuation">&#125;</span> 
<span class="token punctuation">&#125;</span></code></pre>

<p>当客户端连接被接受时，这条iRule会被触发。这时，如果客户端的地址与 <code>10.10.10.10</code> 相匹配，将使得本地流量管理器（LTM）将数据包发送到my_pool池。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2017/BIG-IP-System-iRules-Concepts-v11-6/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_13/" class="post-title-link" itemprop="url">MPLS 实验13：Hub-and-Spoke</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-19 23:59:51" itemprop="dateCreated datePublished" datetime="2014-03-19T23:59:51+08:00">2014-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>


<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="GNS3实验拓扑文件："><a href="#GNS3实验拓扑文件：" class="headerlink" title="GNS3实验拓扑文件："></a>GNS3实验拓扑文件：</h1><p><a href="topology.net">拓扑文件</a></p>
<h1 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h1><p><img src="/2014/MPLS_Lab_13/topo.png"></p>
<h1 id="实验场景："><a href="#实验场景：" class="headerlink" title="实验场景："></a>实验场景：</h1><ol>
<li>Spoke站点只能与Hub站点进行通信；</li>
<li>Spoke站点到Spoke站点的流量必须首先发送到Hub站点；</li>
</ol>
<p>要实现以上操作，就必须要使用两个不同的RT，分别负责导入和导出；还需要为不同站点分配不同的RD；</p>
<ol>
<li>使用RT控制VPNv4路由的导入导出；</li>
<li>使用在PE和CE使用BGP Allowas-in解决eBGP防环机制导致</li>
<li>使用SOO解决PE-CE路由协议eBGP的路由环路；</li>
</ol>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R1
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
ip vrf A<span class="token operator">-</span>Site1
        rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip vrf forwarding A<span class="token operator">-</span>Site1
        ip address <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token operator">!</span>
router bgp <span class="token number">1</span>
        bgp router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        neighbor ibgp peer<span class="token operator">-</span>group
        neighbor ibgp remote<span class="token operator">-</span>as <span class="token number">1</span>
        neighbor ibgp update<span class="token operator">-</span>source Loopback0
        neighbor ibgp next<span class="token operator">-</span>hop<span class="token operator">-</span>self
        neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> peer<span class="token operator">-</span>group ibgp
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> peer<span class="token operator">-</span>group ibgp
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family vpnv4
        neighbor ibgp send<span class="token operator">-</span>community both
        neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> activate
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> activate
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
        neighbor <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span> remote<span class="token operator">-</span>as <span class="token number">65001</span>
        neighbor <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span> activate
        redistribute connected
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R2
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
ip vrf A<span class="token operator">-</span>Site1
        rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token operator">!</span>
ip vrf A<span class="token operator">-</span>Site2
        rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
        route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip vrf forwarding A<span class="token operator">-</span>Site1
        ip address <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet1<span class="token operator">/</span><span class="token number">0</span>
        ip vrf forwarding A<span class="token operator">-</span>Site2
        ip address <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
<span class="token operator">!</span>
router bgp <span class="token number">1</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        neighbor ibgp peer<span class="token operator">-</span>group
        neighbor ibgp remote<span class="token operator">-</span>as <span class="token number">1</span>
        neighbor ibgp update<span class="token operator">-</span>source Loopback0
        neighbor ibgp next<span class="token operator">-</span>hop<span class="token operator">-</span>self
        neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> peer<span class="token operator">-</span>group ibgp
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> peer<span class="token operator">-</span>group ibgp
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family vpnv4
        neighbor ibgp send<span class="token operator">-</span>community both
        neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> activate
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> activate
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
        redistribute connected
        neighbor <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.5</span> remote<span class="token operator">-</span>as <span class="token number">65001</span>
        neighbor <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.5</span> activate
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
        redistribute connected
        neighbor <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.6</span> remote<span class="token operator">-</span>as <span class="token number">65002</span>
        neighbor <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.6</span> activate
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R3"><a href="#R3" class="headerlink" title="R3:"></a>R3:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R3
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet1<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>         
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R4"><a href="#R4" class="headerlink" title="R4:"></a>R4:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R4
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
ip vrf A<span class="token operator">-</span>Site3
        rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">3</span>
        route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
        route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip vrf forwarding A<span class="token operator">-</span>Site3
        ip address <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip vrf forwarding A<span class="token operator">-</span>Site3
        ip address <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
interface FastEthernet1<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
<span class="token operator">!</span>
router bgp <span class="token number">1</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        neighbor ibgp peer<span class="token operator">-</span>group
        neighbor ibgp remote<span class="token operator">-</span>as <span class="token number">1</span>
        neighbor ibgp update<span class="token operator">-</span>source Loopback0
        neighbor ibgp next<span class="token operator">-</span>hop<span class="token operator">-</span>self
        neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> peer<span class="token operator">-</span>group ibgp
        neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> peer<span class="token operator">-</span>group ibgp
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family vpnv4
        neighbor ibgp send<span class="token operator">-</span>community both
        neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> activate
        neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> activate
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site3
        neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> remote<span class="token operator">-</span>as <span class="token number">65003</span>
        neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> activate
        neighbor <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.8</span> remote<span class="token operator">-</span>as <span class="token number">65003</span>
        neighbor <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.8</span> activate
        redistribute connected
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R5"><a href="#R5" class="headerlink" title="R5:"></a>R5:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R5
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.5</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
router bgp <span class="token number">65001</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        network <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        neighbor <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
        neighbor <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.2</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R6"><a href="#R6" class="headerlink" title="R6:"></a>R6:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R6
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.6</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
router bgp <span class="token number">65002</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        network <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        neighbor <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.2</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R7"><a href="#R7" class="headerlink" title="R7:"></a>R7:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R7
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
router bgp <span class="token number">65003</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        network <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        neighbor <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> remote<span class="token operator">-</span>as <span class="token number">65003</span>
        neighbor <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> update<span class="token operator">-</span>source Loopback0
        neighbor <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self
        neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R8"><a href="#R8" class="headerlink" title="R8:"></a>R8:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R8
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.8</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
router bgp <span class="token number">65003</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        network <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        neighbor <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> remote<span class="token operator">-</span>as <span class="token number">65003</span>
        neighbor <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> update<span class="token operator">-</span>source Loopback0
        neighbor <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self
        neighbor <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>


<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1：同一VPN的不同站点使用不同的AS号；"><a href="#实验1：同一VPN的不同站点使用不同的AS号；" class="headerlink" title="实验1：同一VPN的不同站点使用不同的AS号；"></a>实验1：同一VPN的不同站点使用不同的AS号；</h2><p>查看R7的BGP汇总表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp summary
BGP router identifier <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token punctuation">,</span> local AS number <span class="token number">65003</span>
BGP table version is <span class="token number">12</span><span class="token punctuation">,</span> main routing table version <span class="token number">12</span>
<span class="token number">5</span> network entries using <span class="token number">680</span> bytes of memory
<span class="token number">5</span> path entries using <span class="token number">280</span> bytes of memory
<span class="token number">4</span><span class="token operator">/</span><span class="token number">4</span> BGP path<span class="token operator">/</span>bestpath attribute entries using <span class="token number">512</span> bytes of memory
<span class="token number">3</span> BGP AS<span class="token operator">-</span>PATH entries using <span class="token number">72</span> bytes of memory
<span class="token number">0</span> BGP route<span class="token operator">-</span>map cache entries using <span class="token number">0</span> bytes of memory
<span class="token number">0</span> BGP filter<span class="token operator">-</span>list cache entries using <span class="token number">0</span> bytes of memory
BGP using <span class="token number">1544</span> total bytes of memory
BGP activity <span class="token number">6</span><span class="token operator">/</span><span class="token number">1</span> prefixes<span class="token punctuation">,</span> <span class="token number">16</span><span class="token operator">/</span><span class="token number">11</span> paths<span class="token punctuation">,</span> scan interval <span class="token number">60</span> secs
Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up<span class="token operator">/</span>Down  State<span class="token operator">/</span>PfxRcd
<span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>         <span class="token number">4</span>        <span class="token number">65003</span>       <span class="token number">0</span>       <span class="token number">0</span>        <span class="token number">1</span>    <span class="token number">0</span>    <span class="token number">0</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">50</span> Idle
<span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>    <span class="token number">4</span>            <span class="token number">1</span>     <span class="token number">107</span>      <span class="token number">87</span>       <span class="token number">12</span>    <span class="token number">0</span>    <span class="token number">0</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">52</span>        <span class="token number">4</span>
<span class="token comment">//注意到邻居R8处于Idle状态；</span></code></pre>

<p>查看R8的BGP汇总表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp summary
BGP router identifier <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> local AS number <span class="token number">65003</span>
BGP table version is <span class="token number">12</span><span class="token punctuation">,</span> main routing table version <span class="token number">12</span>
<span class="token number">5</span> network entries using <span class="token number">680</span> bytes of memory
<span class="token number">5</span> path entries using <span class="token number">280</span> bytes of memory
<span class="token number">4</span><span class="token operator">/</span><span class="token number">4</span> BGP path<span class="token operator">/</span>bestpath attribute entries using <span class="token number">512</span> bytes of memory
<span class="token number">3</span> BGP AS<span class="token operator">-</span>PATH entries using <span class="token number">72</span> bytes of memory
<span class="token number">0</span> BGP route<span class="token operator">-</span>map cache entries using <span class="token number">0</span> bytes of memory
<span class="token number">0</span> BGP filter<span class="token operator">-</span>list cache entries using <span class="token number">0</span> bytes of memory
BGP using <span class="token number">1544</span> total bytes of memory
BGP activity <span class="token number">6</span><span class="token operator">/</span><span class="token number">1</span> prefixes<span class="token punctuation">,</span> <span class="token number">14</span><span class="token operator">/</span><span class="token number">9</span> paths<span class="token punctuation">,</span> scan interval <span class="token number">60</span> secs
Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up<span class="token operator">/</span>Down  State<span class="token operator">/</span>PfxRcd
<span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>         <span class="token number">4</span>        <span class="token number">65003</span>       <span class="token number">0</span>       <span class="token number">0</span>        <span class="token number">1</span>    <span class="token number">0</span>    <span class="token number">0</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">55</span> Idle
<span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>    <span class="token number">4</span>            <span class="token number">1</span>     <span class="token number">101</span>      <span class="token number">92</span>       <span class="token number">12</span>    <span class="token number">0</span>    <span class="token number">0</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">12</span>        <span class="token number">4</span>
<span class="token comment">//注意到邻居R7处于Idle状态；</span></code></pre>

<p>查看R7的路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">25</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">41</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> is directly connected<span class="token punctuation">,</span> Loopback0
B     <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">41</span><span class="token operator">:</span><span class="token number">31</span>
B     <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">41</span><span class="token operator">:</span><span class="token number">06</span>
        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//注意到R7的没有去往BGP邻居R8环回口的路由，所以它们无法建立邻居；</span></code></pre>

<p>查看R8的路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">21</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">21</span>
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> is directly connected<span class="token punctuation">,</span> Loopback0
B     <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">12</span>
B     <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">47</span>
        <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token comment">//注意到R8的没有去往BGP邻居R7环回口的路由，所以它们无法建立邻居；</span></code></pre>

<p>由于R7和R8同属于一个AS，但它们被PE3隔离开了，并且它们之间再没有其他链路可以到达对方，因此，PE3为R7和R8提供到达对方的连通性，但由于EBGP的AS_PATH环路防护机制，<br>导致R7和R8从PE3收到包含自己所在AS的EBGP路由之后，将直接丢弃这些路由，所以R7和R8不会有对方的路由；</p>
<p>配置 <code>allowas-in</code> ，使R7和R8放松对AS_PATH的环路防护检测；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#nei <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> allowas<span class="token operator">-</span>in <span class="token number">2</span></code></pre>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#nei <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span> allowas<span class="token operator">-</span>in <span class="token number">2</span></code></pre>

<p>查看R7的BGP汇总表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp summary
BGP router identifier <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token punctuation">,</span> local AS number <span class="token number">65003</span>
BGP table version is <span class="token number">22</span><span class="token punctuation">,</span> main routing table version <span class="token number">22</span>
<span class="token number">6</span> network entries using <span class="token number">816</span> bytes of memory
<span class="token number">13</span> path entries using <span class="token number">728</span> bytes of memory
<span class="token number">10</span><span class="token operator">/</span><span class="token number">5</span> BGP path<span class="token operator">/</span>bestpath attribute entries using <span class="token number">1280</span> bytes of memory
<span class="token number">4</span> BGP AS<span class="token operator">-</span>PATH entries using <span class="token number">96</span> bytes of memory
<span class="token number">0</span> BGP route<span class="token operator">-</span>map cache entries using <span class="token number">0</span> bytes of memory
<span class="token number">0</span> BGP filter<span class="token operator">-</span>list cache entries using <span class="token number">0</span> bytes of memory
BGP using <span class="token number">2920</span> total bytes of memory
BGP activity <span class="token number">7</span><span class="token operator">/</span><span class="token number">1</span> prefixes<span class="token punctuation">,</span> <span class="token number">31</span><span class="token operator">/</span><span class="token number">18</span> paths<span class="token punctuation">,</span> scan interval <span class="token number">60</span> secs
Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up<span class="token operator">/</span>Down  State<span class="token operator">/</span>PfxRcd
<span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>         <span class="token number">4</span>        <span class="token number">65003</span>       <span class="token number">9</span>      <span class="token number">13</span>       <span class="token number">22</span>    <span class="token number">0</span>    <span class="token number">0</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">54</span>        <span class="token number">6</span>
<span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>    <span class="token number">4</span>            <span class="token number">1</span>     <span class="token number">148</span>     <span class="token number">125</span>       <span class="token number">22</span>    <span class="token number">0</span>    <span class="token number">0</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">39</span>        <span class="token number">6</span></code></pre>

<p>查看R8的BGP汇总表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp summary
BGP router identifier <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> local AS number <span class="token number">65003</span>
BGP table version is <span class="token number">26</span><span class="token punctuation">,</span> main routing table version <span class="token number">26</span>
<span class="token number">6</span> network entries using <span class="token number">816</span> bytes of memory
<span class="token number">13</span> path entries using <span class="token number">728</span> bytes of memory
<span class="token number">10</span><span class="token operator">/</span><span class="token number">5</span> BGP path<span class="token operator">/</span>bestpath attribute entries using <span class="token number">1280</span> bytes of memory
<span class="token number">4</span> BGP AS<span class="token operator">-</span>PATH entries using <span class="token number">96</span> bytes of memory
<span class="token number">0</span> BGP route<span class="token operator">-</span>map cache entries using <span class="token number">0</span> bytes of memory
<span class="token number">0</span> BGP filter<span class="token operator">-</span>list cache entries using <span class="token number">0</span> bytes of memory
BGP using <span class="token number">2920</span> total bytes of memory
BGP activity <span class="token number">7</span><span class="token operator">/</span><span class="token number">1</span> prefixes<span class="token punctuation">,</span> <span class="token number">37</span><span class="token operator">/</span><span class="token number">24</span> paths<span class="token punctuation">,</span> scan interval <span class="token number">60</span> secs
Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up<span class="token operator">/</span>Down  State<span class="token operator">/</span>PfxRcd
<span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>         <span class="token number">4</span>        <span class="token number">65003</span>       <span class="token number">9</span>      <span class="token number">11</span>       <span class="token number">26</span>    <span class="token number">0</span>    <span class="token number">0</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">47</span>        <span class="token number">6</span>
<span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>    <span class="token number">4</span>            <span class="token number">1</span>     <span class="token number">142</span>     <span class="token number">133</span>       <span class="token number">26</span>    <span class="token number">0</span>    <span class="token number">0</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">10</span>        <span class="token number">6</span></code></pre>

<p>从R7 ping R8；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> p <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Success rate is <span class="token number">0</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> p <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> source <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
Packet sent with a source address of <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Success rate is <span class="token number">0</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token comment">//R7无法ping通R8；</span></code></pre>

<p>查看R7的路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">45</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">01</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">41</span>
B     <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">51</span>
B     <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">26</span>
        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span></code></pre>

<p>查看R8的路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">33</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">33</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">03</span>
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> is directly connected<span class="token punctuation">,</span> Loopback0
B     <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">24</span>
B     <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">59</span>
        <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span></code></pre>

<p>查看R7的BGP表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp
BGP table version is <span class="token number">114</span><span class="token punctuation">,</span> local router ID is <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
Network          Next Hop            Metric LocPrf Weight Path
<span class="token operator">*</span> i5<span class="token punctuation">.</span><span class="token number">5.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>             <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65001</span> i
<span class="token operator">*</span><span class="token operator">></span>                  <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65001</span> i
<span class="token operator">*</span> i6<span class="token punctuation">.</span><span class="token number">6.6</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>             <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65002</span> i
<span class="token operator">*</span><span class="token operator">></span>                  <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65002</span> i
<span class="token operator">*</span> i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>             <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65003</span> i<span class="token comment">//可以看到R7的直连环回口却又通过PE被通告了回来，有环路存在；</span>
<span class="token operator">*</span>                   <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65003</span> i<span class="token comment">//可以看到R7的直连环回口却又通过PE被通告了回来，有环路存在；</span>
<span class="token operator">*</span><span class="token operator">></span>                  <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> i
<span class="token operator">*</span><span class="token operator">></span>i8<span class="token punctuation">.</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> i
<span class="token operator">*</span>                   <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65003</span> i
<span class="token operator">*</span> i192<span class="token punctuation">.</span><span class="token number">168.25</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>             <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>                  <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token operator">*</span> i192<span class="token punctuation">.</span><span class="token number">168.26</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>             <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>                  <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span></code></pre>

<p>查看R8的BGP表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp
BGP table version is <span class="token number">116</span><span class="token punctuation">,</span> local router ID is <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
Network          Next Hop            Metric LocPrf Weight Path
<span class="token operator">*</span> i5<span class="token punctuation">.</span><span class="token number">5.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>             <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65001</span> i
<span class="token operator">*</span><span class="token operator">></span>                  <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65001</span> i
<span class="token operator">*</span> i6<span class="token punctuation">.</span><span class="token number">6.6</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>             <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65002</span> i
<span class="token operator">*</span><span class="token operator">></span>                  <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65002</span> i
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> i
<span class="token operator">*</span>                   <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65003</span> i
<span class="token operator">*</span> i8<span class="token punctuation">.</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>             <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65003</span> i<span class="token comment">//可以看到R8的直连环回口却又通过PE被通告了回来，有环路存在；</span>
<span class="token operator">*</span>                   <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65003</span> i<span class="token comment">//可以看到R8的直连环回口却又通过PE被通告了回来，有环路存在；</span>
<span class="token operator">*</span><span class="token operator">></span>                  <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> i
<span class="token operator">*</span> i192<span class="token punctuation">.</span><span class="token number">168.25</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>             <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>                  <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token operator">*</span> i192<span class="token punctuation">.</span><span class="token number">168.26</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>             <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>                  <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span></code></pre>
<p>可以看到，现在虽然将R7和R8配置为iBGP邻居，并且由于MPLS VPN的存在R7和R8通过MPLS VPN将iBGP路由发送给对方，而由PE通告的eBGP路由具有更长的AS_PATH，所以R7和R8会优选自己通告的BGP路由。</p>
<p>但是实际上它们之间的连通性是由同PE的eBGP邻居提供的，如果不走PE，就无法到达对方！</p>
<p><strong>解决方案是，不让R7和R8建立iBGP邻居；</strong></p>
<p>删除R7的iBGP邻居配置；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no nei <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> remote<span class="token operator">-</span>as <span class="token number">65003</span></code></pre>

<p>删除R8的iBGP邻居配置；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no nei <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> remote<span class="token operator">-</span>as <span class="token number">65003</span></code></pre>

<p>查看R7的路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">49</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">05</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span>
B     <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">55</span>
B     <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">30</span>
        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span></code></pre>

<p>查看R8的路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">23</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">23</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">34</span>
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> is directly connected<span class="token punctuation">,</span> Loopback0
B     <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">14</span>
B     <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">49</span>
        <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span></code></pre>

<p>查看R7的BGP表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp                                                   
BGP table version is <span class="token number">147</span><span class="token punctuation">,</span> local router ID is <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
Network          Next Hop            Metric LocPrf Weight Path
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65001</span> i
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65002</span> i
<span class="token operator">*</span>  <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65003</span> i
<span class="token operator">*</span><span class="token operator">></span>                  <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> i
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65003</span> i
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token comment">//虽然现在把下一跳解决了，但是环路依然存在；</span></code></pre>

<p>查看R8的BGP表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp 
BGP table version is <span class="token number">147</span><span class="token punctuation">,</span> local router ID is <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
Network          Next Hop            Metric LocPrf Weight Path
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65001</span> i
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65002</span> i
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65003</span> i
<span class="token operator">*</span>  <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">65003</span> i
<span class="token operator">*</span><span class="token operator">></span>                  <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> i
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.4</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token comment">//虽然现在把下一跳解决了，但是环路依然存在；</span></code></pre>

<p>在R4上配置：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#route<span class="token operator">-</span>map SOO1<span class="token operator">:</span><span class="token number">1</span> permit <span class="token number">10</span>    
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#set extcommunity soo <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>      
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#exit
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#route<span class="token operator">-</span>map SOO1<span class="token operator">:</span><span class="token number">2</span> permit <span class="token number">10</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#set extcommunity soo <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>  
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#exit

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#add ipv4 vrf A<span class="token operator">-</span>Site3
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> route<span class="token operator">-</span>map SOO1<span class="token operator">:</span><span class="token number">1</span> in
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.8</span> route<span class="token operator">-</span>map SOO1<span class="token operator">:</span><span class="token number">2</span> in</code></pre>

<pre class="language-c" data-language="c"><code class="language-c">R7#ping <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Success rate is <span class="token number">0</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span>

R7#ping <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> source l0
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
Packet sent with a source address of <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> 
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">44</span><span class="token operator">/</span><span class="token number">64</span><span class="token operator">/</span><span class="token number">88</span> ms
<span class="token comment">//指定源后，成功ping通！</span>
<span class="token comment">//发现是之前疏忽大意了，忘了在预配中将R4的直连路由重分发进MP-BGP了；</span></code></pre>

<p>检查配置，R4和R1上将直连路由重分发进MP-BGP；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#add ipv4 vrf A<span class="token operator">-</span>Site3
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected</code></pre>

<p>从R7上ping其他站点的路由器；</p>
<pre class="language-c" data-language="c"><code class="language-c">R7#ping <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">36</span><span class="token operator">/</span><span class="token number">84</span><span class="token operator">/</span><span class="token number">120</span> ms
R7#ping <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">88</span><span class="token operator">/</span><span class="token number">121</span><span class="token operator">/</span><span class="token number">144</span> ms
R7#ping <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span>  
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">80</span><span class="token operator">/</span><span class="token number">105</span><span class="token operator">/</span><span class="token number">140</span> ms</code></pre>

<p>查看R5的路由表，发现R5依然没有R6的路由；</p>
<pre class="language-c" data-language="c"><code class="language-c">R5#sh ip route 
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">04</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">22</span>
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">04</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">37</span>
        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.25</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
B     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01</span>
B     <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01</span></code></pre>

<p>查看R6的路由表，发现R6同样没有R5的路由；</p>
<pre class="language-c" data-language="c"><code class="language-c">R6#sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">04</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">46</span>
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">04</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">46</span>
        <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
B     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">07</span>
B     <span class="token number">192.168</span><span class="token number">.48</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.26</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">07</span></code></pre>

<p>由于需求要求Spoke和Spoke间的通信需要先绕经Hub站点，所以R5需要从站点3学到关于R6的路由，R6也需要从站点3学到关于R5的路由；但当路由从R4通告给站点3的时候，路由的AS_PATH携带了AS1，当被站点3通告回R4的时候，R4就会丢弃AS_PATH中携带了和自己所在AS号相同的的路由。</p>
<h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><p>PE路由器简单地比较CE路由器ASN和 <code>as-path</code> 中的ASN，如果匹配的话，所有在 <code>as-path</code> 中的该ASN都会被服务提供商的ASN所代替。<br>这样一来，远程CE就会接受这些路由了，因为它们在这些BGP路由的 <code>as-path</code> 中看不到自己的ASN了！但这样一来，对于可能存在环路的保护机制，以及非最优路由的 <code>as-path</code> 检查机制就失效了。因此，在使用 <code>as-override</code> 功能进行ASN覆盖的时候，明智的做法是为BGP实施SOO特性。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_12/" class="post-title-link" itemprop="url">MPLS 实验12：SOO and EIGRP on Backdoor Link</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-19 23:49:51" itemprop="dateCreated datePublished" datetime="2014-03-19T23:49:51+08:00">2014-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>


<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h1><p><img src="/2014/MPLS_Lab_12/topo.png"></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R1
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
ip vrf A<span class="token operator">-</span>Site1
        rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip vrf forwarding A<span class="token operator">-</span>Site1
        ip address <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
<span class="token operator">!</span>
router eigrp <span class="token number">1</span>
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 autonomous<span class="token operator">-</span>system <span class="token number">1</span>
        redistribute bgp <span class="token number">1</span> metric <span class="token number">10000</span> <span class="token number">100</span> <span class="token number">255</span> <span class="token number">1</span> <span class="token number">1500</span>
        network <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.0</span>
        eigrp router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token operator">!</span>
router bgp <span class="token number">1</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
        neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> update<span class="token operator">-</span>source Loopback0
        neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family vpnv4
        neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> activate
        neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> send<span class="token operator">-</span>community both
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
        network <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        redistribute connected
        redistribute eigrp <span class="token number">1</span>
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R2
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
ip vrf A<span class="token operator">-</span>Site2
        rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
        route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip vrf forwarding A<span class="token operator">-</span>Site2
        ip address <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
router eigrp <span class="token number">1</span>
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2 autonomous<span class="token operator">-</span>system <span class="token number">1</span>
        redistribute bgp <span class="token number">1</span> metric <span class="token number">10000</span> <span class="token number">100</span> <span class="token number">255</span> <span class="token number">1</span> <span class="token number">1500</span>
        network <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.0</span>
        eigrp router<span class="token operator">-</span>id <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
<span class="token operator">!</span>
router bgp <span class="token number">1</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
        neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> update<span class="token operator">-</span>source Loopback0
        neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family vpnv4
        neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> activate
        neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> send<span class="token operator">-</span>community both
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
        network <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        redistribute connected
        redistribute eigrp <span class="token number">1</span>
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R3"><a href="#R3" class="headerlink" title="R3:"></a>R3:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R3
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
interface Serial1<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        serial restart<span class="token operator">-</span>delay <span class="token number">0</span>
        clock rate <span class="token number">64000</span>
        no shutdown
<span class="token operator">!</span>
router eigrp <span class="token number">1</span>
        network <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
        network <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.0</span>
        network <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span>
        eigrp router<span class="token operator">-</span>id <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R4"><a href="#R4" class="headerlink" title="R4:"></a>R4:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R4
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
interface Serial1<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        serial restart<span class="token operator">-</span>delay <span class="token number">0</span>
        no shutdown
<span class="token operator">!</span>
router eigrp <span class="token number">1</span>
        network <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
        network <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.0</span>
        network <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1："><a href="#实验1：" class="headerlink" title="实验1："></a>实验1：</h2><p>查看R1的IP BGP VNPv4路由表关于路由4.4.4.4的明细；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp vpnv4 all <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
BGP routing table entry <span class="token keyword">for</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> version <span class="token number">79</span>
Paths<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> available<span class="token punctuation">,</span> best #<span class="token number">1</span><span class="token punctuation">,</span> table A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
Not advertised to any peer
Local<span class="token punctuation">,</span> imported path from <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span>
<span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">(</span>metric <span class="token number">2</span><span class="token punctuation">)</span> from <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">(</span><span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token punctuation">)</span>
        Origin incomplete<span class="token punctuation">,</span> metric <span class="token number">156160</span><span class="token punctuation">,</span> localpref <span class="token number">100</span><span class="token punctuation">,</span> valid<span class="token punctuation">,</span> internal<span class="token punctuation">,</span> best
        Extended Community<span class="token operator">:</span> RT<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> Cost<span class="token operator">:</span>pre<span class="token operator">-</span>bestpath<span class="token operator">:</span><span class="token number">128</span><span class="token operator">:</span><span class="token number">156160</span> <span class="token number">0x8800</span><span class="token operator">:</span><span class="token number">32768</span><span class="token operator">:</span><span class="token number">0</span> 
        <span class="token number">0x8801</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">130560</span> <span class="token number">0x8802</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">25600</span> <span class="token number">0x8803</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">1500</span> <span class="token number">0x8806</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">67372036</span>
        mpls labels in<span class="token operator">/</span>out nolabel<span class="token operator">/</span><span class="token number">22</span>
BGP routing table entry <span class="token keyword">for</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> version <span class="token number">77</span>
Paths<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> available<span class="token punctuation">,</span> best #<span class="token number">1</span><span class="token punctuation">,</span> no table<span class="token punctuation">)</span>
Not advertised to any peer
Local
<span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">(</span>metric <span class="token number">2</span><span class="token punctuation">)</span> from <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">(</span><span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token punctuation">)</span>
        Origin incomplete<span class="token punctuation">,</span> metric <span class="token number">156160</span><span class="token punctuation">,</span> localpref <span class="token number">100</span><span class="token punctuation">,</span> valid<span class="token punctuation">,</span> internal<span class="token punctuation">,</span> best
        Extended Community<span class="token operator">:</span> RT<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> Cost<span class="token operator">:</span>pre<span class="token operator">-</span>bestpath<span class="token operator">:</span><span class="token number">128</span><span class="token operator">:</span><span class="token number">156160</span> <span class="token number">0x8800</span><span class="token operator">:</span><span class="token number">32768</span><span class="token operator">:</span><span class="token number">0</span> 
        <span class="token number">0x8801</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">130560</span> <span class="token number">0x8802</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">25600</span> <span class="token number">0x8803</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">1500</span> <span class="token number">0x8806</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">67372036</span>
        mpls labels in<span class="token operator">/</span>out nolabel<span class="token operator">/</span><span class="token number">22</span>
<span class="token comment">//VPNv4路由默认不携带SOO；</span></code></pre>

<p>在PE上，创建路由映射表SOO_LAB，对所有VPNv4路由设置MP-BGP拓展团体属性；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#route<span class="token operator">-</span>map SOO_LAB permit <span class="token number">10</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#set extcommunity <span class="token operator">?</span>
cost  Cost extended community
rt    Route Target extended community
soo   Site<span class="token operator">-</span>of<span class="token operator">-</span>Origin extended community

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#set extcommunity soo <span class="token operator">?</span>
ASN<span class="token operator">:</span>nn or IP<span class="token operator">-</span>address<span class="token operator">:</span>nn  VPN extended community

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#set extcommunity soo <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#exit

<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#route<span class="token operator">-</span>map SOO_LAB permit <span class="token number">10</span> 
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#set extcommunity soo <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#exit</code></pre>
<p>在PE的vrf接口上应用设置SOO的<code>route-map</code>；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf sitemap <span class="token operator">?</span>
WORD  Name of the route<span class="token operator">-</span>map
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf sitemap SOO_LAB


<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf sitemap SOO_LAB</code></pre>
<p>在连接到后门链路的CE或C路由器上为EIGRP配置SOO；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#route<span class="token operator">-</span>map SOO_LAB permit <span class="token number">10</span> 
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#set extcommunity soo <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>

<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf sitemap SOO_LAB

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#route<span class="token operator">-</span>map SOO_LAB permit <span class="token number">10</span> 
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#set extcommunity soo <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf sitemap SOO_LAB</code></pre>
<p>查看R1的IP BGP VNPv4路由表关于路由4.4.4.4的明细；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp vpnv4 all <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>
BGP routing table entry <span class="token keyword">for</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> version <span class="token number">96</span>
Paths<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> available<span class="token punctuation">,</span> best #<span class="token number">1</span><span class="token punctuation">,</span> no table<span class="token punctuation">)</span>
Not advertised to any peer
Local
<span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token punctuation">(</span>metric <span class="token number">2</span><span class="token punctuation">)</span> from <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token punctuation">(</span><span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">)</span>
        Origin incomplete<span class="token punctuation">,</span> metric <span class="token number">156160</span><span class="token punctuation">,</span> localpref <span class="token number">100</span><span class="token punctuation">,</span> valid<span class="token punctuation">,</span> internal<span class="token punctuation">,</span> best
        Extended Community<span class="token operator">:</span> SoO<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> RT<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> Cost<span class="token operator">:</span>pre<span class="token operator">-</span>bestpath<span class="token operator">:</span><span class="token number">128</span><span class="token operator">:</span><span class="token number">156160</span> 
        <span class="token number">0x8800</span><span class="token operator">:</span><span class="token number">32768</span><span class="token operator">:</span><span class="token number">0</span> <span class="token number">0x8801</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">130560</span> <span class="token number">0x8802</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">25600</span> <span class="token number">0x8803</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">1500</span> 
        <span class="token number">0x8806</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">50529027</span>
        mpls labels in<span class="token operator">/</span>out nolabel<span class="token operator">/</span><span class="token number">24</span>
BGP routing table entry <span class="token keyword">for</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> version <span class="token number">99</span>
Paths<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> available<span class="token punctuation">,</span> best #<span class="token number">1</span><span class="token punctuation">,</span> table A<span class="token operator">-</span>Site2<span class="token punctuation">)</span>
Not advertised to any peer
Local<span class="token punctuation">,</span> imported path from <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span>
<span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token punctuation">(</span>metric <span class="token number">2</span><span class="token punctuation">)</span> from <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token punctuation">(</span><span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">)</span>
        Origin incomplete<span class="token punctuation">,</span> metric <span class="token number">156160</span><span class="token punctuation">,</span> localpref <span class="token number">100</span><span class="token punctuation">,</span> valid<span class="token punctuation">,</span> internal<span class="token punctuation">,</span> best
        Extended Community<span class="token operator">:</span> SoO<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> RT<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> Cost<span class="token operator">:</span>pre<span class="token operator">-</span>bestpath<span class="token operator">:</span><span class="token number">128</span><span class="token operator">:</span><span class="token number">156160</span> 
        <span class="token number">0x8800</span><span class="token operator">:</span><span class="token number">32768</span><span class="token operator">:</span><span class="token number">0</span> <span class="token number">0x8801</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">130560</span> <span class="token number">0x8802</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">25600</span> <span class="token number">0x8803</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">1500</span> 
        <span class="token number">0x8806</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">50529027</span>
        mpls labels in<span class="token operator">/</span>out nolabel<span class="token operator">/</span><span class="token number">24</span></code></pre>

<p>查看R3的EIGRP 拓扑表关于4.4.4.4&#x2F;32的明细；</p>
<pre class="language-c" data-language="c"><code class="language-c">R3#sh ip ei topology <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span>
EIGRP<span class="token operator">-</span>IPv4 Topology Entry <span class="token keyword">for</span> <span class="token function">AS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span>
State is Passive<span class="token punctuation">,</span> Query origin flag is <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token function">Successor</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> FD is <span class="token number">158720</span>
Descriptor Blocks<span class="token operator">:</span>
<span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span> <span class="token punctuation">(</span>FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> from <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span><span class="token punctuation">,</span> Send flag is <span class="token number">0x0</span>
        Composite metric <span class="token function">is</span> <span class="token punctuation">(</span><span class="token number">158720</span><span class="token operator">/</span><span class="token number">156160</span><span class="token punctuation">)</span><span class="token punctuation">,</span> route is Internal
        Vector metric<span class="token operator">:</span>
        Minimum bandwidth is <span class="token number">100000</span> Kbit
        Total delay is <span class="token number">5200</span> microseconds
        Reliability is <span class="token number">255</span><span class="token operator">/</span><span class="token number">255</span>
        Load is <span class="token number">1</span><span class="token operator">/</span><span class="token number">255</span>
        Minimum MTU is <span class="token number">1500</span>
        Hop count is <span class="token number">2</span>
        Originating router is <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
        Extended Community<span class="token operator">:</span> SoO<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span> <span class="token punctuation">(</span>Serial1<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> from <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span><span class="token punctuation">,</span> Send flag is <span class="token number">0x0</span>
        Composite metric <span class="token function">is</span> <span class="token punctuation">(</span><span class="token number">2297856</span><span class="token operator">/</span><span class="token number">128256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> route is Internal
        Vector metric<span class="token operator">:</span>
        Minimum bandwidth is <span class="token number">1544</span> Kbit
        Total delay is <span class="token number">25000</span> microseconds
        Reliability is <span class="token number">255</span><span class="token operator">/</span><span class="token number">255</span>
        Load is <span class="token number">1</span><span class="token operator">/</span><span class="token number">255</span>
        Minimum MTU is <span class="token number">1500</span>
        Hop count is <span class="token number">1</span>
        Originating router is <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
<span class="token comment">//R3上来自于R4的关于4.4.4.4/32的路由携带了SOO1:2；</span></code></pre>

<p>查看R4的EIGRP 拓扑表关于3.3.3.3&#x2F;32的明细；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip ei to <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span>
EIGRP<span class="token operator">-</span>IPv4 Topology Entry <span class="token keyword">for</span> <span class="token function">AS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span>
State is Passive<span class="token punctuation">,</span> Query origin flag is <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token function">Successor</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> FD is <span class="token number">158720</span>
Descriptor Blocks<span class="token operator">:</span>
<span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span> <span class="token punctuation">(</span>FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> from <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span><span class="token punctuation">,</span> Send flag is <span class="token number">0x0</span>
        Composite metric <span class="token function">is</span> <span class="token punctuation">(</span><span class="token number">158720</span><span class="token operator">/</span><span class="token number">156160</span><span class="token punctuation">)</span><span class="token punctuation">,</span> route is Internal
        Vector metric<span class="token operator">:</span>
        Minimum bandwidth is <span class="token number">100000</span> Kbit
        Total delay is <span class="token number">5200</span> microseconds
        Reliability is <span class="token number">255</span><span class="token operator">/</span><span class="token number">255</span>
        Load is <span class="token number">1</span><span class="token operator">/</span><span class="token number">255</span>
        Minimum MTU is <span class="token number">1500</span>
        Hop count is <span class="token number">2</span>
        Originating router is <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>
        Extended Community<span class="token operator">:</span> SoO<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span> <span class="token punctuation">(</span>Serial1<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> from <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span><span class="token punctuation">,</span> Send flag is <span class="token number">0x0</span>
        Composite metric <span class="token function">is</span> <span class="token punctuation">(</span><span class="token number">2297856</span><span class="token operator">/</span><span class="token number">128256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> route is Internal
        Vector metric<span class="token operator">:</span>
        Minimum bandwidth is <span class="token number">1544</span> Kbit
        Total delay is <span class="token number">25000</span> microseconds
        Reliability is <span class="token number">255</span><span class="token operator">/</span><span class="token number">255</span>
        Load is <span class="token number">1</span><span class="token operator">/</span><span class="token number">255</span>
        Minimum MTU is <span class="token number">1500</span>
        Hop count is <span class="token number">1</span>
        Originating router is <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>
        <span class="token comment">//R4上来自于R3的关于3.3.3.3/32的路由携带了SOO1:1；</span></code></pre>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_11/" class="post-title-link" itemprop="url">MPLS 实验11：MPLS VPN running eBGP on the PE-CE link</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-19 20:39:51" itemprop="dateCreated datePublished" datetime="2014-03-19T20:39:51+08:00">2014-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>


<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="GNS3实验拓扑文件："><a href="#GNS3实验拓扑文件：" class="headerlink" title="GNS3实验拓扑文件："></a>GNS3实验拓扑文件：</h1><p><a href="topology.net">拓扑文件</a></p>
<h1 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h1><p><img src="/2014/MPLS_Lab_11/topo.png"></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R1
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shut
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shut
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token operator">!</span>         
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R2
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R3"><a href="#R3" class="headerlink" title="R3:"></a>R3:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R3
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R4"><a href="#R4" class="headerlink" title="R4:"></a>R4:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R4
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R5"><a href="#R5" class="headerlink" title="R5:"></a>R5:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R5
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span>
<span class="token operator">!</span>
router bgp <span class="token number">65001</span>
        bgp router<span class="token operator">-</span>id <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        network <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        neighbor <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R7"><a href="#R7" class="headerlink" title="R7:"></a>R7:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R7
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>
<span class="token operator">!</span>
router bgp <span class="token number">65002</span>
        bgp router<span class="token operator">-</span>id <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        network <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>


<h1 id="MPLS-VPN配置步骤："><a href="#MPLS-VPN配置步骤：" class="headerlink" title="MPLS VPN配置步骤："></a>MPLS VPN配置步骤：</h1><ol>
<li>创建VRF（VRF名本地有效）：<ul>
<li>指定RD（提供全局唯一的私网单播地址）；</li>
<li>指定RT的导出（导出：把重分发进MP-BGP的VPNv4路由打上MP-BGP扩展团体属性RT）和导入（导入：把MP-BGP里的VPNv4路由进行RT的匹配，匹配成功的VPNv4路由将放进相应的VRF）；</li>
<li>将与CE相连的PE接口关联特定VRF；</li>
</ul>
</li>
<li>配置MP-BGP：<ul>
<li>配置建立PE之间的IBGP邻居关系；</li>
<li>启用VPNv4地址族（AF），并激活与其他PE设备的邻居关系；</li>
</ul>
</li>
<li>配置PE-CE路由；<ul>
<li>配置IGP，并启用IGP的地址族（AF）；</li>
<li>配置启用MP-BGP IPv4 VRF地址族，然后激活与其他PE路由器的MP-BGP IPv4 VRF邻居关系；</li>
</ul>
</li>
</ol>
<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1：同一VPN的不同站点使用不同的AS号；"><a href="#实验1：同一VPN的不同站点使用不同的AS号；" class="headerlink" title="实验1：同一VPN的不同站点使用不同的AS号；"></a>实验1：同一VPN的不同站点使用不同的AS号；</h2><h3 id="在PE上创建VRF；"><a href="#在PE上创建VRF；" class="headerlink" title="在PE上创建VRF；"></a>在PE上创建VRF；</h3><p>在PE1（R1）上创建VRF，并命名为A-Site1，表示该VRF为VPN A的站点1服务；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site1   </code></pre>

<p>指定RD，为1:1，如果按照AS：num命名法，以下RD表示AS1中的第2个VRF；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
```            

指定RT的导入和导出，这里我将RT指定为导入和导出<span class="token number">1</span>：<span class="token number">1</span>；
```c
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target <span class="token operator">?</span>        
        ASN<span class="token operator">:</span>nn or IP<span class="token operator">-</span>address<span class="token operator">:</span>nn  Target VPN Extended Community
        both                     Both import and export Target<span class="token operator">-</span>VPN community
        export                   Export Target<span class="token operator">-</span>VPN community
        import                   Import Target<span class="token operator">-</span>VPN community
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target both <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>

<p>将PE1（R1）上与CE相连的PE接口F0&#x2F;1关联到VRF A-Site1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site1
<span class="token operator">%</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span> IPv4 disabled and <span class="token function">address</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span> removed due to enabling VRF A<span class="token operator">-</span>Site1
        <span class="token comment">//切记先将接口关联VRF，然后再配置IP地址；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span></code></pre>
<p>在PE2（R4）上创建VRF，并命名为A-Site2，表示该VRF为VPN A的站点2服务；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site2</code></pre>

<p>指定RD，为1:2，如果按照AS：num命名法，以下RD表示AS1中的第2个VRF；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span></code></pre>

<p>指定RT的导入和导出，这里我将RT指定为导入和导出1：1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target both <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>
<p>因为PE1导出的RT为1:1，PE2导入的RT正是PE1的导出RT1:1；所以PE1（R1）的RT导出和PE2（R4）的RT导入能够匹配成功，R4能够学到R1导入到MP-BGP中的VPNv4路由；又因为PE2导出的RT为1:1，PE1导入的RT也正好是PE2的导出RT1:1；所以PE2（R4）的RT导出和PE1（R1）的RT导入能够匹配成对，R1能够学到R4导入到MP-BGP中的VPNv4路由</p>
<p>将PE2（R4）上与CE相连的PE接口F0&#x2F;1关联到VRF A-Site2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site2
<span class="token operator">%</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span> IPv4 disabled and <span class="token function">address</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span> removed due to enabling VRF A<span class="token operator">-</span>Site2
        <span class="token comment">//切记先将接口关联VRF，然后再配置IP地址；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span></code></pre>
<h3 id="配置MP-BGP；"><a href="#配置MP-BGP；" class="headerlink" title="配置MP-BGP；"></a>配置MP-BGP；</h3><p>在PE1（R1）上配置MP-BGP，使之与其他PE建立IBGP关系，在此实验中只有PE1和PE2两台PE设备；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no syn
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#bgp router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> update<span class="token operator">-</span>source l0
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self</code></pre>

<p>启用PE1（R1）的VPNv4地址族，并激活与IBGP邻居PE2（R4）的MP-BGP VPNv4邻居关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family vpnv4
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> activate
<span class="token comment">//激活与IBGP邻居R4的VPNv4关系；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community <span class="token operator">?</span>
        both      Send Standard and Extended Community attributes
        extended  Send Extended Community attribute
        standard  Send Standard Community attribute
        <span class="token operator">&lt;</span>cr<span class="token operator">></span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community both
<span class="token comment">//由于BGP团体属性为可选传递属性，所以必须手动指定R1向IBGP邻居R4发送拓展团体属性和标准团体属性；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token comment">//退出AF配置模式；</span></code></pre>
<p>在PE2（R4）上配置MP-BGP，使之与其他PE建立IBGP关系，</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no syn
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#bgp router<span class="token operator">-</span>id <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> update<span class="token operator">-</span>source l0
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self</code></pre>

<p>启用PE2（R4）的VPNv4地址族，并激活与IBGP邻居PE1（R1）的MP-BGP VPNv4邻居关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family vpnv4
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> activate
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> send<span class="token operator">-</span>community both</code></pre>
<h3 id="配置PE-CE路由；"><a href="#配置PE-CE路由；" class="headerlink" title="配置PE-CE路由；"></a>配置PE-CE路由；</h3><p>配置PE1（R1）的MP-BGP IPv4 VRF地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span> remote<span class="token operator">-</span>as <span class="token number">65001</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span> activate 
<span class="token comment">//激活与IBGP邻居R4的VPNv4关系；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected
<span class="token comment">//如果用户在CE路由器上ping远程网络的另一个VPN站点中的CE或C路由器，</span>
<span class="token comment">//为了使其在没有指定其源地址情况下（即默认使用CE路由器出站接口IP地址），Echo Reply包能够有路由并正常返回,</span>
<span class="token comment">//将PE路由器的直连路由重分布进MP-BGP的IPv4 VRF AF中；</span></code></pre>

<p>配置PE2（R4）的MP-BGP IPv4 VRF地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> remote<span class="token operator">-</span>as <span class="token number">65002</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> activate
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family</code></pre>


<h3 id="验证与调试"><a href="#验证与调试" class="headerlink" title="验证与调试:"></a>验证与调试:</h3><p>在VPN A站点1的CE路由器R5上ping远程VPN A站点2的CE路由器R7；</p>
<pre class="language-c" data-language="c"><code class="language-c">R5#ping <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">100</span><span class="token operator">/</span><span class="token number">146</span><span class="token operator">/</span><span class="token number">208</span> ms
<span class="token comment">//成功！</span></code></pre>

<p>查看R1的IP BGP VPNv4路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp vpnv4 all
BGP table version is <span class="token number">34</span><span class="token punctuation">,</span> local router ID is <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
        Network          Next Hop            Metric LocPrf Weight Path
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> <span class="token punctuation">(</span><span class="token keyword">default</span> <span class="token keyword">for</span> vrf A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>             <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">65001</span> i
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token number">65002</span> i
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>     <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.47</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token number">65002</span> i
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.47</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span></code></pre>

<p>查看R1的vrf路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route vrf A<span class="token operator">-</span>Site1
Routing Table<span class="token operator">:</span> A<span class="token operator">-</span>Site1
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">25</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">41</span><span class="token operator">:</span><span class="token number">20</span>
        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
B     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">38</span><span class="token operator">:</span><span class="token number">35</span></code></pre>

<p>查看R5的IP路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R5</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">34</span>
        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
B     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">04</span>
        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span></code></pre>

<p>查看R5的BGP表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R5</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp
BGP table version is <span class="token number">18</span><span class="token punctuation">,</span> local router ID is <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
        Network          Next Hop            Metric LocPrf Weight  Path
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span>                             i
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span>                           <span class="token number">0</span>              <span class="token number">1</span> <span class="token number">65002</span> i
r<span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span>             <span class="token number">0</span>             <span class="token number">0</span>           <span class="token number">1</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span>                           <span class="token number">0</span>            <span class="token number">1</span> <span class="token operator">?</span>
<span class="token comment">//可以看到前缀7.7.7.7/32的AS_PATH属性中看到起源AS65002；</span></code></pre>
<h2 id="实验2：同一VPN的不同站点使用相同的AS号（使用as-override）；"><a href="#实验2：同一VPN的不同站点使用相同的AS号（使用as-override）；" class="headerlink" title="实验2：同一VPN的不同站点使用相同的AS号（使用as-override）；"></a>实验2：同一VPN的不同站点使用相同的AS号（使用as-override）；</h2><p>修改R7上BGP AS号为65001，使之与站点1的R5的BGP AS号相同；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#no router bgp <span class="token number">65002</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">65001</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#bgp router<span class="token operator">-</span>id <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#exit</code></pre>

<p>修改PE2（R4）的PE-CE路由配置，将MP-BGP IPv4 VRF A-Site2的EBGP邻居配置进行修改；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>f ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#no neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> remote<span class="token operator">-</span>as <span class="token number">65002</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> remote<span class="token operator">-</span>as <span class="token number">65001</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> activate</code></pre>

<p>验证：查看R5的IP路由表；</p>
<pre class="language-none"><code class="language-none">R5(config)#do sh ip route
Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP
        D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area 
        N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
        E1 - OSPF external type 1, E2 - OSPF external type 2
        i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
        ia - IS-IS inter area, * - candidate default, U - per-user static route
        o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP
        + - replicated route, % - next hop override
Gateway of last resort is not set
        5.0.0.0&#x2F;32 is subnetted, 1 subnets
C        5.5.5.5 is directly connected, Loopback0
        192.168.15.0&#x2F;24 is variably subnetted, 2 subnets, 2 masks
C        192.168.15.0&#x2F;24 is directly connected, FastEthernet0&#x2F;1
L        192.168.15.5&#x2F;32 is directly connected, FastEthernet0&#x2F;1
B     192.168.47.0&#x2F;24 [20&#x2F;0] via 192.168.15.1, 00:57:01
        192.168.56.0&#x2F;24 is variably subnetted, 2 subnets, 2 masks
C        192.168.56.0&#x2F;24 is directly connected, FastEthernet0&#x2F;0
L        192.168.56.5&#x2F;32 is directly connected, FastEthernet0&#x2F;0
&#x2F;&#x2F;没有发现关于前缀7.7.7.7&#x2F;32的路由；</code></pre>

<p>验证：查看R5的BGP表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R5</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp    
BGP table version is <span class="token number">19</span><span class="token punctuation">,</span> local router ID is <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
Network          Next Hop            Metric LocPrf Weight Path
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> i
r<span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span>             <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token comment">//也没有发现关于前缀7.7.7.7/32的路由；</span>
<span class="token comment">//因为EBGP防环机制，当R5收到来自PE1的BGP路由后，由于前缀7.7.7.7/32的BGP路由中AS_PATH属性有和自己AS相同的65001，</span>
<span class="token comment">//所以将此路由丢弃了；</span></code></pre>

<p>在PE路由器上，针对各自直连到VRF接口的CE路由器EBGP邻居配置<code>as-override</code>；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span> as<span class="token operator">-</span>override

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> as<span class="token operator">-</span>override</code></pre>

<p>查看R5的BGP表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R5</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp
BGP table version is <span class="token number">20</span><span class="token punctuation">,</span> local router ID is <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
Network          Next Hop            Metric LocPrf Weight Path
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> i
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> i
r<span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span>             <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span>                           <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span></code></pre>

<p>查看R7的BGP表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp
BGP table version is <span class="token number">5</span><span class="token punctuation">,</span> local router ID is <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
Network          Next Hop            Metric LocPrf Weight Path
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                           <span class="token number">0</span>             <span class="token number">1</span> <span class="token number">1</span> i
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span>                   i
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>                                      <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span>
r<span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>             <span class="token number">0</span>                       <span class="token number">0</span> <span class="token number">1</span> <span class="token operator">?</span></code></pre>
<h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><p>PE路由器简单地比较CE路由器ASN和as-path中的ASN，如果匹配的话，所有在as-path中的该ASN都会被服务提供商的ASN所代替。</p>
<p>这样一来，远程CE就会接受这些路由了，因为它们在这些BGP路由的as-path中看不到自己的ASN了！但这样一来，对于可能存在环路的保护机制，以及非最优路由的as-path检查机制就失效了。因此，在使用as-override功能进行ASN覆盖的时候，明智的做法是为BGP实施SOO特性。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_10/" class="post-title-link" itemprop="url">MPLS 实验10：OSPF Loop Prevention in MPLS VPN</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-19 20:29:51" itemprop="dateCreated datePublished" datetime="2014-03-19T20:29:51+08:00">2014-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>


<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="GNS3实验拓扑文件："><a href="#GNS3实验拓扑文件：" class="headerlink" title="GNS3实验拓扑文件："></a>GNS3实验拓扑文件：</h1><p><a href="topology.net">拓扑文件</a></p>
<h1 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h1><p><img src="/2014/MPLS_Lab_10/topo.png"></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R1
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R2
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
ip vrf A<span class="token operator">-</span>Site1
        rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token comment">//注意：连接到同一站点的同一ISP的多个不同PE可以使用相同的RD，也可以使用不同的RD；</span>
        route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface Loopback1
        ip vrf forwarding A<span class="token operator">-</span>Site1
        ip address <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">2</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip vrf forwarding A<span class="token operator">-</span>Site1
        ip address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">2</span> area <span class="token number">0</span>
        no shutdown
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site1
        router<span class="token operator">-</span>id <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span>
        redistribute bgp <span class="token number">1</span> subnets
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
<span class="token operator">!</span>
router bgp <span class="token number">1</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> update<span class="token operator">-</span>source Loopback0
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family vpnv4
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> activate
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community both
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
        redistribute connected
        redistribute ospf <span class="token number">2</span> match internal external <span class="token number">1</span> external <span class="token number">2</span>
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R3"><a href="#R3" class="headerlink" title="R3:"></a>R3:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R3
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
ip vrf A<span class="token operator">-</span>Site1
        rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token comment">//注意：连接到同一站点的同一ISP的多个不同PE可以使用相同的RD，也可以使用不同的RD；</span>
        route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface Loopback1
        ip vrf forwarding A<span class="token operator">-</span>Site1
        ip address <span class="token number">33.33</span><span class="token number">.33</span><span class="token number">.33</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">2</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip vrf forwarding A<span class="token operator">-</span>Site1
        ip address <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">2</span> area <span class="token number">0</span>
        no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site1
        router<span class="token operator">-</span>id <span class="token number">33.33</span><span class="token number">.33</span><span class="token number">.33</span>
        redistribute bgp <span class="token number">1</span> subnets
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>
<span class="token operator">!</span>
router bgp <span class="token number">1</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> update<span class="token operator">-</span>source Loopback0
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family vpnv4
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> activate
        neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community both
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
        redistribute connected
        redistribute ospf <span class="token number">2</span> match internal external <span class="token number">1</span> external <span class="token number">2</span>
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R4"><a href="#R4" class="headerlink" title="R4:"></a>R4:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R4
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
ip vrf A<span class="token operator">-</span>Site2
        rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
        route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
        ip address <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface Loopback1
        ip vrf forwarding A<span class="token operator">-</span>Site2
        ip address <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        ip ospf <span class="token number">2</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        ip address <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        ip address <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">1</span> area <span class="token number">0</span>
        no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet1<span class="token operator">/</span><span class="token number">0</span>
        ip vrf forwarding A<span class="token operator">-</span>Site2
        ip address <span class="token number">192.168</span><span class="token number">.45</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
        ip ospf <span class="token number">2</span> area <span class="token number">0</span>
        no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site2
        router<span class="token operator">-</span>id <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span>
        redistribute bgp <span class="token number">1</span> subnets
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
        router<span class="token operator">-</span>id <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
<span class="token operator">!</span>
router bgp <span class="token number">1</span>
        bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
        neighbor ibgp peer<span class="token operator">-</span>group
        neighbor ibgp remote<span class="token operator">-</span>as <span class="token number">1</span>
        neighbor ibgp update<span class="token operator">-</span>source Loopback0
        neighbor ibgp next<span class="token operator">-</span>hop<span class="token operator">-</span>self
        neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> peer<span class="token operator">-</span>group ibgp
        neighbor <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> peer<span class="token operator">-</span>group ibgp
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family vpnv4
        neighbor ibgp send<span class="token operator">-</span>community both
        neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> activate
        neighbor <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> activate
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
        <span class="token operator">!</span>
        address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
        redistribute connected
        redistribute ospf <span class="token number">2</span> match internal external <span class="token number">1</span> external <span class="token number">2</span>
        exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
        exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
        logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R5"><a href="#R5" class="headerlink" title="R5:"></a>R5:</h2><pre class="language-none"><code class="language-none">hostname R5
!
ip cef
!
interface Loopback0
        ip address 5.5.5.5 255.255.255.255
        ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
        ip address 192.168.45.5 255.255.255.0
        ip ospf 1 area 0
        no shutdown
!
router ospf 1
        router-id 5.5.5.5
        redistribute connected subnets route-map CREATE_LSA5
&#x2F;&#x2F;为了创造出类型5的LSA；
!
route-map CREATE_LSA5 permit 10
        match interface Loopback1
&#x2F;&#x2F;为了创造出类型5的LSA；
!
line con 0
        exec-timeout 0 0
        logging synchronous
!
end</code></pre>
<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1：OSPF内部路由Down-bit"><a href="#实验1：OSPF内部路由Down-bit" class="headerlink" title="实验1：OSPF内部路由Down-bit"></a>实验1：OSPF内部路由Down-bit</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_9/" class="post-title-link" itemprop="url">MPLS 实验9：OSPF Sham Link and Backdoor Link in MPLS VPN</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-19 20:28:51" itemprop="dateCreated datePublished" datetime="2014-03-19T20:28:51+08:00">2014-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>

<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h1><p><img src="/2014/MPLS_Lab_9/topo.png"></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R1
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
ip vrf A<span class="token operator">-</span>Site1
    rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
    route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
    route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
    ip address <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface Loopback1
    ip vrf forwarding A<span class="token operator">-</span>Site1
    ip address <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    ip address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
mpls ip  
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
    ip vrf forwarding A<span class="token operator">-</span>Site1
    ip address <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">2</span> area <span class="token number">0</span>
    no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site1
    router<span class="token operator">-</span>id <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>
    redistribute bgp <span class="token number">1</span> subnets
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
    router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token operator">!</span>
router bgp <span class="token number">1</span>
    bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
    neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
    neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> update<span class="token operator">-</span>source Loopback0
    neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self
    <span class="token operator">!</span>
    address<span class="token operator">-</span>family vpnv4
    neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> activate
    neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> send<span class="token operator">-</span>community both
    exit<span class="token operator">-</span>address<span class="token operator">-</span>family
    <span class="token operator">!</span>
    address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
    redistribute connected
    redistribute ospf <span class="token number">2</span> match internal external <span class="token number">1</span> external <span class="token number">2</span>
    exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
    exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
    logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R2
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
ip vrf A<span class="token operator">-</span>Site2
    rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
    route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
    route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
    ip address <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface Loopback1
    ip vrf forwarding A<span class="token operator">-</span>Site2
    ip address <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    ip address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
mpls ip  
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
    ip vrf forwarding A<span class="token operator">-</span>Site2
    ip address <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">2</span> area <span class="token number">0</span>
    no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site2
    router<span class="token operator">-</span>id <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span>
    redistribute bgp <span class="token number">1</span> subnets
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
    router<span class="token operator">-</span>id <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
<span class="token operator">!</span>
router bgp <span class="token number">1</span>
    bgp log<span class="token operator">-</span>neighbor<span class="token operator">-</span>changes
    neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
    neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> update<span class="token operator">-</span>source Loopback0
    neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self
    <span class="token operator">!</span>
    address<span class="token operator">-</span>family vpnv4
    neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> activate
    neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> send<span class="token operator">-</span>community both
    exit<span class="token operator">-</span>address<span class="token operator">-</span>family
    <span class="token operator">!</span>
    address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
    redistribute connected
    redistribute ospf <span class="token number">2</span> match internal external <span class="token number">1</span> external <span class="token number">2</span>
    exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
    exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>

    logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R3"><a href="#R3" class="headerlink" title="R3:"></a>R3:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R3
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
    ip address <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
    ip address <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
<span class="token operator">!</span>
interface Serial1<span class="token operator">/</span><span class="token number">0</span>
    ip address <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
    clock rate <span class="token number">64000</span>
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
    router<span class="token operator">-</span>id <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
    exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
    logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h2 id="R4"><a href="#R4" class="headerlink" title="R4:"></a>R4:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R4
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
    ip address <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
    ip address <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
<span class="token operator">!</span>
interface Serial1<span class="token operator">/</span><span class="token number">0</span>
    ip address <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
    router<span class="token operator">-</span>id <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
    exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
    logging synchronous
<span class="token operator">!</span>
end</code></pre>
<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1：当在VPN站点之间存在后门备份链路时，使用OSPF-Sham-Link解决后门链路优先于MPLS-VPN链路的问题；"><a href="#实验1：当在VPN站点之间存在后门备份链路时，使用OSPF-Sham-Link解决后门链路优先于MPLS-VPN链路的问题；" class="headerlink" title="实验1：当在VPN站点之间存在后门备份链路时，使用OSPF Sham Link解决后门链路优先于MPLS VPN链路的问题；"></a>实验1：当在VPN站点之间存在后门备份链路时，使用OSPF Sham Link解决后门链路优先于MPLS VPN链路的问题；</h2><p>查看R3的路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R3#show ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">3.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">65</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">07</span><span class="token punctuation">,</span> Serial1<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
O     <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">65</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">07</span><span class="token punctuation">,</span> Serial1<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> Serial1<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> Serial1<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//此时，R3去往4.4.4.4/32和192.168.24.0/24是通过走后门链路；</span>
<span class="token comment">//而后门链路通常是作为备份链路，在主链路正常的情况下，通常不希望，走备份链路；</span></code></pre>
<p>查看R3的OSPF Database；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip  ospf <span class="token number">1</span> database
            OSPF Router with <span class="token function">ID</span> <span class="token punctuation">(</span><span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Process ID <span class="token number">1</span><span class="token punctuation">)</span>
                Router Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum Link count
<span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>         <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>         <span class="token number">10</span>          <span class="token number">0x80000006</span> <span class="token number">0x003904</span> <span class="token number">4</span>
<span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">11</span>          <span class="token number">0x80000004</span> <span class="token number">0x0049D4</span> <span class="token number">4</span>
<span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">110</span>         <span class="token number">0x80000001</span> <span class="token number">0x00B333</span> <span class="token number">1</span>
<span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span>     <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span>     <span class="token number">95</span>          <span class="token number">0x80000002</span> <span class="token number">0x0075FF</span> <span class="token number">1</span>
<span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.4</span>    <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.4</span>    <span class="token number">1384</span>        <span class="token number">0x80000005</span> <span class="token number">0x00DADF</span> <span class="token number">4</span>
                Net Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum
<span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.3</span>    <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>         <span class="token number">108</span>         <span class="token number">0x80000001</span> <span class="token number">0x007408</span>
<span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.4</span>    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">94</span>          <span class="token number">0x80000001</span> <span class="token number">0x001D1F</span>
                Summary Net Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum
<span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>         <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span>     <span class="token number">99</span>          <span class="token number">0x80000001</span> <span class="token number">0x00F461</span>
<span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">89</span>          <span class="token number">0x80000001</span> <span class="token number">0x00126C</span>
<span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.0</span>    <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span>     <span class="token number">99</span>          <span class="token number">0x80000001</span> <span class="token number">0x0034B8</span>
<span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.0</span>    <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">99</span>          <span class="token number">0x80000001</span> <span class="token number">0x000608</span>
                Type<span class="token operator">-</span><span class="token number">5</span> AS External Link States
Link ID         ADV Router      Age         Seq#       Checksum Tag
<span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span>     <span class="token number">99</span>          <span class="token number">0x80000001</span> <span class="token number">0x00E478</span> <span class="token number">3489660929</span>
<span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span>     <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">109</span>         <span class="token number">0x80000001</span> <span class="token number">0x003429</span> <span class="token number">3489660929</span></code></pre>
<p>注意到，从MPLS VPN过来的LSA是类型3的LSA，而从后门链路过来的LSA是类型1的LSA；以前的实验说过，在OSPF看来，MPLS VPN超骨干网络超越了OSPF骨干区域Area0，MPLS VPN超骨干网络神似OSPF骨干区域Area0，但它又和OSPF骨干区域Area0不同，所以PE路由器会执行ABR的功能，会将类型为1和2的LSA转换为类型3的LSA；所以当PE在收到来自对端远程PE发来的OSPF区域内路由（O）时，会将OSPF区域内路由转换为OSPF区域间路由（O IA）。</p>
<p>为了避免PE将类型1和类型2的LSA转换为类型3的LSA，可以在PE之间创建OSPF Sham Link；这样，当LSA在Sham Link中进行洪泛时，所有的OSPF路由类型都不会改变，不会转变为类型3或者类型5的LSA；</p>
<p><strong>在PE上配置OSPF Sham Link；</strong></p>
<pre class="language-c" data-language="c"><code class="language-c">注意：必须将Sham Link的源地址和目的地址所在的接口划分进VRF；
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#area <span class="token number">0</span> sham<span class="token operator">-</span>link <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span>

<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site2
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#area <span class="token number">0</span> sham<span class="token operator">-</span>link <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>

<span class="token comment">//将接口Loopback1的地址以路由的形式通告进MP-BGP的IPv4 VRF地址族；</span>
<span class="token comment">//注意：必须在PE上将各自用作Sham Link的源地址的接口地址通告进MP-BGP的IPv4 VRF地址族，否则Sham Link会反复震荡；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>

<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span></code></pre>
<p>将作为Sham Link源地址，并且同时也作为了对方PE Sham Link目的地址的接口移除OSPF VRF进程；</p>
<blockquote>
<p>备注：虽然在此次实验中，我没有将R1和R2的Loopback1通告进OSPF VRF进程，但仍需注意这一点；</p>
</blockquote>
<blockquote>
<p>注意：确保作为Sham Link源地址和目的地址的接口不能被通告进OSPF VRF进程；</p>
</blockquote>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site1               
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no network <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span> area <span class="token number">0</span>

<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site2
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no network <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span> area <span class="token number">0</span></code></pre>
<p>查看R3的路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route           
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">3.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">09</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span> <span class="token comment">//注意路由的度量值；</span>
        <span class="token number">11.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O E2     <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">04</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">22.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O E2     <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">51</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
O     <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">09</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> Serial1<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> Serial1<span class="token operator">/</span><span class="token number">0</span></code></pre>

<p>查看R4的路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">3.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span> <span class="token comment">//注意路由的度量值；</span>
        <span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">11.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O E2     <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">39</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">22.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O E2     <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
O     <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> Serial1<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> Serial1<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//可以看到R3和R4现在都通过MPLS VPN去往对方所在站点；</span></code></pre>

<p>在必要时还可以修改Sham Link的开销，让Sham Link比后门链路的度量值更低，以便优先选择作为主链路的MPLS VPN，而不是备份的后门链路；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span># area <span class="token number">0</span> sham<span class="token operator">-</span>link <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span> cost <span class="token number">10</span>

<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site2
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#area <span class="token number">0</span> sham<span class="token operator">-</span>link <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> cost <span class="token number">10</span></code></pre>

<p>查看R3的路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">3.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">13</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">58</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span> <span class="token comment">//注意路由的度量值变化；</span>
        <span class="token number">11.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O E2     <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">59</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">22.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O E2     <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">46</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
O     <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">12</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">58</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> Serial1<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> Serial1<span class="token operator">/</span><span class="token number">0</span></code></pre>
<p>查看R4的路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">3.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">13</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span> <span class="token comment">//注意路由的度量值变化；</span>
        <span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">11.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O E2     <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">40</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">22.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O E2     <span class="token number">22.22</span><span class="token number">.22</span><span class="token number">.22</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
O     <span class="token number">192.168</span><span class="token number">.13</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">12</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.24</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> Serial1<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> Serial1<span class="token operator">/</span><span class="token number">0</span></code></pre>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_8/" class="post-title-link" itemprop="url">MPLS 实验8：MPLS VPN running OSPF on the PE-CE link</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-14 22:58:51" itemprop="dateCreated datePublished" datetime="2014-03-14T22:58:51+08:00">2014-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>

<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="GNS3实验拓扑文件："><a href="#GNS3实验拓扑文件：" class="headerlink" title="GNS3实验拓扑文件："></a>GNS3实验拓扑文件：</h1><p><a href="topology.net">拓扑文件</a></p>
<h1 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h1><p><img src="/2014/MPLS_Lab_8/topo.png"></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R1
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
    ip address <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    ip address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shut
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
    ip address <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    no shut
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
    router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token operator">!</span>         
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
    exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
    logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R2
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
    ip address <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    ip address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
    ip address <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
mpls ip
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
    router<span class="token operator">-</span>id <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
    exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
    logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R3"><a href="#R3" class="headerlink" title="R3:"></a>R3:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R3
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
    ip address <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    ip address <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
    ip address <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
mpls ip
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
    router<span class="token operator">-</span>id <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
    exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
    logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R4"><a href="#R4" class="headerlink" title="R4:"></a>R4:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R4
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
mpls label protocol ldp
<span class="token operator">!</span>
interface Loopback0
    ip address <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    ip address <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
mpls ip
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
    ip address <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
    router<span class="token operator">-</span>id <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
<span class="token operator">!</span>
mpls ldp router<span class="token operator">-</span>id Loopback0 force
<span class="token operator">!</span>
line con <span class="token number">0</span>
    exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
    logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R5"><a href="#R5" class="headerlink" title="R5:"></a>R5:</h2><pre class="language-none"><code class="language-none">hostname R5
!
ip cef
!
interface Loopback0
    ip address 5.5.5.5 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.56.5 255.255.255.0
    ip ospf 1 area 0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.15.5 255.255.255.0
    no shutdown
!
router ospf 1
    router-id 5.5.5.5
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R6"><a href="#R6" class="headerlink" title="R6:"></a>R6:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R6
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
    ip address <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    ip address <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.6</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
    router<span class="token operator">-</span>id <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
    exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
    logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R7"><a href="#R7" class="headerlink" title="R7:"></a>R7:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R7
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
    ip address <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    ip address <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
    ip address <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
    router<span class="token operator">-</span>id <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>
<span class="token operator">!</span>
line con <span class="token number">0</span>
    exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
    logging synchronous
<span class="token operator">!</span>
end</code></pre>

<h2 id="R8"><a href="#R8" class="headerlink" title="R8:"></a>R8:</h2><pre class="language-c" data-language="c"><code class="language-c">hostname R8
<span class="token operator">!</span>
ip cef
<span class="token operator">!</span>
interface Loopback0
    ip address <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
<span class="token operator">!</span>
interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    ip address <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.8</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
    ip ospf <span class="token number">1</span> area <span class="token number">0</span>
    no shutdown
<span class="token operator">!</span>
router ospf <span class="token number">1</span>
    router<span class="token operator">-</span>id <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
<span class="token operator">!</span>         
line con <span class="token number">0</span>
    exec<span class="token operator">-</span>timeout <span class="token number">0</span> <span class="token number">0</span>
    logging synchronous
<span class="token operator">!</span>
end</code></pre>


<h1 id="MPLS-VPN配置步骤："><a href="#MPLS-VPN配置步骤：" class="headerlink" title="MPLS VPN配置步骤："></a>MPLS VPN配置步骤：</h1><ol>
<li>创建VRF（VRF名本地有效）：<ul>
<li>指定RD（提供全局唯一的私网单播地址）；</li>
<li>指定RT的导出（导出：把重分发进MP-BGP的VPNv4路由打上MP-BGP扩展团体属性RT）和导入（导入：把MP-BGP里的VPNv4路由进行RT的匹配，匹配成功的VPNv4路由将放进相应的VRF）；</li>
<li>将与CE相连的PE接口关联特定VRF；</li>
</ul>
</li>
<li>配置MP-BGP：<ul>
<li>配置建立PE之间的IBGP邻居关系；</li>
<li>启用VPNv4地址族（AF），并激活与其他PE设备的邻居关系；</li>
</ul>
</li>
<li>配置PE-CE路由；<ul>
<li>配置IGP，并启用IGP的地址族（AF）；</li>
<li>配置启用MP-BGP IPv4 VRF地址族，然后激活与其他PE路由器的MP-BGP IPv4 VRF邻居关系；</li>
</ul>
</li>
</ol>
<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1：配置MPLS-VPN"><a href="#实验1：配置MPLS-VPN" class="headerlink" title="实验1：配置MPLS VPN"></a>实验1：配置MPLS VPN</h2><h3 id="在PE上创建VRF；"><a href="#在PE上创建VRF；" class="headerlink" title="在PE上创建VRF；"></a>在PE上创建VRF；</h3><p>在PE1（R1）上创建VRF，并命名为A-Site1，表示该VRF为VPN A的站点1服务；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site1   </code></pre>

<p>指定RD，为1:1，如果按照AS：num命名法，以下RD表示AS1中的第2个VRF；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>

<p>指定RT的导入和导出，这里我将RT指定为导入和导出1：1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target <span class="token operator">?</span>        
    ASN<span class="token operator">:</span>nn or IP<span class="token operator">-</span>address<span class="token operator">:</span>nn  Target VPN Extended Community
    both                     Both import and export Target<span class="token operator">-</span>VPN community
    export                   Export Target<span class="token operator">-</span>VPN community
    import                   Import Target<span class="token operator">-</span>VPN community
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target both <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>

<p>将PE1（R1）上与CE相连的PE接口F0&#x2F;1关联到VRF A-Site1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site1
<span class="token operator">%</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span> IPv4 disabled and <span class="token function">address</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span> removed due to enabling VRF A<span class="token operator">-</span>Site1
    <span class="token comment">//切记先将接口关联VRF，然后再配置IP地址；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span></code></pre>
<p>在PE2（R4）上创建VRF，并命名为A-Site2，表示该VRF为VPN A的站点2服务；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site2</code></pre>

<p>指定RD，为1:2，如果按照AS：num命名法，以下RD表示AS1中的第2个VRF；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span></code></pre>

<p>指定RT的导入和导出，这里我将RT指定为导入和导出1：1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target both <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>
<p>因为PE1导出的RT为1:1，PE2导入的RT正是PE1的导出RT1:1，所以PE1（R1）的RT导出和PE2（R4）的RT导入能够匹配成功，R4能够学到R1导入到MP-BGP中的VPNv4路由；又因为PE2导出的RT为1:1，PE1导入的RT也正好是PE2的导出RT1:1；所以PE2（R4）的RT导出和PE1（R1）的RT导入能够匹配成对，R1能够学到R4导入到MP-BGP中的VPNv4路由</p>
<p>将PE2（R4）上与CE相连的PE接口F0&#x2F;1关联到VRF A-Site2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site2
<span class="token operator">%</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span> IPv4 disabled and <span class="token function">address</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span> removed due to enabling VRF A<span class="token operator">-</span>Site2
    <span class="token comment">//切记先将接口关联VRF，然后再配置IP地址；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span></code></pre>
<h3 id="配置MP-BGP；"><a href="#配置MP-BGP；" class="headerlink" title="配置MP-BGP；"></a>配置MP-BGP；</h3><p>在PE1（R1）上配置MP-BGP，使之与其他PE建立IBGP关系，在此实验中只有PE1和PE2两台PE设备；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no syn
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#bgp router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> update<span class="token operator">-</span>source l0
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self</code></pre>

<p>启用PE1（R1）的VPNv4地址族，并激活与IBGP邻居PE2（R4）的MP-BGP VPNv4邻居关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family vpnv4
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> activate
<span class="token comment">//激活与IBGP邻居R4的VPNv4关系；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community <span class="token operator">?</span>
    both      Send Standard and Extended Community attributes
    extended  Send Extended Community attribute
    standard  Send Standard Community attribute
    <span class="token operator">&lt;</span>cr<span class="token operator">></span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community both
<span class="token comment">//由于BGP团体属性为可选传递属性，所以必须手动指定R1向IBGP邻居R4发送拓展团体属性和标准团体属性；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token comment">//退出AF配置模式；</span></code></pre>
<p>在PE2（R4）上配置MP-BGP，使之与其他PE建立IBGP关系，</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no syn
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#bgp router<span class="token operator">-</span>id <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> update<span class="token operator">-</span>source l0
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self</code></pre>

<p>启用PE2（R4）的VPNv4地址族，并激活与IBGP邻居PE1（R1）的MP-BGP VPNv4邻居关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family vpnv4
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> activate
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> send<span class="token operator">-</span>community both</code></pre>
<h3 id="配置PE-CE路由；"><a href="#配置PE-CE路由；" class="headerlink" title="配置PE-CE路由；"></a>配置PE-CE路由；</h3><p>配置PE1（R1）的IGP OSPF VRF进程；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#interface loopback1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
<span class="token comment">//创建接口Loopback1，以使用此环回口作为OSPF 2 VRF A-Site1进程的Router-id；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#router<span class="token operator">-</span>id <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span> area <span class="token number">0</span>
<span class="token comment">//OSPF VRF进程中的命令和常规OSPF进程中的相同，使用network命令将接口Loopback1宣告进OSPF VRF进程；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> subnets 
<span class="token comment">//将MP-BGP中IPv4 VRF地址族的命名与OSPF VRF进程的VRF命名相同的MP-BGP路由重分布进此OSPF VRF进程；</span>
<span class="token comment">//OSPF VRF进程和MP-BGP中IPv4 VRF地址族（AF）实际上是执行相互重分发的操作；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip ospf <span class="token number">2</span> area <span class="token number">0</span>
<span class="token comment">//同时，与常规OSPF进程相同，也可以在接口下将接口宣告进OSPF VRF进程；</span></code></pre>

<p>配置PE1（R1）的MP-BGP IPv4 VRF地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
<span class="token comment">//进入MP-BGP的IPv4 VRF地址族（AF）；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site1 match internal external 
<span class="token comment">//默认情况下，把OSPF重分发进BGP，只会将OSPF内部路由重分发进BGP，</span>
<span class="token comment">//如果需要将所有OSPF路由（内部和外部路由）重分发进去BGP，需要使用选项match；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected 
<span class="token comment">//如果用户在CE路由器上ping远程网络的另一个VPN站点中的CE或C路由器，</span>
<span class="token comment">//为了使其在没有指定其源地址情况下（即默认使用CE路由器出站接口IP地址），Echo Reply包能够有路由并正常返回,</span>
<span class="token comment">//将PE路由器的直连路由重分布进MP-BGP的IPv4 VRF AF中；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family 
<span class="token comment">//退出MP-BGP的IPv4 VRF地址族（AF）模式；</span></code></pre>
<p>配置PE2（R4）的IGP OSPF VRF进程；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#interface loopback1
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#router<span class="token operator">-</span>id <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span> area <span class="token number">0</span>

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> subnets 

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip ospf <span class="token number">2</span> area <span class="token number">0</span></code></pre>

<p>配置PE2（R4）的MP-BGP IPv4 VRF地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site2 match internal external 
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected 
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family </code></pre>
<h3 id="验证与调试；"><a href="#验证与调试；" class="headerlink" title="验证与调试；"></a>验证与调试；</h3><p>在VPN A站点1的C路由器R6上ping远程VPN A站点2的C路由器R8；</p>
<pre class="language-c" data-language="c"><code class="language-c">R6#ping <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">140</span><span class="token operator">/</span><span class="token number">173</span><span class="token operator">/</span><span class="token number">212</span> ms
<span class="token comment">//成功！</span></code></pre>

<p>查看PE2（R4）的OSPF链路状态数据库；</p>
<pre class="language-c" data-language="c"><code class="language-c">R4#show ip ospf database
            OSPF Router with <span class="token function">ID</span> <span class="token punctuation">(</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Process ID <span class="token number">1</span><span class="token punctuation">)</span>
                Router Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum Link count
<span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>         <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>         <span class="token number">1920</span>        <span class="token number">0x80000005</span> <span class="token number">0x0048DB</span> <span class="token number">2</span>
<span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>         <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>         <span class="token number">1933</span>        <span class="token number">0x80000006</span> <span class="token number">0x0039C6</span> <span class="token number">3</span>
<span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>         <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>         <span class="token number">1978</span>        <span class="token number">0x80000006</span> <span class="token number">0x009D26</span> <span class="token number">3</span>
<span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">45</span>          <span class="token number">0x80000006</span> <span class="token number">0x003A93</span> <span class="token number">2</span>
                Net Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum
<span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>    <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>         <span class="token number">1933</span>        <span class="token number">0x80000004</span> <span class="token number">0x008922</span>
<span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span>    <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>         <span class="token number">1978</span>        <span class="token number">0x80000004</span> <span class="token number">0x003C57</span>
<span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span>    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">45</span>          <span class="token number">0x80000005</span> <span class="token number">0x00EC8D</span>
            OSPF Router with <span class="token function">ID</span> <span class="token punctuation">(</span><span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Process ID <span class="token number">2</span><span class="token punctuation">)</span>
                Router Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum Link count
<span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>         <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>         <span class="token number">1944</span>        <span class="token number">0x80000007</span> <span class="token number">0x0030CA</span> <span class="token number">3</span>
<span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>         <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>         <span class="token number">1146</span>        <span class="token number">0x80000005</span> <span class="token number">0x002E11</span> <span class="token number">2</span>
<span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span>     <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span>     <span class="token number">1858</span>        <span class="token number">0x80000003</span> <span class="token number">0x004D81</span> <span class="token number">2</span>
                Net Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum
<span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span>    <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>         <span class="token number">1944</span>        <span class="token number">0x80000002</span> <span class="token number">0x005B55</span>
<span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span>    <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>         <span class="token number">1167</span>        <span class="token number">0x80000004</span> <span class="token number">0x00F12E</span>
                Summary Net Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum
<span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span>         <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span>     <span class="token number">1858</span>        <span class="token number">0x80000002</span> <span class="token number">0x00FFF4</span>
<span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span>         <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span>     <span class="token number">1858</span>        <span class="token number">0x80000002</span> <span class="token number">0x00DB14</span>
<span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span>     <span class="token number">1858</span>        <span class="token number">0x80000002</span> <span class="token number">0x00E0FC</span>
<span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>    <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span>     <span class="token number">1858</span>        <span class="token number">0x80000002</span> <span class="token number">0x00850C</span>
<span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span>    <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span>     <span class="token number">1858</span>        <span class="token number">0x80000002</span> <span class="token number">0x00CA9C</span>
<span class="token comment">//可以看到，当关于VPN A站点2的前缀在PE2（R4）上的时候，它们都还是类型1或者类型2的LSA；</span>
<span class="token comment">//而关于这些前缀的LSA在PE1（R1）的时候，它们</span></code></pre>

<p>查看PE1（R1）的OSPF链路状态数据库；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show ip ospf database
            OSPF Router with <span class="token function">ID</span> <span class="token punctuation">(</span><span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Process ID <span class="token number">1</span><span class="token punctuation">)</span>
                Router Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum Link count
<span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>         <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>         <span class="token number">1406</span>        <span class="token number">0x80000005</span> <span class="token number">0x0048DB</span> <span class="token number">2</span>
<span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>         <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>         <span class="token number">1422</span>        <span class="token number">0x80000006</span> <span class="token number">0x0039C6</span> <span class="token number">3</span>
<span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>         <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>         <span class="token number">1468</span>        <span class="token number">0x80000006</span> <span class="token number">0x009D26</span> <span class="token number">3</span>
<span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">1559</span>        <span class="token number">0x80000005</span> <span class="token number">0x003C92</span> <span class="token number">2</span>
                Net Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum
<span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>    <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>         <span class="token number">1422</span>        <span class="token number">0x80000004</span> <span class="token number">0x008922</span>
<span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span>    <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>         <span class="token number">1468</span>        <span class="token number">0x80000004</span> <span class="token number">0x003C57</span>
<span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span>    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">1559</span>        <span class="token number">0x80000004</span> <span class="token number">0x00EE8C</span>
            OSPF Router with <span class="token function">ID</span> <span class="token punctuation">(</span><span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Process ID <span class="token number">2</span><span class="token punctuation">)</span>
                Router Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum Link count
<span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span>         <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span>         <span class="token number">1495</span>        <span class="token number">0x80000008</span> <span class="token number">0x00ACD9</span> <span class="token number">3</span>
<span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span>         <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span>         <span class="token number">812</span>         <span class="token number">0x80000006</span> <span class="token number">0x00285E</span> <span class="token number">2</span>
<span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">593</span>         <span class="token number">0x80000006</span> <span class="token number">0x007628</span> <span class="token number">2</span>
                Net Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum
<span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>    <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span>         <span class="token number">1495</span>        <span class="token number">0x80000003</span> <span class="token number">0x004E18</span>
<span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span>    <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span>         <span class="token number">732</span>         <span class="token number">0x80000004</span> <span class="token number">0x008CC3</span>
                Summary Net Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>
Link ID         ADV Router      Age         Seq#       Checksum
<span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>         <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">1362</span>        <span class="token number">0x80000002</span> <span class="token number">0x0085EB</span>
<span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>         <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">1362</span>        <span class="token number">0x80000002</span> <span class="token number">0x00610B</span>
<span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span>     <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">1362</span>        <span class="token number">0x80000002</span> <span class="token number">0x00CE0F</span>
<span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span>    <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">1362</span>        <span class="token number">0x80000002</span> <span class="token number">0x0006EF</span>
<span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span>    <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span>     <span class="token number">1362</span>        <span class="token number">0x80000002</span> <span class="token number">0x00B91C</span>
<span class="token comment">//可以看到，当关于VPN A站点2的前缀在PE2（R4）上的时候，它们都还是类型1或者类型2的LSA；</span>
<span class="token comment">//而关于这些前缀的LSA在PE1（R1）的时候，它们都已经变为了类型3的LSA；</span>
<span class="token comment">//这说明，PE2（R4）将类型为1和2的LSA转换为类型3的LSA；</span>
<span class="token comment">//PE1（R1）收到了远程PE2（R4）发来的类型3的LSA，将其装换为OSPF区域间路由（O IA）；</span></code></pre>

<p>查看R6的IP路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R6#show ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
                                                            
Gateway of last resort is not set
                                                            
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">07</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O IA     <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">55</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O IA     <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">55</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">11.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">44.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O IA     <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">55</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
O     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">07</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
O IA  <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">55</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
O IA  <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">55</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//注意：在OSPF看来，MPLS VPN超骨干网络超越了OSPF骨干区域Area0，MPLS VPN超骨干网络神似OSPF骨干区域Area0，</span>
<span class="token comment">//但它又和OSPF骨干区域Area0不同，所以PE路由器会执行ABR的功能，会将类型为1和2的LSA转换为类型3的LSA；</span>
<span class="token comment">//所以当PE在收到来自对端远程PE发来的OSPF区域内路由（O）时，会将OSPF区域内路由转换为OSPF区域间路由（O IA）；</span></code></pre>

<p>调试OSPF 2的LSA生成；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#debug ip ospf <span class="token number">2</span> lsa<span class="token operator">-</span>generation
OSPF LSA generation debugging is on <span class="token keyword">for</span> process <span class="token number">2</span>
R1#clear ip ospf <span class="token number">2</span> process
Reset OSPF process <span class="token number">2</span><span class="token operator">?</span> <span class="token punctuation">[</span>no<span class="token punctuation">]</span><span class="token operator">:</span> yes
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">26.607</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">26.611</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> on FastEthernet0<span class="token operator">/</span><span class="token number">1</span> from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">26.619</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">26.619</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling network LSA on FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">26.623</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">26.627</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">26.631</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">26.647</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">26.651</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">26.655</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">26.731</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">26.743</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.107</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Build router LSA <span class="token keyword">for</span> area <span class="token number">0</span><span class="token punctuation">,</span> router ID <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> seq <span class="token number">0x80000001</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.143</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> on FastEthernet0<span class="token operator">/</span><span class="token number">1</span> from LOADING to FULL<span class="token punctuation">,</span> Loading Done
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.147</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.647</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.747</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">3</span><span class="token punctuation">,</span> LSID <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token punctuation">,</span> Adv rtr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x80000001</span><span class="token punctuation">,</span> from <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.751</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Update summary LSA <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">3</span> <span class="token number">80000001</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.755</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">3</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.759</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">3</span><span class="token punctuation">,</span> LSID <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> Adv rtr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x80000001</span><span class="token punctuation">,</span> from <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.763</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Update summary LSA <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">3</span> <span class="token number">80000001</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.767</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">3</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.771</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">3</span><span class="token punctuation">,</span> LSID <span class="token number">44.4</span>
R1#<span class="token number">4.44</span><span class="token number">.44</span><span class="token punctuation">,</span> Adv rtr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x80000005</span><span class="token punctuation">,</span> from <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.775</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Update summary LSA <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">3</span> <span class="token number">80000005</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.779</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">3</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.783</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">3</span><span class="token punctuation">,</span> LSID <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token punctuation">,</span> Adv rtr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x80000005</span><span class="token punctuation">,</span> from <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.787</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Update summary LSA <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">3</span> <span class="token number">80000005</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.791</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">3</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.795</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">3</span><span class="token punctuation">,</span> LSID <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token punctuation">,</span> Adv rtr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x80000001</span><span class="token punctuation">,</span> from <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.799</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Update summary LSA <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">3</span> <span class="token number">80000001</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">27.803</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">3</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">28.611</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
R1#
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">29.111</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">1</span>
R1#
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">31.779</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">1</span><span class="token punctuation">,</span> LSID <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> Adv rtr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x80000006</span><span class="token punctuation">,</span> from <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">31.787</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Update router LSA <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">1</span> <span class="token number">80000006</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">31.791</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">32.071</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">1</span><span class="token punctuation">,</span> LSID <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> Adv rtr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x80000006</span><span class="token punctuation">,</span> from <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">32.075</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Update router LSA <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">1</span> <span class="token number">80000006</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">32.079</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">1</span>
R1#
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">32.107</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSGEN<span class="token operator">:</span> Build router LSA <span class="token keyword">for</span> area <span class="token number">0</span><span class="token punctuation">,</span> router ID <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> seq <span class="token number">0x80000007</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">32.715</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">3</span><span class="token punctuation">,</span> LSID <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token punctuation">,</span> Adv rtr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x80000001</span><span class="token punctuation">,</span> from <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">32.719</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">3</span><span class="token punctuation">,</span> LSID <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> Adv rtr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x80000001</span><span class="token punctuation">,</span> from <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">32.723</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">3</span><span class="token punctuation">,</span> LSID <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span><span class="token punctuation">,</span> Adv rtr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x80000005</span><span class="token punctuation">,</span> from <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
R1#
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">32.727</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">3</span><span class="token punctuation">,</span> LSID <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token punctuation">,</span> Adv rtr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x80000005</span><span class="token punctuation">,</span> from <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">32.727</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">2</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">3</span><span class="token punctuation">,</span> LSID <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token punctuation">,</span> Adv rtr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x80000001</span><span class="token punctuation">,</span> from <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token comment">//可以看到，正如之前的结论，PE1（R1）收到关于VPN A站点2中前缀的LSA是类型3的LSA；</span>
<span class="token comment">//证实了PE2（R4）将这些类型为1和2的LSA转换为类型3的LSA后，再将其发送给PE1（R1）；</span></code></pre>

<h2 id="实验2：OSPF-Sham-Link-in-MPLS-VPN"><a href="#实验2：OSPF-Sham-Link-in-MPLS-VPN" class="headerlink" title="实验2：OSPF Sham Link in MPLS VPN"></a>实验2：OSPF Sham Link in MPLS VPN</h2><h3 id="理论概述："><a href="#理论概述：" class="headerlink" title="理论概述："></a>理论概述：</h3><p>在OSPF看来，MPLS VPN超骨干网络超越了OSPF骨干区域Area0，MPLS VPN超骨干网络神似OSPF骨干区域Area0，<br>但它又和OSPF骨干区域Area0不同，所以PE路由器会执行ABR的功能，会将类型为1和2的LSA转换为类型3的LSA；<br>所以当PE在收到来自对端远程PE发来的OSPF区域内路由（O）时，会将OSPF区域内路由转换为OSPF区域间路由（O IA）。<br>为了避免PE将类型1和类型2的LSA转换为类型3的LSA，可以在PE之间创建OSPF Sham Link；这样，当LSA在Sham Link中<br>进行洪泛时，所有的OSPF路由类型都不会改变，不会转变为类型3或者类型5的LSA；</p>
<h3 id="配置："><a href="#配置：" class="headerlink" title="配置："></a>配置：</h3><p>在PE上配置OSPF Sham Link；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#area <span class="token number">0</span> sham<span class="token operator">-</span>link <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span>
<span class="token comment">//注意：必须将Sham Link的源地址和目的地址所在的接口划分进VRF；</span>

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#area <span class="token number">0</span> sham<span class="token operator">-</span>link <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span> <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span></code></pre>

<p><strong>注意：在OSPF VRF进程中配置完sham link后发现sham link反复震荡；</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">37.859</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from LOADING to FULL<span class="token punctuation">,</span> Loading Done
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">42.979</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span># 
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">48.703</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from LOADING to FULL<span class="token punctuation">,</span> Loading Done
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">52.999</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">58.743</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from LOADING to FULL<span class="token punctuation">,</span> Loading Done
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">03.011</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">08.879</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from LOADING to FULL<span class="token punctuation">,</span> Loading Done
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">13.039</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token comment">//注意：必须在PE上将各自用作Sham Link的源地址的接口地址通告进MP-BGP的IPv4 VRF地址族，否则Sham Link会反复震荡；</span></code></pre>

<p>将接口Loopback1的地址以路由的形式通告进MP-BGP的IPv4 VRF地址族；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span> mask <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span></code></pre>

<p>注意：在将接口Loopback1的地址以路由的形式通告进MP-BGP的IPv4 VRF地址族，发现Sham Link依旧反复震荡；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">58.743</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from LOADING to FULL<span class="token punctuation">,</span> Loading Done
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">03.011</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">08.879</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from LOADING to FULL<span class="token punctuation">,</span> Loading Done
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">13.039</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token comment">//注意：作为Sham Link源地址和目的地址的接口不能被通告进OSPF VRF进程；</span></code></pre>
<p>将作为Sham Link源地址，并且同时也作为了对方PE Sham Link目的地址的接口移除OSPF VRF进程；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site1               
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no network <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span> area <span class="token number">0</span>

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">2</span> vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no network <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span> area <span class="token number">0</span></code></pre>

<p><strong>OSPF Sham Link持续稳定！</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">35.779</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span> on OSPF_SL0 from LOADING to FULL<span class="token punctuation">,</span> Loading Done

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">20</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">36.067</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">2</span><span class="token punctuation">,</span> Nbr <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> on OSPF_SL0 from LOADING to FULL<span class="token punctuation">,</span> Loading Done</code></pre>

<h3 id="验证与调试："><a href="#验证与调试：" class="headerlink" title="验证与调试："></a>验证与调试：</h3><p>查看R6的路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R6#sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
Gateway of last resort is not set
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">04</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">6</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">11.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O E2     <span class="token number">11.11</span><span class="token number">.11</span><span class="token number">.11</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">37</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">44.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O E2     <span class="token number">44.44</span><span class="token number">.44</span><span class="token number">.44</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
O     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">04</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
O     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
O     <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span></code></pre>
<p>注意到，现在关于R6上看到关于站点2的路由就变成了OSPF区域内路由（O）；但是，由于关于11.11.11.11&#x2F;32和44.44.44.44&#x2F;32的路由，由于它们并不是在OSPF里进行通告的,而是通告进BGP，然后才被重分发进OSPF的，所以都变成了OSPF外部路由（O E2）；</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_7/" class="post-title-link" itemprop="url">MPLS 实验7：MPLS VPN running EIGRP on the PE-CE link</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-14 22:48:51" itemprop="dateCreated datePublished" datetime="2014-03-14T22:48:51+08:00">2014-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>

<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="GNS3实验拓扑文件："><a href="#GNS3实验拓扑文件：" class="headerlink" title="GNS3实验拓扑文件："></a>GNS3实验拓扑文件：</h1><p><a href="topology.net">拓扑文件</a></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-none"><code class="language-none">hostname R1
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 1.1.1.1 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.1 255.255.255.0
    ip ospf 1 area 0
    no shut
    mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.15.1 255.255.255.0
    no shut
!
router ospf 1
    router-id 1.1.1.1
!         
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-none"><code class="language-none">hostname R2
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 2.2.2.2 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
    mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
    mpls ip
!
router ospf 1
    router-id 2.2.2.2
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R3"><a href="#R3" class="headerlink" title="R3:"></a>R3:</h2><pre class="language-none"><code class="language-none">hostname R3
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 3.3.3.3 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.3 255.255.255.0
    ip ospf 1 area 0
    no shutdown
    mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.3 255.255.255.0
    ip ospf 1 area 0
    no shutdown
    mpls ip
!
router ospf 1
    router-id 3.3.3.3
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R4"><a href="#R4" class="headerlink" title="R4:"></a>R4:</h2><pre class="language-none"><code class="language-none">hostname R4
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 4.4.4.4 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.4 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.47.4 255.255.255.0
    no shutdown
!
router ospf 1
    router-id 4.4.4.4
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R5"><a href="#R5" class="headerlink" title="R5:"></a>R5:</h2><pre class="language-none"><code class="language-none">hostname R5
!
ip cef
!
interface Loopback0
    ip address 5.5.5.5 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.56.5 255.255.255.0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.15.5 255.255.255.0
    no shutdown
!
router eigrp 1
    network 5.5.5.5 0.0.0.0
    network 192.168.15.5 0.0.0.0
    network 192.168.56.0
    eigrp router-id 5.5.5.5
    no auto-summary
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R6"><a href="#R6" class="headerlink" title="R6:"></a>R6:</h2><pre class="language-none"><code class="language-none">hostname R6
!
ip cef
!
interface Loopback0
    ip address 6.6.6.6 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.56.6 255.255.255.0
    no shutdown
!
router eigrp 1
    network 6.6.6.6 0.0.0.0
    network 192.168.56.0
    eigrp router-id 6.6.6.6
    no auto-summary
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R7"><a href="#R7" class="headerlink" title="R7:"></a>R7:</h2><pre class="language-none"><code class="language-none">hostname R7
!
ip cef
!
interface Loopback0
    ip address 7.7.7.7 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.78.7 255.255.255.0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.47.7 255.255.255.0
    no shutdown
!
router eigrp 1
    network 7.7.7.7 0.0.0.0
    network 192.168.47.0
    network 192.168.78.0
    eigrp router-id 7.7.7.7
    no auto-summary
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R8"><a href="#R8" class="headerlink" title="R8:"></a>R8:</h2><pre class="language-none"><code class="language-none">hostname R8
!
ip cef
!
interface Loopback0
    ip address 8.8.8.8 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.78.8 255.255.255.0
    no shutdown
!
router eigrp 1
    network 8.8.8.8 0.0.0.0
    network 192.168.78.0
    eigrp router-id 8.8.8.8
    no auto-summary
!         
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h1 id="MPLS-VPN配置步骤："><a href="#MPLS-VPN配置步骤：" class="headerlink" title="MPLS VPN配置步骤："></a>MPLS VPN配置步骤：</h1><ol>
<li>创建VRF（VRF名本地有效）：<ul>
<li>指定RD（提供全局唯一的私网单播地址）；</li>
<li>指定RT的导出（导出：把重分发进MP-BGP的VPNv4路由打上MP-BGP扩展团体属性RT）和导入（导入：把MP-BGP里的VPNv4路由进行RT的匹配，匹配成功的VPNv4路由将放进相应的VRF）；</li>
<li>将与CE相连的PE接口关联特定VRF；</li>
</ul>
</li>
<li>配置MP-BGP：<ul>
<li>配置建立PE之间的IBGP邻居关系；</li>
<li>启用VPNv4地址族（AF），并激活与其他PE设备的邻居关系；</li>
</ul>
</li>
<li>配置PE-CE路由；<ul>
<li>配置IGP，并启用IGP的地址族（AF）；</li>
<li>配置启用MP-BGP IPv4 VRF地址族，然后激活与其他PE路由器的MP-BGP IPv4 VRF邻居关系；</li>
</ul>
</li>
</ol>
<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1：不同的VPN站点之间使用的EIGRP-AS号相同；"><a href="#实验1：不同的VPN站点之间使用的EIGRP-AS号相同；" class="headerlink" title="实验1：不同的VPN站点之间使用的EIGRP AS号相同；"></a>实验1：不同的VPN站点之间使用的EIGRP AS号相同；</h2><h3 id="实验1拓扑"><a href="#实验1拓扑" class="headerlink" title="实验1拓扑:"></a>实验1拓扑:</h3><p><img src="/2014/MPLS_Lab_7/topo1.png"></p>
<h3 id="在PE上创建VRF"><a href="#在PE上创建VRF" class="headerlink" title="在PE上创建VRF"></a><strong>在PE上创建VRF</strong></h3><p>在PE1（R1）上创建VRF，并命名为A-Site1，表示该VRF为VPN A的站点1服务；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site1   </code></pre>

<p>指定RD，为1:1，如果按照AS：num命名法，以下RD表示AS1中的第2个VRF；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>

<p>指定RT的导入和导出，这里我将RT指定为导入和导出1：1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target <span class="token operator">?</span>        
    ASN<span class="token operator">:</span>nn or IP<span class="token operator">-</span>address<span class="token operator">:</span>nn  Target VPN Extended Community
    both                     Both import and export Target<span class="token operator">-</span>VPN community
    export                   Export Target<span class="token operator">-</span>VPN community
    import                   Import Target<span class="token operator">-</span>VPN community
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span></code></pre>

<p>将PE1（R1）上与CE相连的PE接口F0&#x2F;1关联到VRF A-Site1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site1
<span class="token operator">%</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span> IPv4 disabled and <span class="token function">address</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span> removed due to enabling VRF A<span class="token operator">-</span>Site1
    <span class="token comment">//切记先将接口关联VRF，然后再配置IP地址；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span></code></pre>
<p>在PE2（R4）上创建VRF，并命名为A-Site2，表示该VRF为VPN A的站点2服务；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site2

<span class="token comment">//指定RD，为1:2，如果按照AS：num命名法，以下RD表示AS1中的第2个VRF；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>

<span class="token comment">//指定RT的导入和导出，这里我将RT指定为导入和导出1：1；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>
<p>因为PE1导出的RT为1:1，PE2导入的RT正是PE1的导出RT1:1；所以PE1（R1）的RT导出和PE2（R4）的RT导入能够匹配成功，R4能够学到R1导入到MP-BGP中的VPNv4路由；又因为PE2导出的RT为1:2，PE1导入的RT正是PE2的导出RT1:2；所以PE2（R4）的RT导出和PE1（R1）的RT导入能够匹配成对，R1能够学到R4导入到MP-BGP中的VPNv4路由；</p>
<p>将PE2（R4）上与CE相连的PE接口F0&#x2F;1关联到VRF A-Site2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site2
<span class="token operator">%</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span> IPv4 disabled and <span class="token function">address</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span> removed due to enabling VRF A<span class="token operator">-</span>Site2
    <span class="token comment">//切记先将接口关联VRF，然后再配置IP地址；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span></code></pre>
<h3 id="配置MP-BGP"><a href="#配置MP-BGP" class="headerlink" title="配置MP-BGP"></a><strong>配置MP-BGP</strong></h3><p>在PE1（R1）上配置MP-BGP，使之与其他PE建立IBGP关系，在此实验中只有PE1和PE2两台PE设备；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no syn
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#bgp router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> update<span class="token operator">-</span>source l0
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self</code></pre>

<p>启用PE1（R1）的VPNv4地址族，并激活与IBGP邻居PE2（R4）的MP-BGP VPNv4邻居关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family vpnv4
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> activate
<span class="token comment">//激活与IBGP邻居R4的VPNv4关系；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community <span class="token operator">?</span>
    both      Send Standard and Extended Community attributes
    extended  Send Extended Community attribute
    standard  Send Standard Community attribute
    <span class="token operator">&lt;</span>cr<span class="token operator">></span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community both
<span class="token comment">//由于BGP团体属性为可选传递属性，所以必须手动指定R1向IBGP邻居R4发送拓展团体属性和标准团体属性；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token comment">//退出AF配置模式；</span></code></pre>
<p>在PE2（R4）上配置MP-BGP，使之与其他PE建立IBGP关系，</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no syn
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#bgp router<span class="token operator">-</span>id <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> update<span class="token operator">-</span>source l0
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self</code></pre>

<p>启用PE2（R4）的VPNv4地址族，并激活与IBGP邻居PE1（R1）的MP-BGP VPNv4邻居关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family vpnv4
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> activate
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> send<span class="token operator">-</span>community both</code></pre>
<h3 id="配置PE-CE路由"><a href="#配置PE-CE路由" class="headerlink" title="配置PE-CE路由"></a><strong>配置PE-CE路由</strong></h3><p>配置PE1（R1）的IGP；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary</code></pre>

<p>配置PE1（R1）的IGP地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 <span class="token operator">?</span>                   
    autonomous<span class="token operator">-</span>system  Specify Address<span class="token operator">-</span>Family Autonomous System Number
    <span class="token operator">&lt;</span>cr<span class="token operator">></span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 autonomous<span class="token operator">-</span>system <span class="token number">1</span>
<span class="token comment">//进入IGP EIGRP的AF模式，切记为EIGRP ipv4 vrf地址族（AF）指定一个EIGRP自治系统号；</span>
<span class="token comment">//由于在实施MPLS VPN，ISP和VPN客服站点本地可能就已经部署了EIGRP，并为EIGRP指定了不同的AS号,</span>
<span class="token comment">//而在实施MPLS VPN将PE和站点的CE连接起来的时候，由于PE和CE部署EIGRP时没有使用相同的AS号，</span>
<span class="token comment">//所以PE和CE无法建立EIGRP邻居关系；</span>
<span class="token comment">//为避免修改原始EIGRP的AS号，因此，在EIGRP的ipv4 vrf地址族（AF）里为PE和CE指定相同的EIGRP AS号；</span>

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token comment">//将IGP EIGRP的IPv4 VRF地址族（AF）关闭自动汇总；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> metric <span class="token number">10000</span> <span class="token number">100</span> <span class="token number">255</span> <span class="token number">1</span> <span class="token number">1500</span>
<span class="token comment">//必须指定Metric;</span>
<span class="token comment">//将MP-BGP中IPv4 VRF名字与IGP中IPv4 VRF名字相同的地址族（AF）重分布进IGP的IPv4 VRF AF；</span>
<span class="token comment">//IGP和MP-BGP中IPv4 VRF地址族（AF）实际上是执行相互重分发的操作；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.255</span> 
<span class="token comment">//将PE连接到CE的VRF接口宣告进IGP EIGRP进程的IPv4 VRF地址族中；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token comment">//退出IGP EIGRP的AF模式；</span></code></pre>
<p>配置PE1（R1）的MP-BGP IPv4 VRF地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
<span class="token comment">//进入MP-BGP的IPv4 VRF地址族（AF）；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute eigrp <span class="token number">1</span> 
<span class="token comment">//将IGP中IPv4 VRF名字与MP-BGP中IPv4 VRF名字相同的地址族（AF）重分布进MP-BGP的IPv4 VRF AF；</span>
<span class="token comment">//IGP和MP-BGP中IPv4 VRF地址族（AF）实际上是执行相互重分发的操作；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected 
<span class="token comment">//如果用户在CE路由器上ping远程网络的另一个VPN站点中的CE或C路由器，</span>
<span class="token comment">//为了使其在没有指定其源地址情况下（即默认使用CE路由器出站接口IP地址），Echo Reply包能够有路由并正常返回,</span>
<span class="token comment">//将PE路由器的直连路由重分布进MP-BGP的IPv4 VRF AF中；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family 
<span class="token comment">//退出MP-BGP的IPv4 VRF地址族（AF）模式；</span></code></pre>
<p>配置PE2（R4）的IGP；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary

<span class="token comment">//配置PE2（R4）的IGP地址族（AF）；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2 autonomous<span class="token operator">-</span>system <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> metric <span class="token number">10000</span> <span class="token number">100</span> <span class="token number">255</span> <span class="token number">1</span> <span class="token number">1500</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.255</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family


<span class="token comment">//配置PE2（R4）的MP-BGP IPv4 VRF地址族（AF）；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute eigrp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family</code></pre>
<h3 id="验证与调试："><a href="#验证与调试：" class="headerlink" title="验证与调试："></a>验证与调试：</h3><p>在VPN A站点1的C路由器R6上ping远程VPN A站点2的C路由器R8；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R6</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> p <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">132</span><span class="token operator">/</span><span class="token number">162</span><span class="token operator">/</span><span class="token number">232</span> ms
<span class="token comment">//成功！</span></code></pre>

<p>查看R1的IP BGP VPNv4路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp vpnv4 all
BGP table version is <span class="token number">86</span><span class="token punctuation">,</span> local router ID is <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
                                                                                
    Network          Next Hop            Metric LocPrf Weight Path
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> <span class="token punctuation">(</span><span class="token keyword">default</span> <span class="token keyword">for</span> vrf A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>        <span class="token number">156160</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>        <span class="token number">158720</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">156160</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i8<span class="token punctuation">.</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">158720</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>     <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.47</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>         <span class="token number">30720</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.78</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">4278221055</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">156160</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i8<span class="token punctuation">.</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">158720</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.47</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.78</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">4278221055</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span></code></pre>

<p>删除R1上ip vrf A-Site1的RT导入1：2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#no route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span></code></pre>

<p>查看R1的IP BGP VPNv4路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp vpnv4 all
BGP table version is <span class="token number">78</span><span class="token punctuation">,</span> local router ID is <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
                                                                                
    Network          Next Hop            Metric LocPrf Weight Path
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> <span class="token punctuation">(</span><span class="token keyword">default</span> <span class="token keyword">for</span> vrf A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>        <span class="token number">156160</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>        <span class="token number">158720</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>     <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>         <span class="token number">30720</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token comment">//关于RT1:2的VPNv4路由消失了！</span></code></pre>

<p>让R1再度导入RT1:2的VPNv4路由；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span></code></pre>

<p>查看R1的IP BGP VPNv4路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp vpnv4 all
BGP table version is <span class="token number">86</span><span class="token punctuation">,</span> local router ID is <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
                                                                                
    Network          Next Hop            Metric LocPrf Weight Path
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> <span class="token punctuation">(</span><span class="token keyword">default</span> <span class="token keyword">for</span> vrf A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>        <span class="token number">156160</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>        <span class="token number">158720</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">156160</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i8<span class="token punctuation">.</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">158720</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>     <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.47</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>         <span class="token number">30720</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.78</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">4278221055</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">156160</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i8<span class="token punctuation">.</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">158720</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.47</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.78</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">4278221055</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token comment">//关于RT1:2的VPNv4路由又回来了！</span></code></pre>
<p>将R1的EIGRP ip vrf A-Site1的AS号1改为2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 autonomous<span class="token operator">-</span>system <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 autonomous<span class="token operator">-</span>system <span class="token number">2</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#  redistribute bgp <span class="token number">1</span> metric <span class="token number">10000</span> <span class="token number">100</span> <span class="token number">255</span> <span class="token number">1</span> <span class="token number">1500</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#  network <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span># exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token comment">//仅仅修改AS号，其他配置都不变；</span></code></pre>


<p>查看EIGRP vrf A-Site1的邻居表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip eigrp vrf A<span class="token operator">-</span>Site1 neighbors 
EIGRP<span class="token operator">-</span>IPv4 Neighbors <span class="token keyword">for</span> <span class="token function">AS</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token function">VRF</span><span class="token punctuation">(</span>A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
<span class="token comment">//由于现在PE1的EIGRP ip vrf A-Site1的AS号为2，而CE1的EIGRP AS号为1，所以PE1和CE1无法建立EIGRP邻居；</span></code></pre>

<p>将配置修改回来；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 <span class="token keyword">auto</span> <span class="token number">2</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 <span class="token keyword">auto</span> <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> metric <span class="token number">10000</span> <span class="token number">100</span> <span class="token number">255</span> <span class="token number">1</span> <span class="token number">1500</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.255</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#exit
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">00.263</span><span class="token operator">:</span> <span class="token operator">%</span>DUAL<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHANGE<span class="token operator">:</span> EIGRP<span class="token operator">-</span>IPv4 <span class="token number">1</span><span class="token operator">:</span> Neighbor <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span> <span class="token punctuation">(</span>FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">)</span> is up<span class="token operator">:</span> new adjacency
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span># address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span># redistribute eigrp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#exit</code></pre>
<p>可以看到，PE1和CE1的EIGRP邻居关系又建立了！</p>
<h2 id="实验2：将R8配置为"><a href="#实验2：将R8配置为" class="headerlink" title="实验2：将R8配置为"></a>实验2：将R8配置为</h2><p>查看R1的IP BGP VPNv4路由表中关于前缀8.8.8.8&#x2F;32的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip bgp vpnv4 vrf A<span class="token operator">-</span>Site1 <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
BGP routing table entry <span class="token keyword">for</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> version <span class="token number">114</span>
Paths<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> available<span class="token punctuation">,</span> best #<span class="token number">1</span><span class="token punctuation">,</span> table A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
    Not advertised to any peer
    Local<span class="token punctuation">,</span> imported path from <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>
    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span>metric <span class="token number">4</span><span class="token punctuation">)</span> from <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">)</span>
        Origin incomplete<span class="token punctuation">,</span> metric <span class="token number">158720</span><span class="token punctuation">,</span> localpref <span class="token number">100</span><span class="token punctuation">,</span> valid<span class="token punctuation">,</span> internal<span class="token punctuation">,</span> best
        Extended Community<span class="token operator">:</span> RT<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span> Cost<span class="token operator">:</span>pre<span class="token operator">-</span>bestpath<span class="token operator">:</span><span class="token number">128</span><span class="token operator">:</span><span class="token number">158720</span> <span class="token number">0x8800</span><span class="token operator">:</span><span class="token number">32768</span><span class="token operator">:</span><span class="token number">0</span> 
        <span class="token number">0x8801</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">133120</span> <span class="token number">0x8802</span><span class="token operator">:</span><span class="token number">65282</span><span class="token operator">:</span><span class="token number">25600</span> <span class="token number">0x8803</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">1500</span> 
        <span class="token number">0x8806</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">134744072</span>
        mpls labels in<span class="token operator">/</span>out nolabel<span class="token operator">/</span><span class="token number">21</span></code></pre>

<p>为了在VPN A站点2 C2路由器R8上创造一条EIGRP外部路由，不使用network命令宣告Loopback0口，而通过将直连接口Loopback0重分发进EIGRP中；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#route<span class="token operator">-</span>map LOOPBACK permit <span class="token number">10</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#match interface loopback <span class="token number">0</span>

<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">1</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no network <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#redistribute connected route<span class="token operator">-</span>map LOOPBACK</code></pre>
<p>查看CE2（R7）的IP路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
                                                            
Gateway of last resort is not set
                                                            
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
D        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token operator">/</span><span class="token number">158720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
D        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token operator">/</span><span class="token number">161280</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
D EX     <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token punctuation">[</span><span class="token number">170</span><span class="token operator">/</span><span class="token number">156160</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">46</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
D     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token operator">/</span><span class="token number">30720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
D     <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token operator">/</span><span class="token number">33280</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//可以看到前缀8.8.8.8/32现在以EIGRP外部路由出现在了R7的路由表中；</span></code></pre>
<p>此时再来查看R1的IP BGP VPNv4路由表中关于前缀8.8.8.8&#x2F;32的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip bgp vpnv4 vrf A<span class="token operator">-</span>Site1 <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
BGP routing table entry <span class="token keyword">for</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> version <span class="token number">150</span>
Paths<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> available<span class="token punctuation">,</span> best #<span class="token number">1</span><span class="token punctuation">,</span> table A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
    Not advertised to any peer
    Local<span class="token punctuation">,</span> imported path from <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>
    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span>metric <span class="token number">4</span><span class="token punctuation">)</span> from <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">)</span>
        Origin incomplete<span class="token punctuation">,</span> metric <span class="token number">158720</span><span class="token punctuation">,</span> localpref <span class="token number">100</span><span class="token punctuation">,</span> valid<span class="token punctuation">,</span> internal<span class="token punctuation">,</span> best
        Extended Community<span class="token operator">:</span> RT<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span> Cost<span class="token operator">:</span>pre<span class="token operator">-</span>bestpath<span class="token operator">:</span><span class="token number">129</span><span class="token operator">:</span><span class="token number">158720</span> <span class="token number">0x8800</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">0</span> 
        <span class="token number">0x8801</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">133120</span> <span class="token number">0x8802</span><span class="token operator">:</span><span class="token number">65282</span><span class="token operator">:</span><span class="token number">25600</span> <span class="token number">0x8803</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">1500</span> 
        <span class="token number">0x8804</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">134744072</span> <span class="token number">0x8805</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">0</span> <span class="token number">0x8806</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">134744072</span>
        mpls labels in<span class="token operator">/</span>out nolabel<span class="token operator">/</span><span class="token number">26</span>
</code></pre>
<ul>
<li>此时R1的IP BGP VPNv4路由表中关于前缀8.8.8.8&#x2F;32的详细信息中拓展团体属性中多了消息类型0x8804和0x8805；</li>
<li>拓展团体属性中类型0x8804和0x8805的字段是VPNv4路由用来描述远程VPN站点EIGRP外部路由的；</li>
<li>仅当在远程站点的网络中该路由条目就已经是EIGRP外部路由时，</li>
<li>才会在VPNv4的扩展团体属性中携带类型0x8804和0x8805字段，来为此EIGRP外部路由进- 下面实验3中的场景则不会出现类型0x8804和0x8805字段；</li>
</ul>
<h2 id="实验3："><a href="#实验3：" class="headerlink" title="实验3："></a>实验3：</h2><h3 id="实验3拓扑："><a href="#实验3拓扑：" class="headerlink" title="实验3拓扑："></a>实验3拓扑：</h3><p><img src="/2014/MPLS_Lab_7/topo2.png"></p>
<p>修改VPN A站点2的EIGRP配置，将EIGRP的AS号从1改为2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#no router ei <span class="token number">1</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">2</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#eigrp router<span class="token operator">-</span>id <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no au

<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#no router ei <span class="token number">1</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">2</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no redistribute connected route<span class="token operator">-</span>map LOOPBACK
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#eigrp router<span class="token operator">-</span>id <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span></code></pre>
<p>修改PE2（R4）上EIGRP 1中的ipv4 vrf A-Site1地址族的AS号2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no address<span class="token operator">-</span>family ip vrf A<span class="token operator">-</span>Site2 autonomous<span class="token operator">-</span>system <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ip vrf A<span class="token operator">-</span>Site2 autonomous<span class="token operator">-</span>system <span class="token number">2</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> metric <span class="token number">10000</span> <span class="token number">100</span> <span class="token number">255</span> <span class="token number">1</span> <span class="token number">1500</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.255</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">58.047</span><span class="token operator">:</span> <span class="token operator">%</span>DUAL<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHANGE<span class="token operator">:</span> EIGRP<span class="token operator">-</span>IPv4 <span class="token number">2</span><span class="token operator">:</span> Neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> <span class="token punctuation">(</span>FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">)</span> is up<span class="token operator">:</span> new adjacency
<span class="token comment">//可以看到PE2和CE2的EIGRP邻居关系马上就恢复了；</span></code></pre>

<p>并将EIGRP 1 的<code>ipv4 vrf A-Site2 autonomous-system 2</code>地址族重分发进MP-BGP的ipv4 vrf A-Site2地址族中；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute eigrp <span class="token number">2</span></code></pre>

<h3 id="验证与调试：-1"><a href="#验证与调试：-1" class="headerlink" title="验证与调试："></a>验证与调试：</h3><p>在VPN A站点1的C路由器R6上ping远程VPN A站点2的C路由器R8；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R6</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> p <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">132</span><span class="token operator">/</span><span class="token number">162</span><span class="token operator">/</span><span class="token number">232</span> ms
<span class="token comment">//成功！</span></code></pre>

<p>查看C路由器R8的IP路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override

Gateway of last resort is not set

        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
D EX     <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">170</span><span class="token operator">/</span><span class="token number">286720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">06</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
D EX     <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token punctuation">[</span><span class="token number">170</span><span class="token operator">/</span><span class="token number">286720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">06</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
D        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token operator">/</span><span class="token number">156160</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> is directly connected<span class="token punctuation">,</span> Loopback0
D EX  <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">170</span><span class="token operator">/</span><span class="token number">286720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">06</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
D     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token operator">/</span><span class="token number">30720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
D EX  <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">170</span><span class="token operator">/</span><span class="token number">286720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">06</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//来自VPN A站点1的EIGRP路由变为EIGRP外部路由；</span></code></pre>

<p>此时再来查看R1的IP BGP VPNv4路由表中关于前缀8.8.8.8&#x2F;32的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip bgp vpnv4 vrf A<span class="token operator">-</span>Site1 <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
BGP routing table entry <span class="token keyword">for</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> version <span class="token number">164</span>
Paths<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> available<span class="token punctuation">,</span> best #<span class="token number">1</span><span class="token punctuation">,</span> table A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
    Not advertised to any peer
    Local<span class="token punctuation">,</span> imported path from <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>
    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span>metric <span class="token number">4</span><span class="token punctuation">)</span> from <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">)</span>
        Origin incomplete<span class="token punctuation">,</span> metric <span class="token number">158720</span><span class="token punctuation">,</span> localpref <span class="token number">100</span><span class="token punctuation">,</span> valid<span class="token punctuation">,</span> internal<span class="token punctuation">,</span> best
        Extended Community<span class="token operator">:</span> RT<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span> Cost<span class="token operator">:</span>pre<span class="token operator">-</span>bestpath<span class="token operator">:</span><span class="token number">128</span><span class="token operator">:</span><span class="token number">158720</span> <span class="token number">0x8800</span><span class="token operator">:</span><span class="token number">32768</span><span class="token operator">:</span><span class="token number">0</span> 
        <span class="token number">0x8801</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">133120</span> <span class="token number">0x8802</span><span class="token operator">:</span><span class="token number">65282</span><span class="token operator">:</span><span class="token number">25600</span> <span class="token number">0x8803</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">1500</span>
        <span class="token number">0x8806</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">134744072</span>
        mpls labels in<span class="token operator">/</span>out nolabel<span class="token operator">/</span><span class="token number">27</span></code></pre>
<p>即便现在R6上所有来自VPN A站点2的EIGRP路由都变为了EIGRP外部路由，但PE1（R1）收到的VPNv4路由则不会携带拓展团体属性类型0x8804和0x8805字段；因为R6上的这些EIGRP外部路由是由于EIGRP AS号不同而造成的，而这些路由在远程VPN A站点2中并不是EIGRP外部路由。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">filefi</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script size="300" alpha="0.45" zIndex="-1" src="/plugins/ribbon.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/comments.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/schemes/muse.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/next-boot.min.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/third-party/search/local-search.min.js"></script>





  





</body>
</html>
