<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ifelif.cn","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/config.min.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="正经人谁写日记">
<meta property="og:url" content="https://ifelif.cn/page/2/index.html">
<meta property="og:site_name" content="正经人谁写日记">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="filefi">
<meta property="article:tag" content="blog,javascript,nodejs,vue,python,C&#x2F;C++,golang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://ifelif.cn/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>正经人谁写日记</title>
  

  <script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/third-party/analytics/baidu-analytics.min.js"></script>
  <script async src="https://hm.baidu.com/hm.js?3f08a6c1407c206aa070325c05c2844d"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="正经人谁写日记" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">正经人谁写日记</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-专题"><a href="/topics/" rel="section"><i class="fa fa-book fa-fw"></i>专题</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="filefi"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">filefi</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">20</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/filefi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;filefi" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://filefi.github.io/" title="https:&#x2F;&#x2F;filefi.github.io" rel="noopener" target="_blank">github home page</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/filefi" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2022/cheat_engine_tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/cheat_engine_tutorial/" class="post-title-link" itemprop="url">CheatEngine Tutorial</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-16 21:41:21" itemprop="dateCreated datePublished" datetime="2022-02-16T21:41:21+08:00">2022-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-12 19:18:47" itemprop="dateModified" datetime="2022-06-12T19:18:47+08:00">2022-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PWN/" itemprop="url" rel="index"><span itemprop="name">PWN</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CheatEngine-Tutorial"><a href="#CheatEngine-Tutorial" class="headerlink" title="CheatEngine Tutorial"></a>CheatEngine Tutorial</h1><h2 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h2><p><img src="/2022/cheat_engine_tutorial/image-20220215145201605.png"></p>
<h3 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h3><pre class="language-text" data-language="text"><code class="language-text">Welcome to the Cheat Engine Tutorial (v3.6)

This tutorial will teach you the basics of cheating in video games. It will also show you foundational aspects of using Cheat Engine (or CE for short). Follow the steps below to get started.

1: Open Cheat Engine if it currently isn't running.
2: Click on the "Open Process" icon (it's the top-left icon with the computer on it, below "File".).
3: With the Process List window now open, look for this tutorial's process in the list. It will look something like "00001F98-Tutorial-x86_64.exe" or "0000047C-Tutorial-i386.exe". (The first 8 numbers/letters will probably be different.)
4: Once you've found the process, click on it to select it, then click the "Open" button. (Don't worry about all the other buttons right now. You can learn about them later if you're interested.)

Congratulations! If you did everything correctly, the process window should be gone with Cheat Engine now attached to the tutorial (you will see the process name towards the top-center of CE).

Click the "Next" button below to continue, or fill in the password and click the "OK" button to proceed to that step.)

If you're having problems, simply head over to forum.cheatengine.org, then click on "Tutorials" to view beginner-friendly guides!</code></pre>

<h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><h4 id="步骤1：选择要附加的进程"><a href="#步骤1：选择要附加的进程" class="headerlink" title="步骤1：选择要附加的进程"></a>步骤1：选择要附加的进程</h4><p><img src="/2022/cheat_engine_tutorial/image-20220215145836858.png"></p>
<p><img src="/2022/cheat_engine_tutorial/image-20220215150314077.png"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/cheat_engine_tutorial/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2017/BIG-IP-Local-Traffic-Manager-Concepts-v11-5-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/BIG-IP-Local-Traffic-Manager-Concepts-v11-5-0/" class="post-title-link" itemprop="url">BIG-IP Local Traffic Manager Concepts v11.5.0</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-11-30 11:30:15" itemprop="dateCreated datePublished" datetime="2017-11-30T11:30:15+08:00">2017-11-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-12 19:18:47" itemprop="dateModified" datetime="2022-06-12T19:18:47+08:00">2022-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/F5/" itemprop="url" rel="index"><span itemprop="name">F5</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>本文是 F5官方文档 <a target="_blank" rel="noopener" href="https://techdocs.f5.com/kb/en-us/products/big-ip_ltm/manuals/product/ltm-concepts-11-5-0.html">BIG-IP Local Traffic Manager Concepts v11.5.0</a> 的中文翻译版。初次于2017年11月30日发布在 <a target="_blank" rel="noopener" href="https://github.com/filefi/CN_BIG-IP_Local_Traffic_Manager_Concepts_v11.5.0">此repo</a>。</p>
</blockquote>
<h1 id="第1章-介绍本地流量管理器（Local-Traffic-Manager）"><a href="#第1章-介绍本地流量管理器（Local-Traffic-Manager）" class="headerlink" title="第1章 介绍本地流量管理器（Local Traffic Manager）"></a>第1章 介绍本地流量管理器（Local Traffic Manager）</h1><h2 id="1-1-什么是BIG-IP本地流量管理器？"><a href="#1-1-什么是BIG-IP本地流量管理器？" class="headerlink" title="1.1 什么是BIG-IP本地流量管理器？"></a>1.1 什么是BIG-IP本地流量管理器？</h2><p>BIG-IP本地流量管理（Local Traffic Manager）控制流入或流出局域网LAN（包括内联网intranet）的网络流量。</p>
<p>出于智能地调整网络服务器上负载的目的，LTM的一个常用功能是它拦截和重定向入站网络流量的能力。但是，调整服务器负载并不是唯一的本地流量管理方式。</p>
<p>LTM包含了各种功能，例如，执行检查和转换报头和内容数据，管理基于SSL证书的认证，以及压缩HTTP响应。这样做，BIG-IP系统不仅会定向流量到适合的服务器资源，而且还通过执行Web服务器通常执行的任务来增强了网络安全，并释放了服务器资源。</p>
<blockquote>
<p>注意： BIG-IP LTM是组成BIG-IP产品系列的几种产品之一。BIG-IP产品线中的所有产品都运行在强大的流量管理操作系统（Traffic Management Operating System）（通常称为TMOS）上。</p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2017/BIG-IP-Local-Traffic-Manager-Concepts-v11-5-0/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2017/BIG-IP-System-iRules-Concepts-v11-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/BIG-IP-System-iRules-Concepts-v11-6/" class="post-title-link" itemprop="url">BIG-IP System iRules Concepts v11.6</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-11-30 09:05:31" itemprop="dateCreated datePublished" datetime="2017-11-30T09:05:31+08:00">2017-11-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-12 19:18:47" itemprop="dateModified" datetime="2022-06-12T19:18:47+08:00">2022-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/F5/" itemprop="url" rel="index"><span itemprop="name">F5</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>本文是 F5官方文档 <a target="_blank" rel="noopener" href="https://support.f5.com/kb/en-us/products/big-ip_ltm/manuals/product/bigip-system-irules-concepts-11-6-0.html">BIG-IP System iRules Concepts v11.6</a> 的中文翻译版。初次于2017年11月30日发布在 <a target="_blank" rel="noopener" href="https://github.com/filefi/CN_BIG-IP_System_iRules_Concepts_v11.6">此repo</a>。</p>
</blockquote>
<h1 id="1-iRules介绍"><a href="#1-iRules介绍" class="headerlink" title="1 iRules介绍"></a>1 iRules介绍</h1><h2 id="什么是iRule"><a href="#什么是iRule" class="headerlink" title="什么是iRule"></a>什么是iRule</h2><p>iRule是BIG-IP本地流量管理器（LTM）中的一个强大而灵活的功能，你可以用它来管理你的网络流量。使用基于行业标准工具命令语言（Tcl）的语法，iRules功能不仅允许您根据报头数据（header data）选择Pools，还可以通过搜索您自定义的任何类型的内容数据来定向流量。因此，iRules功能显著地增强了您自定义内容交换（content switching）以适应您确切需求的能力。</p>
<blockquote>
<p>重要：有关iRules语法的完整和详细信息，请参阅F5 Networks DevCentral网站 <a target="_blank" rel="noopener" href="http://devcentral.f5.com.请注意,irules必须符合标准的tcl语法规则/">http://devcentral.f5.com。请注意，iRules必须符合标准的Tcl语法规则</a>; 因此，有关Tcl语法的更多信息，请参见 <a target="_blank" rel="noopener" href="http://tmml.sourceforge.net/doc/tcl/index.html%E3%80%82">http://tmml.sourceforge.net/doc/tcl/index.html。</a></p>
</blockquote>
<p>如果您想要单独的连接来命中（target）除为Virtual Server定义的默认Pool之外的Pool，则你就可以写这样一个iRule脚本。iRules允许您更直接地指定要将流量定向到你想要的目的地。使用iRules，您不仅可以将流量发送到Pool，还可以向单个Pool Member，端口或URI发送流量。您创建的iRules可以很简单，也可以很复杂，具体取决于您的内容交换（content-switching）需求。</p>
<pre class="language-tcl" data-language="tcl"><code class="language-tcl">when CLIENT_ACCEPTED <span class="token punctuation">&#123;</span>
    <span class="token builtin">if</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">[</span>IP::addr <span class="token punctuation">[</span>IP::client_addr<span class="token punctuation">]</span> equals 10.10.10.10<span class="token punctuation">]</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
        pool my_pool 
    <span class="token punctuation">&#125;</span> 
<span class="token punctuation">&#125;</span></code></pre>

<p>当客户端连接被接受时，这条iRule会被触发。这时，如果客户端的地址与 <code>10.10.10.10</code> 相匹配，将使得本地流量管理器（LTM）将数据包发送到my_pool池。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2017/BIG-IP-System-iRules-Concepts-v11-6/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_7/" class="post-title-link" itemprop="url">MPLS 实验7：MPLS VPN running EIGRP on the PE-CE link</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-14 22:48:51" itemprop="dateCreated datePublished" datetime="2014-03-14T22:48:51+08:00">2014-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>

<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="GNS3实验拓扑文件："><a href="#GNS3实验拓扑文件：" class="headerlink" title="GNS3实验拓扑文件："></a>GNS3实验拓扑文件：</h1><p><a href="topology.net">拓扑文件</a></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-none"><code class="language-none">hostname R1
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 1.1.1.1 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.1 255.255.255.0
    ip ospf 1 area 0
    no shut
    mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.15.1 255.255.255.0
    no shut
!
router ospf 1
    router-id 1.1.1.1
!         
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-none"><code class="language-none">hostname R2
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 2.2.2.2 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
    mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
    mpls ip
!
router ospf 1
    router-id 2.2.2.2
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R3"><a href="#R3" class="headerlink" title="R3:"></a>R3:</h2><pre class="language-none"><code class="language-none">hostname R3
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 3.3.3.3 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.3 255.255.255.0
    ip ospf 1 area 0
    no shutdown
    mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.3 255.255.255.0
    ip ospf 1 area 0
    no shutdown
    mpls ip
!
router ospf 1
    router-id 3.3.3.3
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R4"><a href="#R4" class="headerlink" title="R4:"></a>R4:</h2><pre class="language-none"><code class="language-none">hostname R4
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 4.4.4.4 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.4 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.47.4 255.255.255.0
    no shutdown
!
router ospf 1
    router-id 4.4.4.4
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R5"><a href="#R5" class="headerlink" title="R5:"></a>R5:</h2><pre class="language-none"><code class="language-none">hostname R5
!
ip cef
!
interface Loopback0
    ip address 5.5.5.5 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.56.5 255.255.255.0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.15.5 255.255.255.0
    no shutdown
!
router eigrp 1
    network 5.5.5.5 0.0.0.0
    network 192.168.15.5 0.0.0.0
    network 192.168.56.0
    eigrp router-id 5.5.5.5
    no auto-summary
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R6"><a href="#R6" class="headerlink" title="R6:"></a>R6:</h2><pre class="language-none"><code class="language-none">hostname R6
!
ip cef
!
interface Loopback0
    ip address 6.6.6.6 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.56.6 255.255.255.0
    no shutdown
!
router eigrp 1
    network 6.6.6.6 0.0.0.0
    network 192.168.56.0
    eigrp router-id 6.6.6.6
    no auto-summary
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R7"><a href="#R7" class="headerlink" title="R7:"></a>R7:</h2><pre class="language-none"><code class="language-none">hostname R7
!
ip cef
!
interface Loopback0
    ip address 7.7.7.7 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.78.7 255.255.255.0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.47.7 255.255.255.0
    no shutdown
!
router eigrp 1
    network 7.7.7.7 0.0.0.0
    network 192.168.47.0
    network 192.168.78.0
    eigrp router-id 7.7.7.7
    no auto-summary
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R8"><a href="#R8" class="headerlink" title="R8:"></a>R8:</h2><pre class="language-none"><code class="language-none">hostname R8
!
ip cef
!
interface Loopback0
    ip address 8.8.8.8 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.78.8 255.255.255.0
    no shutdown
!
router eigrp 1
    network 8.8.8.8 0.0.0.0
    network 192.168.78.0
    eigrp router-id 8.8.8.8
    no auto-summary
!         
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h1 id="MPLS-VPN配置步骤："><a href="#MPLS-VPN配置步骤：" class="headerlink" title="MPLS VPN配置步骤："></a>MPLS VPN配置步骤：</h1><ol>
<li>创建VRF（VRF名本地有效）：<ul>
<li>指定RD（提供全局唯一的私网单播地址）；</li>
<li>指定RT的导出（导出：把重分发进MP-BGP的VPNv4路由打上MP-BGP扩展团体属性RT）和导入（导入：把MP-BGP里的VPNv4路由进行RT的匹配，匹配成功的VPNv4路由将放进相应的VRF）；</li>
<li>将与CE相连的PE接口关联特定VRF；</li>
</ul>
</li>
<li>配置MP-BGP：<ul>
<li>配置建立PE之间的IBGP邻居关系；</li>
<li>启用VPNv4地址族（AF），并激活与其他PE设备的邻居关系；</li>
</ul>
</li>
<li>配置PE-CE路由；<ul>
<li>配置IGP，并启用IGP的地址族（AF）；</li>
<li>配置启用MP-BGP IPv4 VRF地址族，然后激活与其他PE路由器的MP-BGP IPv4 VRF邻居关系；</li>
</ul>
</li>
</ol>
<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1：不同的VPN站点之间使用的EIGRP-AS号相同；"><a href="#实验1：不同的VPN站点之间使用的EIGRP-AS号相同；" class="headerlink" title="实验1：不同的VPN站点之间使用的EIGRP AS号相同；"></a>实验1：不同的VPN站点之间使用的EIGRP AS号相同；</h2><h3 id="实验1拓扑"><a href="#实验1拓扑" class="headerlink" title="实验1拓扑:"></a>实验1拓扑:</h3><p><img src="/2014/MPLS_Lab_7/topo1.png"></p>
<h3 id="在PE上创建VRF"><a href="#在PE上创建VRF" class="headerlink" title="在PE上创建VRF"></a><strong>在PE上创建VRF</strong></h3><p>在PE1（R1）上创建VRF，并命名为A-Site1，表示该VRF为VPN A的站点1服务；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site1   </code></pre>

<p>指定RD，为1:1，如果按照AS：num命名法，以下RD表示AS1中的第2个VRF；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>

<p>指定RT的导入和导出，这里我将RT指定为导入和导出1：1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target <span class="token operator">?</span>        
    ASN<span class="token operator">:</span>nn or IP<span class="token operator">-</span>address<span class="token operator">:</span>nn  Target VPN Extended Community
    both                     Both import and export Target<span class="token operator">-</span>VPN community
    export                   Export Target<span class="token operator">-</span>VPN community
    import                   Import Target<span class="token operator">-</span>VPN community
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span></code></pre>

<p>将PE1（R1）上与CE相连的PE接口F0&#x2F;1关联到VRF A-Site1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site1
<span class="token operator">%</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span> IPv4 disabled and <span class="token function">address</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span> removed due to enabling VRF A<span class="token operator">-</span>Site1
    <span class="token comment">//切记先将接口关联VRF，然后再配置IP地址；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span></code></pre>
<p>在PE2（R4）上创建VRF，并命名为A-Site2，表示该VRF为VPN A的站点2服务；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site2

<span class="token comment">//指定RD，为1:2，如果按照AS：num命名法，以下RD表示AS1中的第2个VRF；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>

<span class="token comment">//指定RT的导入和导出，这里我将RT指定为导入和导出1：1；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target export <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>
<p>因为PE1导出的RT为1:1，PE2导入的RT正是PE1的导出RT1:1；所以PE1（R1）的RT导出和PE2（R4）的RT导入能够匹配成功，R4能够学到R1导入到MP-BGP中的VPNv4路由；又因为PE2导出的RT为1:2，PE1导入的RT正是PE2的导出RT1:2；所以PE2（R4）的RT导出和PE1（R1）的RT导入能够匹配成对，R1能够学到R4导入到MP-BGP中的VPNv4路由；</p>
<p>将PE2（R4）上与CE相连的PE接口F0&#x2F;1关联到VRF A-Site2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site2
<span class="token operator">%</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span> IPv4 disabled and <span class="token function">address</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span> removed due to enabling VRF A<span class="token operator">-</span>Site2
    <span class="token comment">//切记先将接口关联VRF，然后再配置IP地址；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span></code></pre>
<h3 id="配置MP-BGP"><a href="#配置MP-BGP" class="headerlink" title="配置MP-BGP"></a><strong>配置MP-BGP</strong></h3><p>在PE1（R1）上配置MP-BGP，使之与其他PE建立IBGP关系，在此实验中只有PE1和PE2两台PE设备；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no syn
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#bgp router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> update<span class="token operator">-</span>source l0
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self</code></pre>

<p>启用PE1（R1）的VPNv4地址族，并激活与IBGP邻居PE2（R4）的MP-BGP VPNv4邻居关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family vpnv4
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> activate
<span class="token comment">//激活与IBGP邻居R4的VPNv4关系；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community <span class="token operator">?</span>
    both      Send Standard and Extended Community attributes
    extended  Send Extended Community attribute
    standard  Send Standard Community attribute
    <span class="token operator">&lt;</span>cr<span class="token operator">></span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community both
<span class="token comment">//由于BGP团体属性为可选传递属性，所以必须手动指定R1向IBGP邻居R4发送拓展团体属性和标准团体属性；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token comment">//退出AF配置模式；</span></code></pre>
<p>在PE2（R4）上配置MP-BGP，使之与其他PE建立IBGP关系，</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no syn
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#bgp router<span class="token operator">-</span>id <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> update<span class="token operator">-</span>source l0
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self</code></pre>

<p>启用PE2（R4）的VPNv4地址族，并激活与IBGP邻居PE1（R1）的MP-BGP VPNv4邻居关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family vpnv4
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> activate
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> send<span class="token operator">-</span>community both</code></pre>
<h3 id="配置PE-CE路由"><a href="#配置PE-CE路由" class="headerlink" title="配置PE-CE路由"></a><strong>配置PE-CE路由</strong></h3><p>配置PE1（R1）的IGP；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary</code></pre>

<p>配置PE1（R1）的IGP地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 <span class="token operator">?</span>                   
    autonomous<span class="token operator">-</span>system  Specify Address<span class="token operator">-</span>Family Autonomous System Number
    <span class="token operator">&lt;</span>cr<span class="token operator">></span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 autonomous<span class="token operator">-</span>system <span class="token number">1</span>
<span class="token comment">//进入IGP EIGRP的AF模式，切记为EIGRP ipv4 vrf地址族（AF）指定一个EIGRP自治系统号；</span>
<span class="token comment">//由于在实施MPLS VPN，ISP和VPN客服站点本地可能就已经部署了EIGRP，并为EIGRP指定了不同的AS号,</span>
<span class="token comment">//而在实施MPLS VPN将PE和站点的CE连接起来的时候，由于PE和CE部署EIGRP时没有使用相同的AS号，</span>
<span class="token comment">//所以PE和CE无法建立EIGRP邻居关系；</span>
<span class="token comment">//为避免修改原始EIGRP的AS号，因此，在EIGRP的ipv4 vrf地址族（AF）里为PE和CE指定相同的EIGRP AS号；</span>

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token comment">//将IGP EIGRP的IPv4 VRF地址族（AF）关闭自动汇总；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> metric <span class="token number">10000</span> <span class="token number">100</span> <span class="token number">255</span> <span class="token number">1</span> <span class="token number">1500</span>
<span class="token comment">//必须指定Metric;</span>
<span class="token comment">//将MP-BGP中IPv4 VRF名字与IGP中IPv4 VRF名字相同的地址族（AF）重分布进IGP的IPv4 VRF AF；</span>
<span class="token comment">//IGP和MP-BGP中IPv4 VRF地址族（AF）实际上是执行相互重分发的操作；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.255</span> 
<span class="token comment">//将PE连接到CE的VRF接口宣告进IGP EIGRP进程的IPv4 VRF地址族中；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token comment">//退出IGP EIGRP的AF模式；</span></code></pre>
<p>配置PE1（R1）的MP-BGP IPv4 VRF地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
<span class="token comment">//进入MP-BGP的IPv4 VRF地址族（AF）；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute eigrp <span class="token number">1</span> 
<span class="token comment">//将IGP中IPv4 VRF名字与MP-BGP中IPv4 VRF名字相同的地址族（AF）重分布进MP-BGP的IPv4 VRF AF；</span>
<span class="token comment">//IGP和MP-BGP中IPv4 VRF地址族（AF）实际上是执行相互重分发的操作；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected 
<span class="token comment">//如果用户在CE路由器上ping远程网络的另一个VPN站点中的CE或C路由器，</span>
<span class="token comment">//为了使其在没有指定其源地址情况下（即默认使用CE路由器出站接口IP地址），Echo Reply包能够有路由并正常返回,</span>
<span class="token comment">//将PE路由器的直连路由重分布进MP-BGP的IPv4 VRF AF中；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family 
<span class="token comment">//退出MP-BGP的IPv4 VRF地址族（AF）模式；</span></code></pre>
<p>配置PE2（R4）的IGP；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary

<span class="token comment">//配置PE2（R4）的IGP地址族（AF）；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2 autonomous<span class="token operator">-</span>system <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> metric <span class="token number">10000</span> <span class="token number">100</span> <span class="token number">255</span> <span class="token number">1</span> <span class="token number">1500</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.255</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family


<span class="token comment">//配置PE2（R4）的MP-BGP IPv4 VRF地址族（AF）；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute eigrp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family</code></pre>
<h3 id="验证与调试："><a href="#验证与调试：" class="headerlink" title="验证与调试："></a>验证与调试：</h3><p>在VPN A站点1的C路由器R6上ping远程VPN A站点2的C路由器R8；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R6</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> p <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">132</span><span class="token operator">/</span><span class="token number">162</span><span class="token operator">/</span><span class="token number">232</span> ms
<span class="token comment">//成功！</span></code></pre>

<p>查看R1的IP BGP VPNv4路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp vpnv4 all
BGP table version is <span class="token number">86</span><span class="token punctuation">,</span> local router ID is <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
                                                                                
    Network          Next Hop            Metric LocPrf Weight Path
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> <span class="token punctuation">(</span><span class="token keyword">default</span> <span class="token keyword">for</span> vrf A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>        <span class="token number">156160</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>        <span class="token number">158720</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">156160</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i8<span class="token punctuation">.</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">158720</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>     <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.47</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>         <span class="token number">30720</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.78</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">4278221055</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">156160</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i8<span class="token punctuation">.</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">158720</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.47</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.78</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">4278221055</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span></code></pre>

<p>删除R1上ip vrf A-Site1的RT导入1：2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#no route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span></code></pre>

<p>查看R1的IP BGP VPNv4路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp vpnv4 all
BGP table version is <span class="token number">78</span><span class="token punctuation">,</span> local router ID is <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
                                                                                
    Network          Next Hop            Metric LocPrf Weight Path
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> <span class="token punctuation">(</span><span class="token keyword">default</span> <span class="token keyword">for</span> vrf A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>        <span class="token number">156160</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>        <span class="token number">158720</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>     <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>         <span class="token number">30720</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token comment">//关于RT1:2的VPNv4路由消失了！</span></code></pre>

<p>让R1再度导入RT1:2的VPNv4路由；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target import <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span></code></pre>

<p>查看R1的IP BGP VPNv4路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip bgp vpnv4 all
BGP table version is <span class="token number">86</span><span class="token punctuation">,</span> local router ID is <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete
                                                                                
    Network          Next Hop            Metric LocPrf Weight Path
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> <span class="token punctuation">(</span><span class="token keyword">default</span> <span class="token keyword">for</span> vrf A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>        <span class="token number">156160</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>        <span class="token number">158720</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">156160</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i8<span class="token punctuation">.</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">158720</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>     <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.47</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>         <span class="token number">30720</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.78</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">4278221055</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">156160</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i8<span class="token punctuation">.</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>             <span class="token number">158720</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.47</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.78</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">4278221055</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token comment">//关于RT1:2的VPNv4路由又回来了！</span></code></pre>
<p>将R1的EIGRP ip vrf A-Site1的AS号1改为2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 autonomous<span class="token operator">-</span>system <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 autonomous<span class="token operator">-</span>system <span class="token number">2</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#  redistribute bgp <span class="token number">1</span> metric <span class="token number">10000</span> <span class="token number">100</span> <span class="token number">255</span> <span class="token number">1</span> <span class="token number">1500</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#  network <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span># exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token comment">//仅仅修改AS号，其他配置都不变；</span></code></pre>


<p>查看EIGRP vrf A-Site1的邻居表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip eigrp vrf A<span class="token operator">-</span>Site1 neighbors 
EIGRP<span class="token operator">-</span>IPv4 Neighbors <span class="token keyword">for</span> <span class="token function">AS</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token function">VRF</span><span class="token punctuation">(</span>A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
<span class="token comment">//由于现在PE1的EIGRP ip vrf A-Site1的AS号为2，而CE1的EIGRP AS号为1，所以PE1和CE1无法建立EIGRP邻居；</span></code></pre>

<p>将配置修改回来；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 <span class="token keyword">auto</span> <span class="token number">2</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1 <span class="token keyword">auto</span> <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> metric <span class="token number">10000</span> <span class="token number">100</span> <span class="token number">255</span> <span class="token number">1</span> <span class="token number">1500</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.255</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#exit
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">00.263</span><span class="token operator">:</span> <span class="token operator">%</span>DUAL<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHANGE<span class="token operator">:</span> EIGRP<span class="token operator">-</span>IPv4 <span class="token number">1</span><span class="token operator">:</span> Neighbor <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span> <span class="token punctuation">(</span>FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">)</span> is up<span class="token operator">:</span> new adjacency
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span># address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span># redistribute eigrp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#exit</code></pre>
<p>可以看到，PE1和CE1的EIGRP邻居关系又建立了！</p>
<h2 id="实验2：将R8配置为"><a href="#实验2：将R8配置为" class="headerlink" title="实验2：将R8配置为"></a>实验2：将R8配置为</h2><p>查看R1的IP BGP VPNv4路由表中关于前缀8.8.8.8&#x2F;32的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip bgp vpnv4 vrf A<span class="token operator">-</span>Site1 <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
BGP routing table entry <span class="token keyword">for</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> version <span class="token number">114</span>
Paths<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> available<span class="token punctuation">,</span> best #<span class="token number">1</span><span class="token punctuation">,</span> table A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
    Not advertised to any peer
    Local<span class="token punctuation">,</span> imported path from <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>
    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span>metric <span class="token number">4</span><span class="token punctuation">)</span> from <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">)</span>
        Origin incomplete<span class="token punctuation">,</span> metric <span class="token number">158720</span><span class="token punctuation">,</span> localpref <span class="token number">100</span><span class="token punctuation">,</span> valid<span class="token punctuation">,</span> internal<span class="token punctuation">,</span> best
        Extended Community<span class="token operator">:</span> RT<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span> Cost<span class="token operator">:</span>pre<span class="token operator">-</span>bestpath<span class="token operator">:</span><span class="token number">128</span><span class="token operator">:</span><span class="token number">158720</span> <span class="token number">0x8800</span><span class="token operator">:</span><span class="token number">32768</span><span class="token operator">:</span><span class="token number">0</span> 
        <span class="token number">0x8801</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">133120</span> <span class="token number">0x8802</span><span class="token operator">:</span><span class="token number">65282</span><span class="token operator">:</span><span class="token number">25600</span> <span class="token number">0x8803</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">1500</span> 
        <span class="token number">0x8806</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">134744072</span>
        mpls labels in<span class="token operator">/</span>out nolabel<span class="token operator">/</span><span class="token number">21</span></code></pre>

<p>为了在VPN A站点2 C2路由器R8上创造一条EIGRP外部路由，不使用network命令宣告Loopback0口，而通过将直连接口Loopback0重分发进EIGRP中；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#route<span class="token operator">-</span>map LOOPBACK permit <span class="token number">10</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>route<span class="token operator">-</span>map<span class="token punctuation">)</span>#match interface loopback <span class="token number">0</span>

<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">1</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no network <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#redistribute connected route<span class="token operator">-</span>map LOOPBACK</code></pre>
<p>查看CE2（R7）的IP路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
                                                            
Gateway of last resort is not set
                                                            
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
D        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token operator">/</span><span class="token number">158720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
D        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token operator">/</span><span class="token number">161280</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
D EX     <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token punctuation">[</span><span class="token number">170</span><span class="token operator">/</span><span class="token number">156160</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">46</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
D     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token operator">/</span><span class="token number">30720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
D     <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token operator">/</span><span class="token number">33280</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//可以看到前缀8.8.8.8/32现在以EIGRP外部路由出现在了R7的路由表中；</span></code></pre>
<p>此时再来查看R1的IP BGP VPNv4路由表中关于前缀8.8.8.8&#x2F;32的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip bgp vpnv4 vrf A<span class="token operator">-</span>Site1 <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
BGP routing table entry <span class="token keyword">for</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> version <span class="token number">150</span>
Paths<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> available<span class="token punctuation">,</span> best #<span class="token number">1</span><span class="token punctuation">,</span> table A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
    Not advertised to any peer
    Local<span class="token punctuation">,</span> imported path from <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>
    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span>metric <span class="token number">4</span><span class="token punctuation">)</span> from <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">)</span>
        Origin incomplete<span class="token punctuation">,</span> metric <span class="token number">158720</span><span class="token punctuation">,</span> localpref <span class="token number">100</span><span class="token punctuation">,</span> valid<span class="token punctuation">,</span> internal<span class="token punctuation">,</span> best
        Extended Community<span class="token operator">:</span> RT<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span> Cost<span class="token operator">:</span>pre<span class="token operator">-</span>bestpath<span class="token operator">:</span><span class="token number">129</span><span class="token operator">:</span><span class="token number">158720</span> <span class="token number">0x8800</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">0</span> 
        <span class="token number">0x8801</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">133120</span> <span class="token number">0x8802</span><span class="token operator">:</span><span class="token number">65282</span><span class="token operator">:</span><span class="token number">25600</span> <span class="token number">0x8803</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">1500</span> 
        <span class="token number">0x8804</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">134744072</span> <span class="token number">0x8805</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">0</span> <span class="token number">0x8806</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">134744072</span>
        mpls labels in<span class="token operator">/</span>out nolabel<span class="token operator">/</span><span class="token number">26</span>
</code></pre>
<ul>
<li>此时R1的IP BGP VPNv4路由表中关于前缀8.8.8.8&#x2F;32的详细信息中拓展团体属性中多了消息类型0x8804和0x8805；</li>
<li>拓展团体属性中类型0x8804和0x8805的字段是VPNv4路由用来描述远程VPN站点EIGRP外部路由的；</li>
<li>仅当在远程站点的网络中该路由条目就已经是EIGRP外部路由时，</li>
<li>才会在VPNv4的扩展团体属性中携带类型0x8804和0x8805字段，来为此EIGRP外部路由进- 下面实验3中的场景则不会出现类型0x8804和0x8805字段；</li>
</ul>
<h2 id="实验3："><a href="#实验3：" class="headerlink" title="实验3："></a>实验3：</h2><h3 id="实验3拓扑："><a href="#实验3拓扑：" class="headerlink" title="实验3拓扑："></a>实验3拓扑：</h3><p><img src="/2014/MPLS_Lab_7/topo2.png"></p>
<p>修改VPN A站点2的EIGRP配置，将EIGRP的AS号从1改为2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#no router ei <span class="token number">1</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">2</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#eigrp router<span class="token operator">-</span>id <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span>
<span class="token function">R7</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no au

<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#no router ei <span class="token number">1</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">2</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no redistribute connected route<span class="token operator">-</span>map LOOPBACK
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#eigrp router<span class="token operator">-</span>id <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
<span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span></code></pre>
<p>修改PE2（R4）上EIGRP 1中的ipv4 vrf A-Site1地址族的AS号2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router eigrp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no address<span class="token operator">-</span>family ip vrf A<span class="token operator">-</span>Site2 autonomous<span class="token operator">-</span>system <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ip vrf A<span class="token operator">-</span>Site2 autonomous<span class="token operator">-</span>system <span class="token number">2</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> metric <span class="token number">10000</span> <span class="token number">100</span> <span class="token number">255</span> <span class="token number">1</span> <span class="token number">1500</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.255</span>
<span class="token operator">*</span>Mar <span class="token number">18</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">58.047</span><span class="token operator">:</span> <span class="token operator">%</span>DUAL<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHANGE<span class="token operator">:</span> EIGRP<span class="token operator">-</span>IPv4 <span class="token number">2</span><span class="token operator">:</span> Neighbor <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span> <span class="token punctuation">(</span>FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">)</span> is up<span class="token operator">:</span> new adjacency
<span class="token comment">//可以看到PE2和CE2的EIGRP邻居关系马上就恢复了；</span></code></pre>

<p>并将EIGRP 1 的<code>ipv4 vrf A-Site2 autonomous-system 2</code>地址族重分发进MP-BGP的ipv4 vrf A-Site2地址族中；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute eigrp <span class="token number">2</span></code></pre>

<h3 id="验证与调试：-1"><a href="#验证与调试：-1" class="headerlink" title="验证与调试："></a>验证与调试：</h3><p>在VPN A站点1的C路由器R6上ping远程VPN A站点2的C路由器R8；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R6</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> p <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">132</span><span class="token operator">/</span><span class="token number">162</span><span class="token operator">/</span><span class="token number">232</span> ms
<span class="token comment">//成功！</span></code></pre>

<p>查看C路由器R8的IP路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R8</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override

Gateway of last resort is not set

        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
D EX     <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">170</span><span class="token operator">/</span><span class="token number">286720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">06</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
D EX     <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token punctuation">[</span><span class="token number">170</span><span class="token operator">/</span><span class="token number">286720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">06</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
D        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token operator">/</span><span class="token number">156160</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> is directly connected<span class="token punctuation">,</span> Loopback0
D EX  <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">170</span><span class="token operator">/</span><span class="token number">286720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">06</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
D     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token operator">/</span><span class="token number">30720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
D EX  <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">170</span><span class="token operator">/</span><span class="token number">286720</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">06</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//来自VPN A站点1的EIGRP路由变为EIGRP外部路由；</span></code></pre>

<p>此时再来查看R1的IP BGP VPNv4路由表中关于前缀8.8.8.8&#x2F;32的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip bgp vpnv4 vrf A<span class="token operator">-</span>Site1 <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
BGP routing table entry <span class="token keyword">for</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> version <span class="token number">164</span>
Paths<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> available<span class="token punctuation">,</span> best #<span class="token number">1</span><span class="token punctuation">,</span> table A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
    Not advertised to any peer
    Local<span class="token punctuation">,</span> imported path from <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>
    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span>metric <span class="token number">4</span><span class="token punctuation">)</span> from <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">)</span>
        Origin incomplete<span class="token punctuation">,</span> metric <span class="token number">158720</span><span class="token punctuation">,</span> localpref <span class="token number">100</span><span class="token punctuation">,</span> valid<span class="token punctuation">,</span> internal<span class="token punctuation">,</span> best
        Extended Community<span class="token operator">:</span> RT<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span> Cost<span class="token operator">:</span>pre<span class="token operator">-</span>bestpath<span class="token operator">:</span><span class="token number">128</span><span class="token operator">:</span><span class="token number">158720</span> <span class="token number">0x8800</span><span class="token operator">:</span><span class="token number">32768</span><span class="token operator">:</span><span class="token number">0</span> 
        <span class="token number">0x8801</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">133120</span> <span class="token number">0x8802</span><span class="token operator">:</span><span class="token number">65282</span><span class="token operator">:</span><span class="token number">25600</span> <span class="token number">0x8803</span><span class="token operator">:</span><span class="token number">65281</span><span class="token operator">:</span><span class="token number">1500</span>
        <span class="token number">0x8806</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">134744072</span>
        mpls labels in<span class="token operator">/</span>out nolabel<span class="token operator">/</span><span class="token number">27</span></code></pre>
<p>即便现在R6上所有来自VPN A站点2的EIGRP路由都变为了EIGRP外部路由，但PE1（R1）收到的VPNv4路由则不会携带拓展团体属性类型0x8804和0x8805字段；因为R6上的这些EIGRP外部路由是由于EIGRP AS号不同而造成的，而这些路由在远程VPN A站点2中并不是EIGRP外部路由。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_6/" class="post-title-link" itemprop="url">MPLS 实验6：MPLS VPN running RIPv2 on the PE-CE link</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-14 22:47:51" itemprop="dateCreated datePublished" datetime="2014-03-14T22:47:51+08:00">2014-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>

<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="GNS3实验拓扑文件："><a href="#GNS3实验拓扑文件：" class="headerlink" title="GNS3实验拓扑文件："></a>GNS3实验拓扑文件：</h1><p><a href="topology.net">拓扑文件</a></p>
<h1 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h1><p><img src="/2014/MPLS_Lab_6/topo.png"></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-none"><code class="language-none">hostname R1
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 1.1.1.1 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.1 255.255.255.0
    ip ospf 1 area 0
    no shut
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.15.1 255.255.255.0
    no shut
!
router ospf 1
    router-id 1.1.1.1
!         
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-none"><code class="language-none">hostname R2
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 2.2.2.2 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
router ospf 1
    router-id 2.2.2.2
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R3"><a href="#R3" class="headerlink" title="R3:"></a>R3:</h2><pre class="language-none"><code class="language-none">hostname R3
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 3.3.3.3 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.3 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.3 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
router ospf 1
    router-id 3.3.3.3
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R4"><a href="#R4" class="headerlink" title="R4:"></a>R4:</h2><pre class="language-none"><code class="language-none">hostname R4
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 4.4.4.4 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.4 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.47.4 255.255.255.0
    no shutdown
!
router ospf 1
    router-id 4.4.4.4
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R5"><a href="#R5" class="headerlink" title="R5:"></a>R5:</h2><pre class="language-none"><code class="language-none">hostname R5
!
ip cef
!
interface Loopback0
    ip address 5.5.5.5 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.56.5 255.255.255.0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.15.5 255.255.255.0
    no shutdown
!
router rip
    version 2
    network 5.0.0.0
    network 192.168.15.0
    network 192.168.56.0
    no auto-summary
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R6"><a href="#R6" class="headerlink" title="R6:"></a>R6:</h2><pre class="language-none"><code class="language-none">hostname R6
!
ip cef
!
interface Loopback0
    ip address 6.6.6.6 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.56.6 255.255.255.0
    no shutdown
!
router rip
    version 2
    network 6.0.0.0
    network 192.168.56.0
    no auto-summary
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R7"><a href="#R7" class="headerlink" title="R7:"></a>R7:</h2><pre class="language-none"><code class="language-none">hostname R7
!
ip cef
!
interface Loopback0
    ip address 7.7.7.7 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.78.7 255.255.255.0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.47.7 255.255.255.0
    no shutdown
!
router rip
    version 2
    network 7.0.0.0
    network 192.168.47.0
    network 192.168.78.0
    no auto-summary
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R8"><a href="#R8" class="headerlink" title="R8:"></a>R8:</h2><pre class="language-none"><code class="language-none">hostname R8
!
ip cef
!
interface Loopback0
    ip address 8.8.8.8 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.78.8 255.255.255.0
    no shutdown
!
router rip
    version 2
    network 8.0.0.0
    network 192.168.78.0
    no auto-summary
!         
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>
<h1 id="MPLS-VPN配置步骤："><a href="#MPLS-VPN配置步骤：" class="headerlink" title="MPLS VPN配置步骤："></a>MPLS VPN配置步骤：</h1><ol>
<li>创建VRF（VRF名本地有效）：<ul>
<li>指定RD（提供全局唯一的私网单播地址）；</li>
<li>指定RT的导出（导出：把重分发进MP-BGP的VPNv4路由打上MP-BGP扩展团体属性RT）和导入（导入：把MP-BGP里的VPNv4路由进行RT的匹配，匹配成功的VPNv4路由将放进相应的VRF）；</li>
<li>将与CE相连的PE接口关联特定VRF；</li>
</ul>
</li>
<li>配置MP-BGP：<ul>
<li>配置建立PE之间的IBGP邻居关系；</li>
<li>启用VPNv4地址族（AF），并激活与其他PE设备的邻居关系；</li>
</ul>
</li>
<li>配置PE-CE路由；<ul>
<li>配置IGP，并启用IGP的地址族（AF）；</li>
<li>配置启用MP-BGP IPv4 VRF地址族，然后激活与其他PE路由器的MP-BGP IPv4 VRF邻居关系；</li>
</ul>
</li>
</ol>
<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1：配置MPLS-VPN"><a href="#实验1：配置MPLS-VPN" class="headerlink" title="实验1：配置MPLS VPN"></a>实验1：配置MPLS VPN</h2><h3 id="在PE上创建VRF"><a href="#在PE上创建VRF" class="headerlink" title="在PE上创建VRF"></a><strong>在PE上创建VRF</strong></h3><p>在PE1（R1）上创建VRF，并命名为A-Site1，表示该VRF为VPN A的站点1服务；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site1   </code></pre>

<p>指定RD，为1:1，如果按照AS：num命名法，以下RD表示AS1中的第2个VRF；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>

<p>指定RT的导入和导出，这里我将RT指定为导入和导出1：1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target <span class="token operator">?</span>        
    ASN<span class="token operator">:</span>nn or IP<span class="token operator">-</span>address<span class="token operator">:</span>nn  Target VPN Extended Community
    both                     Both import and export Target<span class="token operator">-</span>VPN community
    export                   Export Target<span class="token operator">-</span>VPN community
    import                   Import Target<span class="token operator">-</span>VPN community
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target both <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>

<p>将PE1（R1）上与CE相连的PE接口F0&#x2F;1关联到VRF A-Site1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site1
<span class="token operator">%</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span> IPv4 disabled and <span class="token function">address</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span> removed due to enabling VRF A<span class="token operator">-</span>Site1
<span class="token comment">//切记先将接口关联VRF，然后再配置IP地址；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span></code></pre>
<p>在PE2（R4）上创建VRF，并命名为A-Site2，表示该VRF为VPN A的站点2服务：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site2</code></pre>

<p>指定RD，为1:2，如果按照AS：num命名法，以下RD表示AS1中的第2个VRF；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span></code></pre>

<p>指定RT的导入和导出，这里我将RT指定为导入和导出1：1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target both <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>
<p>因为PE1导出的RT为1:1，PE2导入的RT正是PE1的导出RT1:1， 所以PE1（R1）的RT导出和PE2（R4）的RT导入能够匹配成功，R4能够学到R1导入到MP-BGP中的VPNv4路由；又因为PE2导出的RT为1:1，PE1导入的RT也正好是PE2的导出RT1:1；所以PE2（R4）的RT导出和PE1（R1）的RT导入能够匹配成对，R1能够学到R4导入到MP-BGP中的VPNv4路由。</p>
<p>将PE2（R4）上与CE相连的PE接口F0&#x2F;1关联到VRF A-Site2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site2
<span class="token operator">%</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span> IPv4 disabled and <span class="token function">address</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span> removed due to enabling VRF A<span class="token operator">-</span>Site2
<span class="token comment">//切记先将接口关联VRF，然后再配置IP地址；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span></code></pre>
<h3 id="配置MP-BGP；"><a href="#配置MP-BGP；" class="headerlink" title="配置MP-BGP；"></a><strong>配置MP-BGP；</strong></h3><p>在PE1（R1）上配置MP-BGP，使之与其他PE建立IBGP关系，在此实验中只有PE1和PE2两台PE设备；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no syn
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#bgp router<span class="token operator">-</span>id <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> update<span class="token operator">-</span>source l0
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self</code></pre>

<p>启用PE1（R1）的VPNv4地址族，并激活与IBGP邻居PE2（R4）的MP-BGP VPNv4邻居关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family vpnv4
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> activate
<span class="token comment">//激活与IBGP邻居R4的VPNv4关系；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community <span class="token operator">?</span>
    both      Send Standard and Extended Community attributes
    extended  Send Extended Community attribute
    standard  Send Standard Community attribute
    <span class="token operator">&lt;</span>cr<span class="token operator">></span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community both
<span class="token comment">//由于BGP团体属性为可选传递属性，所以必须手动指定R1向IBGP邻居R4发送拓展团体属性和标准团体属性；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token comment">//退出AF配置模式；</span></code></pre>
<p>在PE2（R4）上配置MP-BGP，使之与其他PE建立IBGP关系，</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no syn
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#bgp router<span class="token operator">-</span>id <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> update<span class="token operator">-</span>source l0
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self</code></pre>

<p>启用PE2（R4）的VPNv4地址族，并激活与IBGP邻居PE1（R1）的MP-BGP VPNv4邻居关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family vpnv4
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> activate
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> send<span class="token operator">-</span>community both</code></pre>
<h3 id="配置PE-CE路由；"><a href="#配置PE-CE路由；" class="headerlink" title="配置PE-CE路由；"></a><strong>配置PE-CE路由；</strong></h3><p>配置PE1（R1）的IGP；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router rip   
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#version <span class="token number">2</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary </code></pre>
<p>配置PE1（R1）的IGP地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//进入IGP RIP的AF模式；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 <span class="token operator">?</span>
    unicast  Address Family Modifier
    vrf      Specify parameters <span class="token keyword">for</span> a VPN Routing<span class="token operator">/</span>Forwarding instance
    <span class="token operator">&lt;</span>cr<span class="token operator">></span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#version <span class="token number">2</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token comment">//将IGP RIP的IPv4 VRF地址族（AF）配置为RIPv2,并关闭自动汇总；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> metric <span class="token operator">?</span>
    <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">16</span><span class="token operator">></span>       Default metric
    transparent  Transparently redistribute metric
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> metric transparent 
<span class="token comment">// 关键字transparent表示透传，RIP将不会察觉到MPLS VPN的存在；</span>
<span class="token comment">//必须指定Metric否则没有BGP能被重分布进RIP;</span>
<span class="token comment">//将MP-BGP中IPv4 VRF名字与IGP中IPv4 VRF名字相同的地址族（AF）重分布进IGP的IPv4 VRF AF；</span>
<span class="token comment">//IGP和MP-BGP中IPv4 VRF地址族（AF）实际上是执行相互重分发的操作；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span> 
<span class="token comment">//将PE连接到CE的VRF接口宣告进IGP进程的IPv4 VRF地址族中；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token comment">//退出IGP RIP的AF模式；</span></code></pre>
<p>配置PE1（R1）的MP-BGP IPv4 VRF地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token comment">//进入MP-BGP的IPv4 VRF地址族（AF）；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute rip 
<span class="token comment">//将IGP中IPv4 VRF名字与MP-BGP中IPv4 VRF名字相同的地址族（AF）重分布进MP-BGP的IPv4 VRF AF；</span>
<span class="token comment">//IGP和MP-BGP中IPv4 VRF地址族（AF）实际上是执行相互重分发的操作；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected 
<span class="token comment">//如果用户在CE路由器上ping远程网络的另一个VPN站点中的CE或C路由器，</span>
<span class="token comment">//为了使其在没有指定其源地址情况下（即默认使用CE路由器出站接口IP地址），Echo Reply包能够有路由并正常返回,</span>
<span class="token comment">//将PE路由器的直连路由重分布进MP-BGP的IPv4 VRF AF中；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family 
<span class="token comment">//退出MP-BGP的IPv4 VRF地址族（AF）模式；</span></code></pre>
<p>配置PE2（R4）的IGP；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router rip
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#version <span class="token number">2</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary</code></pre>

<p>配置PE2（R4）的IGP地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#version <span class="token number">2</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#no <span class="token keyword">auto</span><span class="token operator">-</span>summary
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute bgp <span class="token number">1</span> metric transparent
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#network <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family</code></pre>
<p>配置PE2（R4）的MP-BGP IPv4 VRF地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute rip
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family</code></pre>
<h1 id="验证与调试："><a href="#验证与调试：" class="headerlink" title="验证与调试："></a>验证与调试：</h1><p>以ping 8.8.8.8的ICMP包转发交换过程为例，验证并解释MPLS VPN中数据包交换过程；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//在VPN A站点1的C路由器R6上ping远程VPN A站点2的C路由器R8；</span>
R6#ping <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">132</span><span class="token operator">/</span><span class="token number">160</span><span class="token operator">/</span><span class="token number">196</span> ms
<span class="token comment">//成功！</span></code></pre>


<p>VPN A站点1的C路由器R6在发送ICMP echo Request数据包之前查看IP路由表，准确的说不是查看路由表，而是CEF表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R6#sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
                                                            
Gateway of last resort is not set
                                                            
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
R        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">08</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
R        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">08</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
R        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">08</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
R     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">08</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
R     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">08</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
R     <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">08</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//R6有关于8.8.8.8/32的路由条目，并且是通过RIP从R5学到的；</span>
<span class="token comment">//R6将数据包转发给R5；</span></code></pre>

<p>此时Echo Request包达到R5，查看R5的IP路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R5#sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
                                                            
Gateway of last resort is not set
                                                            
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
R        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
R        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
R        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
R     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
R     <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token comment">//R5发现自己拥有关于8.8.8.8/32的路由条目，并且此路由条目是通过RIP从PE1（R1）学到的；</span>
<span class="token comment">//R5将数据包转发给PE1（R1）；</span></code></pre>

<p><strong>此时Echo Request包抵达PE1（R1）；</strong></p>
<p>由于从R5转发来的ping包是在接口F0&#x2F;1上收到的，而此接口又与VRF A-Site1相关联，所以PE1需要查看IP vrf A-Site1路由表；准确的说也不是查看IP vrf A-Site1路由表，而是查看IP CEF vrf A-Site1表，但毕竟CEF表来自于路由表，这里只是为了说明选路的依据；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show ip route vrf A<span class="token operator">-</span>Site1

Routing Table<span class="token operator">:</span> A<span class="token operator">-</span>Site1
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override

Gateway of last resort is not set

        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
R        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">04</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">6.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
R        <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">04</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">04</span>
        <span class="token number">8.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">04</span>
        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
B     <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">04</span>
R     <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">04</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
B     <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> via <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">04</span></code></pre>

<p>PE1（R1）发现自己拥有关于8.8.8.8&#x2F;32的路由条目，并且此路由条目是通过IBGP从R4（PE2）学到的；与纯MPLS网络中一样，去往8.8.8.8&#x2F;32的路由需要递归查找明确的下一跳；要达到8.8.8.8&#x2F;32必须先到达4.4.4.4&#x2F;32，因为4.4.4.4&#x2F;32不是VPNv4路由，所以4.4.4.4&#x2F;32的路由存在于普通IP路由表中；</p>
<p>因而要达到4.4.4.4&#x2F;32就必须查看普通IP路由表：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
                                                            
Gateway of last resort is not set
                                                            
        <span class="token number">1.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">2.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">02</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">3.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">02</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">02</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
O     <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">02</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
O     <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">02</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span></code></pre>
<p>要去往4.4.4.4&#x2F;32就必须到达192.168.12.2，至此PE1发现了关于8.8.8.8&#x2F;32明确的下一跳；</p>
<p>由于关于8.8.8.8&#x2F;32的BGP路由器条目是一条VPNv4路由，所以查看PE1的IP BGP VPNv4表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show ip bgp vpnv4 all
BGP table version is <span class="token number">13</span><span class="token punctuation">,</span> local router ID is <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
Status codes<span class="token operator">:</span> s suppressed<span class="token punctuation">,</span> d damped<span class="token punctuation">,</span> h history<span class="token punctuation">,</span> <span class="token operator">*</span> valid<span class="token punctuation">,</span> <span class="token operator">></span> best<span class="token punctuation">,</span> i <span class="token operator">-</span> internal<span class="token punctuation">,</span>
                r RIB<span class="token operator">-</span>failure<span class="token punctuation">,</span> S Stale<span class="token punctuation">,</span> m multipath<span class="token punctuation">,</span> b backup<span class="token operator">-</span>path<span class="token punctuation">,</span> x best<span class="token operator">-</span>external<span class="token punctuation">,</span> f RT<span class="token operator">-</span>Filter
Origin codes<span class="token operator">:</span> i <span class="token operator">-</span> IGP<span class="token punctuation">,</span> e <span class="token operator">-</span> EGP<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token operator">-</span> incomplete

    Network          Next Hop            Metric LocPrf Weight Path
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> <span class="token punctuation">(</span><span class="token keyword">default</span> <span class="token keyword">for</span> vrf A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>             <span class="token number">1</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>             <span class="token number">2</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">1</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i8<span class="token punctuation">.</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">2</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span>     <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>                  <span class="token number">0</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.47</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span> <span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.0</span>     <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span>             <span class="token number">1</span>         <span class="token number">32768</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.78</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">1</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
Route Distinguisher<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token operator">*</span><span class="token operator">></span>i7<span class="token punctuation">.</span><span class="token number">7.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">1</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i8<span class="token punctuation">.</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">2</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.47</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">0</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span>
<span class="token operator">*</span><span class="token operator">></span>i192<span class="token punctuation">.</span><span class="token number">168.78</span><span class="token number">.0</span>     <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>                  <span class="token number">1</span>    <span class="token number">100</span>      <span class="token number">0</span> <span class="token operator">?</span></code></pre>

<p>查看PE1的IP BGP VPNv4表明细路由；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show ip bgp vpnv4 rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
BGP routing table entry <span class="token keyword">for</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> version <span class="token number">11</span>
Paths<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> available<span class="token punctuation">,</span> best #<span class="token number">1</span><span class="token punctuation">,</span> table A<span class="token operator">-</span>Site1<span class="token punctuation">)</span>
    Not advertised to any peer
    Local<span class="token punctuation">,</span> imported path from <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>
    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span>metric <span class="token number">4</span><span class="token punctuation">)</span> from <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">)</span>
        Origin incomplete<span class="token punctuation">,</span> metric <span class="token number">2</span><span class="token punctuation">,</span> localpref <span class="token number">100</span><span class="token punctuation">,</span> valid<span class="token punctuation">,</span> internal<span class="token punctuation">,</span> best
        Extended Community<span class="token operator">:</span> RT<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        mpls labels in<span class="token operator">/</span>out nolabel<span class="token operator">/</span><span class="token number">22</span><span class="token comment">//标签22是远程PE2（R4）MP-BGP通告的VPNv4路由中包含的VPNv4标签，此标签被用作MPLS VPN的栈底标签；</span>

R1#show ip bgp vpnv4 rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span> <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
BGP routing table entry <span class="token keyword">for</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> version <span class="token number">7</span>
Paths<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> available<span class="token punctuation">,</span> best #<span class="token number">1</span><span class="token punctuation">,</span> no table<span class="token punctuation">)</span>
    Not advertised to any peer
    Local
    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span>metric <span class="token number">4</span><span class="token punctuation">)</span> from <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">(</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">)</span>
        Origin incomplete<span class="token punctuation">,</span> metric <span class="token number">2</span><span class="token punctuation">,</span> localpref <span class="token number">100</span><span class="token punctuation">,</span> valid<span class="token punctuation">,</span> internal<span class="token punctuation">,</span> best
        Extended Community<span class="token operator">:</span> RT<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
        mpls labels in<span class="token operator">/</span>out nolabel<span class="token operator">/</span><span class="token number">22</span><span class="token comment">//标签22是远程PE2（R4）MP-BGP通告的VPNv4路由中包含的VPNv4标签，此标签被用作MPLS VPN的栈底标签；</span></code></pre>

<p>查看LFIB表中关于8.8.8.8&#x2F;32的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show mpls forwarding<span class="token operator">-</span>table vrf A<span class="token operator">-</span>Site1 <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> detail
Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
Label      Label      or Tunnel Id     Switched      interface              
None       <span class="token number">22</span>         <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">[</span>V<span class="token punctuation">]</span>    <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        MAC<span class="token operator">/</span>Encaps<span class="token operator">=</span><span class="token number">14</span><span class="token operator">/</span><span class="token number">22</span><span class="token punctuation">,</span> MRU<span class="token operator">=</span><span class="token number">1496</span><span class="token punctuation">,</span> Label Stack<span class="token punctuation">&#123;</span><span class="token number">17</span> <span class="token number">22</span><span class="token punctuation">&#125;</span> <span class="token comment">//标签栈中有两个标签，标签17用于在AS1中转发数据，栈底标签22为VPNv4标签；</span>
        CA0518300008CA04183000088847 <span class="token number">0001100000016000</span>
        VPN route<span class="token operator">:</span> A<span class="token operator">-</span>Site1
        No output feature configured</code></pre>

<p>知道了前缀8.8.8.8&#x2F;32的递归下一跳之后，沿递归路径查看每一跳的标签信息；查看PE1的IP CEF VRF A-Site1表中8.8.8.8的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip cef vrf A<span class="token operator">-</span>Site1 <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> detail
<span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> epoch <span class="token number">0</span><span class="token punctuation">,</span> flags rib defined all labels
    recursive via <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> label <span class="token number">22</span><span class="token comment">//标签22为栈底的VPNv4标签；</span>
    nexthop <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span> label <span class="token number">17</span><span class="token comment">//8.8.8.8/32递归"继承了"4.4.4.4的标签17；</span></code></pre>

<p>查看PE1（R1）的IP CEF表中4.4.4.4的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip cef <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> detail
<span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> epoch <span class="token number">0</span>
    local label info<span class="token operator">:</span> global<span class="token operator">/</span><span class="token number">18</span>
    <span class="token number">1</span> RR source <span class="token punctuation">[</span>no flags<span class="token punctuation">]</span>
    nexthop <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span> label <span class="token number">17</span>
<span class="token comment">//标签17为PE1（R1）关于前缀4.4.4.4/32的出站标签，也就是R2通告给R1的入站标签；</span></code></pre>

<p>查看PE1（R1）的IP CEF表中192.168.12.2的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show ip cef <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> detail
<span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> epoch <span class="token number">0</span><span class="token punctuation">,</span> flags attached
    Adj source<span class="token operator">:</span> IP adj out of FastEthernet0<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span> addr <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> <span class="token number">6819</span>D980
    Dependent covered prefix type adjfib cover <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
    attached to FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//由于R1与192.168.12.0/24直连，所以不再需要在进行标签转发，所以R1没有关于192.168.12.0/24的出标签；</span></code></pre>

<p>至此，PE1（R1）为数据包打上出标签17，并将数据转发给R2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//此时ping包抵达R2；</span>
<span class="token comment">//查看R2的LFIB表；</span>
R2#show mpls forwarding<span class="token operator">-</span>table
Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
Label      Label      or Tunnel Id     Switched      interface              
<span class="token number">16</span>         Pop Label  <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">20757</span>         Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span>
<span class="token number">17</span>         <span class="token number">16</span>         <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">22341</span>         Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span>
<span class="token number">18</span>         Pop Label  <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span>
<span class="token number">19</span>         Pop Label  <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>  <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span></code></pre>
<p>在收到R1转发来的带有R2本地标签17的数据包后，R2使用为数据包打上出标签16，并将其转发给R3；</p>
<p><strong>注意：递归查找路由表只会发生在运行BGP并与其他PE路由器建立IBGP关系的PE路由器，而在P路由器上，由于没有运行BGP，不可能有相关路由信息，所以只按照标签转发。</strong></p>
<p>此时ping包抵达R3；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//查看R3的LFIB表；</span>
R3#show mpls forwarding<span class="token operator">-</span>table
Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
Label      Label      or Tunnel Id     Switched      interface              
<span class="token number">16</span>         Pop Label  <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">27288</span>         Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span>
<span class="token number">17</span>         Pop Label  <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span>
<span class="token number">18</span>         <span class="token number">16</span>         <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">29345</span>         Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span>
<span class="token number">19</span>         Pop Label  <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>  <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span>
<span class="token comment">//R3弹出栈顶标签，并将数据转发给PE2（R4）；</span></code></pre>

<p>此时ping包抵达PE2（R4），由于数据中栈顶的标签被弹出，所以原本栈底的VPNv4标签就变成了栈顶标签；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//查看PE2（R4）的LFIB表；</span>
R4#show mpls forwarding<span class="token operator">-</span>table
Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
Label      Label      or Tunnel Id     Switched      interface              
<span class="token number">16</span>         Pop Label  <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">17</span>         Pop Label  <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>  <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">18</span>         <span class="token number">17</span>         <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">19</span>         <span class="token number">18</span>         <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">20</span>         <span class="token number">19</span>         <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>  <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">21</span>         No Label   <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">[</span>V<span class="token punctuation">]</span>    <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span>
<span class="token number">22</span>         No Label   <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">[</span>V<span class="token punctuation">]</span>    <span class="token number">570</span>           Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span>
<span class="token number">23</span>         No Label   <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">[</span>V<span class="token punctuation">]</span>   \
                                        <span class="token number">0</span>             aggregate<span class="token operator">/</span>A<span class="token operator">-</span>Site2 
<span class="token number">24</span>         No Label   <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">[</span>V<span class="token punctuation">]</span>   \
                                        <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span></code></pre>
<p>R4收到携带VPNv4标签22的Echo Request数据后，移除Echo Request数据的标签栈，将其转发给R7。</p>
<p>数据到达R7后，按照正常的转发方式被转发到R8。</p>
<pre class="language-c" data-language="c"><code class="language-c">R7#show ip route <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span>
Routing entry <span class="token keyword">for</span> <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span>
    Known via <span class="token string">"rip"</span><span class="token punctuation">,</span> distance <span class="token number">120</span><span class="token punctuation">,</span> metric <span class="token number">1</span>
    Redistributing via rip
    Last update from <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.8</span> on FastEthernet0<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">07</span> ago
    Routing Descriptor Blocks<span class="token operator">:</span>
    <span class="token operator">*</span> <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.8</span><span class="token punctuation">,</span> from <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">07</span> ago<span class="token punctuation">,</span> via FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        Route metric is <span class="token number">1</span><span class="token punctuation">,</span> traffic share count is <span class="token number">1</span>
R7#show ip cef <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> detail 
<span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> epoch <span class="token number">0</span>
    nexthop <span class="token number">192.168</span><span class="token number">.78</span><span class="token number">.8</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span></code></pre>

<p>最终，ICMP Echo Request达到了R8，返回R6的ICMP Echo Reply的方向相反，但是过程和操作是一样的。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_5/" class="post-title-link" itemprop="url">MPLS 实验5：MPLS VPN using Static Routing on the PE-CE link</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-14 22:46:51" itemprop="dateCreated datePublished" datetime="2014-03-14T22:46:51+08:00">2014-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>

<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="GNS3实验拓扑文件："><a href="#GNS3实验拓扑文件：" class="headerlink" title="GNS3实验拓扑文件："></a>GNS3实验拓扑文件：</h1><p><a href="topology.net">拓扑文件</a></p>
<h1 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h1><p><img src="/2014/MPLS_Lab_5/topo.png"></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-none"><code class="language-none">hostname R1
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 1.1.1.1 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.1 255.255.255.0
    ip ospf 1 area 0
    no shut
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.15.1 255.255.255.0
    no shut
!
router ospf 1
    router-id 1.1.1.1
!         
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-none"><code class="language-none">hostname R2
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 2.2.2.2 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
router ospf 1
    router-id 2.2.2.2
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R3"><a href="#R3" class="headerlink" title="R3:"></a>R3:</h2><pre class="language-none"><code class="language-none">hostname R3
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 3.3.3.3 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.3 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.3 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
router ospf 1
    router-id 3.3.3.3
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R4"><a href="#R4" class="headerlink" title="R4:"></a>R4:</h2><pre class="language-none"><code class="language-none">hostname R4
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 4.4.4.4 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.4 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.47.4 255.255.255.0
    no shutdown
!
router ospf 1
    router-id 4.4.4.4
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R5"><a href="#R5" class="headerlink" title="R5:"></a>R5:</h2><pre class="language-none"><code class="language-none">hostname R5
!
ip cef
!
interface Loopback0
    ip address 5.5.5.5 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.56.5 255.255.255.0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.15.5 255.255.255.0
    no shutdown
!
ip route 6.6.6.6 255.255.255.255 192.168.56.6
ip route 0.0.0.0 0.0.0.0 192.168.15.1
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R6"><a href="#R6" class="headerlink" title="R6:"></a>R6:</h2><pre class="language-none"><code class="language-none">hostname R6
!
ip cef
!
interface Loopback0
    ip address 6.6.6.6 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.56.6 255.255.255.0
    no shutdown
!
ip route 0.0.0.0 0.0.0.0 192.168.56.5
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R7"><a href="#R7" class="headerlink" title="R7:"></a>R7:</h2><pre class="language-none"><code class="language-none">hostname R7
!
ip cef
!
interface Loopback0
    ip address 7.7.7.7 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.78.7 255.255.255.0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.47.7 255.255.255.0
    no shutdown
!
ip route 0.0.0.0 0.0.0.0 192.168.47.4
ip route 8.8.8.8 255.255.255.255 192.168.78.8
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R8"><a href="#R8" class="headerlink" title="R8:"></a>R8:</h2><pre class="language-none"><code class="language-none">hostname R8
!
ip cef
!
interface Loopback0
    ip address 8.8.8.8 255.255.255.255
!
interface FastEthernet0&#x2F;0
    ip address 192.168.78.8 255.255.255.0
    no shutdown
!
ip route 0.0.0.0 0.0.0.0 192.168.78.7
!         
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>
<h1 id="MPLS-VPN配置步骤："><a href="#MPLS-VPN配置步骤：" class="headerlink" title="MPLS VPN配置步骤："></a>MPLS VPN配置步骤：</h1><ol>
<li>创建VRF（VRF名本地有效）：<ul>
<li>指定RD（提供全局唯一的私网单播地址）；</li>
<li>指定RT的导出（导出：把重分发进MP-BGP的VPNv4路由打上MP-BGP扩展团体属性RT）和导入（导入：把MP-BGP里的VPNv4路由进行RT的匹配，匹配成功的VPNv4路由将放进相应的VRF）；</li>
<li>将与CE相连的PE接口关联特定VRF；</li>
</ul>
</li>
<li>配置MP-BGP：<ul>
<li>配置建立PE之间的IBGP邻居关系；</li>
<li>启用VPNv4地址族（AF），并激活与其他PE设备的邻居关系；</li>
</ul>
</li>
<li>配置PE-CE路由；<ul>
<li>配置IGP，并启用IGP的地址族（AF）；</li>
<li>配置启用MP-BGP IPv4 VRF地址族，然后激活与其他PE路由器的MP-BGP IPv4 VRF邻居关系；</li>
</ul>
</li>
</ol>
<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1：配置MPLS-VPN"><a href="#实验1：配置MPLS-VPN" class="headerlink" title="实验1：配置MPLS VPN"></a>实验1：配置MPLS VPN</h2><h3 id="在PE上创建VRF"><a href="#在PE上创建VRF" class="headerlink" title="在PE上创建VRF"></a><strong>在PE上创建VRF</strong></h3><p>在PE1（R1）上创建VRF，并命名为A-Site1，表示该VRF为VPN A的站点1服务；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site1   
```            

指定RD，为<span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>，如果按照AS：num命名法，以下RD表示AS1中的第<span class="token number">2</span>个VRF；
```c
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>

<p>指定RT的导入和导出，这里我将RT指定为导入和导出1：1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target <span class="token operator">?</span>        
    ASN<span class="token operator">:</span>nn or IP<span class="token operator">-</span>address<span class="token operator">:</span>nn  Target VPN Extended Community
    both                     Both import and export Target<span class="token operator">-</span>VPN community
    export                   Export Target<span class="token operator">-</span>VPN community
    import                   Import Target<span class="token operator">-</span>VPN community
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target both <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span></code></pre>

<p>将PE1（R1）上与CE相连的PE接口F0&#x2F;1关联到VRF A-Site1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site1
<span class="token operator">%</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span> IPv4 disabled and <span class="token function">address</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span> removed due to enabling VRF A<span class="token operator">-</span>Site1
<span class="token comment">//切记先将接口关联VRF，然后再配置IP地址；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span></code></pre>
<p>在PE2（R4）上创建VRF，并命名为A-Site2，表示该VRF为VPN A的站点2服务；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip vrf A<span class="token operator">-</span>Site2</code></pre>

<p>指定RD，为1:2，如果按照AS：num命名法，以下RD表示AS1中的第2个VRF；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#rd <span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span></code></pre>

<p>指定RT的导入和导出，这里我将RT指定为导入和导出1：1；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>vrf<span class="token punctuation">)</span>#route<span class="token operator">-</span>target both <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token comment">//这里因为PE1（R1）的RT导出和PE2（R4）的RT导入能够匹配成功，所以R4能够学到R1导入到MP-BGP中的VPNv4路由；</span>
<span class="token comment">//又因为PE2（R4）的RT导出和PE1（1）的RT导入能够匹配成对，所以R1能够学到R4导入到MP-BGP中的VPNv4路由；</span></code></pre>

<p>将PE2（R4）上与CE相连的PE接口F0&#x2F;1关联到VRF A-Site2；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip vrf forwarding A<span class="token operator">-</span>Site2
<span class="token operator">%</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span> IPv4 disabled and <span class="token function">address</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span> removed due to enabling VRF A<span class="token operator">-</span>Site2
    <span class="token comment">//切记先将接口关联VRF，然后再配置IP地址；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#ip add <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span></code></pre>
<h3 id="配置MP-BGP"><a href="#配置MP-BGP" class="headerlink" title="配置MP-BGP"></a><strong>配置MP-BGP</strong></h3><p>在PE1（R1）上配置MP-BGP，使之与其他PE建立IBGP关系，在此实验中只有PE1和PE2两台PE设备；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> update<span class="token operator">-</span>source l0
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self
```  

启用PE1（R1）的VPNv4地址族，并激活与IBGP邻居PE2（R4）的MP<span class="token operator">-</span>BGP VPNv4邻居关系；
```c
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family vpnv4
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> activate
<span class="token comment">//激活与IBGP邻居R4的VPNv4关系；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community <span class="token operator">?</span>
    both      Send Standard and Extended Community attributes
    extended  Send Extended Community attribute
    standard  Send Standard Community attribute
    <span class="token operator">&lt;</span>cr<span class="token operator">></span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> send<span class="token operator">-</span>community both
<span class="token comment">//由于BGP团体属性为可选传递属性，所以必须手动指定R1向IBGP邻居R4发送拓展团体属性和标准团体属性；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family
<span class="token comment">//退出AF配置模式；</span></code></pre>
<p>在PE2（R4）上配置MP-BGP，使之与其他PE建立IBGP关系，</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#nei <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> remote<span class="token operator">-</span>as <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> update<span class="token operator">-</span>source l0
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> next<span class="token operator">-</span>hop<span class="token operator">-</span>self</code></pre>

<p>启用PE2（R4）的VPNv4地址族，并激活与IBGP邻居PE1（R1）的MP-BGP VPNv4邻居关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family vpnv4
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> activate
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> send<span class="token operator">-</span>community both</code></pre>
<h3 id="配置PE-CE路由"><a href="#配置PE-CE路由" class="headerlink" title="配置PE-CE路由"></a><strong>配置PE-CE路由</strong></h3><p>配置PE1（R1）的静态路由；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip route vrf A<span class="token operator">-</span>Site1 <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span></code></pre>

<p>配置PE1（R1）的MP-BGP IPv4 VRF地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site1
<span class="token comment">//进入MP-BGP的IPv4 VRF地址族（AF）；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute <span class="token keyword">static</span> 
<span class="token comment">//将静态路由中VRF名字与MP-BGP中IPv4 VRF名字相同的静态路由重分布进MP-BGP的IPv4 VRF AF；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected 
<span class="token comment">//如果用户在CE路由器上ping远程网络的另一个VPN站点中的CE或C路由器，</span>
<span class="token comment">//为了使其在没有指定其源地址情况下（即默认使用CE路由器出站接口IP地址），Echo Reply包能够有路由并正常返回,</span>
<span class="token comment">//将PE路由器的直连路由重分布进MP-BGP的IPv4 VRF AF中；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family 
<span class="token comment">//退出MP-BGP的IPv4 VRF地址族（AF）模式；</span></code></pre>
<p>配置PE2（R4）的静态路由；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip route vrf A<span class="token operator">-</span>Site1 <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span></code></pre>

<p>配置PE2（R4）的MP-BGP IPv4 VRF地址族（AF）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router bgp <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#address<span class="token operator">-</span>family ipv4 vrf A<span class="token operator">-</span>Site2
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute connected
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#redistribute <span class="token keyword">static</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token operator">-</span>af<span class="token punctuation">)</span>#exit<span class="token operator">-</span>address<span class="token operator">-</span>family</code></pre>

<h1 id="实验与调试"><a href="#实验与调试" class="headerlink" title="实验与调试"></a>实验与调试</h1><p>在VPN A站点1的C路由器R6上ping远程VPN A站点2的C路由器R8，并且指定源为R6的接口Loopback0；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R6</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> p <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> source <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
Packet sent with a source address of <span class="token number">6.6</span><span class="token number">.6</span><span class="token number">.6</span> 
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">128</span><span class="token operator">/</span><span class="token number">159</span><span class="token operator">/</span><span class="token number">200</span> ms</code></pre>
<p>成功！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_4/" class="post-title-link" itemprop="url">MPLS 实验4：MPLS vs BGP同步</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-14 22:46:41" itemprop="dateCreated datePublished" datetime="2014-03-14T22:46:41+08:00">2014-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>


<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<p>GNS3实验拓扑文件：<br><a href="topology.net">拓扑文件</a></p>
<h1 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h1><p><img src="/2014/MPLS_Lab_4/topo.png"></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-none"><code class="language-none">hostname R1
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 1.1.1.1 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.1 255.255.255.0
    ip ospf 1 area 0
    no shut
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.15.1 255.255.255.0
    no shut
!
router ospf 1
    router-id 1.1.1.1
!
router bgp 1
    bgp router-id 1.1.1.1
    bgp log-neighbor-changes
    network 1.1.1.1 mask 255.255.255.255
    neighbor 4.4.4.4 remote-as 1
    neighbor 4.4.4.4 update-source Loopback0
    neighbor 4.4.4.4 next-hop-self
    neighbor 192.168.15.5 remote-as 2
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-none"><code class="language-none">hostname R2
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 2.2.2.2 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
router ospf 1
    router-id 2.2.2.2
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R3"><a href="#R3" class="headerlink" title="R3:"></a>R3:</h2><pre class="language-none"><code class="language-none">hostname R3
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 3.3.3.3 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.3 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.3 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
router ospf 1
    router-id 3.3.3.3
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R4"><a href="#R4" class="headerlink" title="R4:"></a>R4:</h2><pre class="language-none"><code class="language-none">hostname R4
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 4.4.4.4 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.4 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.47.4 255.255.255.0
    no shutdown
!
router ospf 1
    router-id 4.4.4.4
!
router bgp 1
    bgp router-id 4.4.4.4
    bgp log-neighbor-changes
    network 4.4.4.4 mask 255.255.255.255
    neighbor 1.1.1.1 remote-as 1
    neighbor 1.1.1.1 update-source Loopback0
    neighbor 1.1.1.1 next-hop-self
    neighbor 192.168.47.7 remote-as 3
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h3 id="R5"><a href="#R5" class="headerlink" title="R5:"></a>R5:</h3><pre class="language-none"><code class="language-none">hostname R5
!
ip cef
!
interface Loopback0
    ip address 5.5.5.5 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.56.5 255.255.255.0
    ip ospf 1 area 0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.15.5 255.255.255.0
    no shutdown
!
router ospf 1
    router-id 5.5.5.5
!
router bgp 2
    bgp router-id 5.5.5.5
    bgp log-neighbor-changes
    network 5.5.5.5 mask 255.255.255.255
    neighbor 192.168.15.1 remote-as 1
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R6"><a href="#R6" class="headerlink" title="R6:"></a>R6:</h2><pre class="language-none"><code class="language-none">hostname R6
!
ip cef
!
interface Loopback0
    ip address 6.6.6.6 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.56.6 255.255.255.0
    ip ospf 1 area 0
    no shutdown
!
router ospf 1
    router-id 6.6.6.6
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R7"><a href="#R7" class="headerlink" title="R7:"></a>R7:</h2><pre class="language-none"><code class="language-none">hostname R7
!
ip cef
!
interface Loopback0
    ip address 7.7.7.7 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.78.7 255.255.255.0
    ip ospf 1 area 0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.47.7 255.255.255.0
    no shutdown
!
router ospf 1
    router-id 7.7.7.7
!
router bgp 3
    bgp router-id 7.7.7.7
    bgp log-neighbor-changes
    network 7.7.7.7 mask 255.255.255.255
    neighbor 192.168.47.4 remote-as 1
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R8"><a href="#R8" class="headerlink" title="R8:"></a>R8:</h2><pre class="language-none"><code class="language-none">hostname R8
!
ip cef
!
interface Loopback0
    ip address 8.8.8.8 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.78.8 255.255.255.0
    ip ospf 1 area 0
    no shutdown
!
router ospf 1
    router-id 8.8.8.8
!         
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h1 id="实验目的："><a href="#实验目的：" class="headerlink" title="实验目的："></a>实验目的：</h1><ol>
<li>使用MPLS解决BGP关闭同步后IBGP非全互联造成的路由黑洞问题；</li>
<li>研究以递归方式为前缀分配标签是如何运作的；</li>
</ol>
<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1："><a href="#实验1：" class="headerlink" title="实验1："></a>实验1：</h2><p>验证：从R5上，以R5的Loopback做源ping R7的Loopback0；</p>
<pre class="language-c" data-language="c"><code class="language-c">R5#ping <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> source l0
Type escape sequence to abort<span class="token punctuation">.</span>
Sending <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">-</span>byte ICMP Echos to <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token punctuation">,</span> timeout is <span class="token number">2</span> seconds<span class="token operator">:</span>
Packet sent with a source address of <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> 
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
Success rate is <span class="token number">100</span> <span class="token function">percent</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> round<span class="token operator">-</span>trip min<span class="token operator">/</span>avg<span class="token operator">/</span>max <span class="token operator">=</span> <span class="token number">112</span><span class="token operator">/</span><span class="token number">124</span><span class="token operator">/</span><span class="token number">140</span> ms
<span class="token comment">//成功了！</span></code></pre>

<p><strong>问题：</strong></p>
<ul>
<li>在该实验中，R2和R3作为P路由器，并没有运行BGP，为什么以R5的Loopback0做源可以ping通R7的Loopback0？</li>
<li>为什么数据包R2和R3在没有5.5.5.5&#x2F;32和7.7.7.7&#x2F;32的路由的情况下没有丢弃包？</li>
</ul>
<p>模拟ping包的交换过程，假设此时R1收到了来自R5的ping包：</p>
<blockquote>
<p>注意：当数据包进入R1时，数据包并未携带标签，此时R1作为LSP中的第一台LSR，也是入站LSR，R1需要查找CEF来为这个标准的IP数据包打上标签；</p>
</blockquote>
<p>查看R1的路由表：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override

Gateway of last resort is not set

        <span class="token number">1.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">2.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">09</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">3.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">09</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">09</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">45</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">46</span>
        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
O     <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">09</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
O     <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">09</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//在R1上，路由表递归查找下一跳可以发现：要去往7.7.7.7/32必须先到达4.4.4.4；</span>
<span class="token comment">//要到达4.4.4.4/32必须先到达192.168.12.2；</span></code></pre>

<p>查看R1的LFIB表：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show mpls forwarding<span class="token operator">-</span>table
Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
Label      Label      or Tunnel Id     Switched      interface              
<span class="token number">16</span>         <span class="token number">16</span>         <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
<span class="token number">17</span>         <span class="token number">17</span>         <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
<span class="token number">18</span>         Pop Label  <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
<span class="token number">19</span>         <span class="token number">18</span>         <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>  <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
<span class="token number">20</span>         Pop Label  <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>  <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
<span class="token comment">//由LFIB表可以得出，去往前缀4.4.4.4/32的出标签为16；</span></code></pre>

<p>沿路由递归查看CEF表：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip cef <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> detail
<span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> epoch <span class="token number">0</span><span class="token punctuation">,</span> flags rib only nolabel<span class="token punctuation">,</span> rib defined all labels
    recursive via <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
    nexthop <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span> label <span class="token number">16</span>

R1#sh ip cef <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> detail
<span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> epoch <span class="token number">0</span>
    local label info<span class="token operator">:</span> global<span class="token operator">/</span><span class="token number">16</span>
    <span class="token number">1</span> RR source <span class="token punctuation">[</span>no flags<span class="token punctuation">]</span>
    nexthop <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span> label <span class="token number">16</span>
<span class="token comment">//由于路由递归查找的关系，去往前缀7.7.7.7/32的数据包在出站时被打上了和去往前缀4.4.4.4/32的数据包相同的出标签16（R1的出标签，R2的入标签）；</span></code></pre>

<pre class="language-none"><code class="language-none">R1#sh ip cef 192.168.12.2 detail
192.168.12.2&#x2F;32, epoch 0, flags attached
    Adj source: IP adj out of FastEthernet0&#x2F;0, addr 192.168.12.2 6819DAE0
    Dependent covered prefix type adjfib cover 192.168.12.0&#x2F;24
    attached to FastEthernet0&#x2F;0
&#x2F;&#x2F;由于R1与192.168.12.0&#x2F;24直连，所以不再需要在进行标签转发，所以R1没有关于192.168.12.0&#x2F;24的出标签；</code></pre>

<p><strong>此时数据达到了R2：</strong></p>
<p>查看R2的IP路由表：</p>
<pre class="language-c" data-language="c"><code class="language-c">R2#show ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override

Gateway of last resort is not set

        <span class="token number">1.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">35</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">2.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">3.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">45</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">45</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
O     <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">45</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token comment">//可以看到，由于R2没有运行BGP，所以R2的路由表中没有关于前缀7.7.7.7/32的路由条目；</span>
<span class="token comment">//注意：递归查找路由表只会发生在运行BGP并与其他PE路由器建立IBGP关系的PE路由器，</span>
<span class="token comment">//而在P路由器上，由于没有运行BGP，不可能有相关路由信息，所以只按照标签转发。</span></code></pre>

<p>查看R2的LFIB：</p>
<pre class="language-c" data-language="c"><code class="language-c">R2#show mpls forwarding<span class="token operator">-</span>table
Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
Label      Label      or Tunnel Id     Switched      interface              
<span class="token number">16</span>         <span class="token number">16</span>         <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">38689</span>         Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span>
<span class="token number">17</span>         Pop Label  <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span>
<span class="token number">18</span>         Pop Label  <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>  <span class="token number">686</span>           Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span>
<span class="token number">19</span>         Pop Label  <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">41711</span>         Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span>
<span class="token comment">//尽管R2没有关于前缀7.7.7.7/32的路由条目，但由于AS1是MPLS域，路由器都使用标签转发数据，</span>
<span class="token comment">//加之因为路由的递归查找，使得前缀7.7.7.7/32“继承了”前缀4.4.4.4/32的标签；</span>
<span class="token comment">//所以，当R2收到去往7.7.7.7/32的数据包时，此数据包携带了前缀4.4.4.4/32的入标签16（R2的入标签，R1的出标签）；</span>
<span class="token comment">//于是，R2作出转发决定，并给数据包打上出标签16（R2的出标签，R3的入标签），然后转发给R3；</span></code></pre>

<p><strong>此时数据到达了R3：</strong></p>
<p>查看R3的IP路由表：</p>
<pre class="language-c" data-language="c"><code class="language-c">R3#show ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override

Gateway of last resort is not set

        <span class="token number">1.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">45</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">2.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">55</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">3.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">56</span><span class="token operator">:</span><span class="token number">35</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
O     <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">55</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//同样的，由于R2没有运行BGP，所以R3的路由表中没有关于前缀7.7.7.7/32的路由条目；</span></code></pre>

<p>查看R3的LFIB表：</p>
<pre class="language-c" data-language="c"><code class="language-c">R3#sh mpls forwarding<span class="token operator">-</span>table
Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
Label      Label      or Tunnel Id     Switched      interface              
<span class="token number">16</span>         Pop Label  <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">35742</span>         Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span>
<span class="token number">17</span>         Pop Label  <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span>
<span class="token number">18</span>         Pop Label  <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>  <span class="token number">1064</span>          Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span>
<span class="token number">19</span>         <span class="token number">19</span>         <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">43006</span>         Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span>
<span class="token comment">//尽管R2没有关于前缀7.7.7.7/32的路由条目，但由于AS1是MPLS域，路由器都使用标签转发数据，</span>
<span class="token comment">//加之因为路由的递归查找，使得前缀7.7.7.7/32“继承了”前缀4.4.4.4/32的标签；</span>
<span class="token comment">//所以，当R3收到去往7.7.7.7/32的数据包时，此数据包携带了前缀4.4.4.4/32的入标签16（R3的入标签，R2的出标签）；</span>
<span class="token comment">//于是，R3作出转发决定，并将数据包的标签弹出（R3的出标签为隐式空标签，R4的通告给R3的入标签为隐式空标签），然后转发给R4；</span></code></pre>

<p><strong>此时数据到达了R4:</strong></p>
<p>由于R4是LSP中的最后一台LSR，即出站LSR，所以R4负责移除标签，然后查找CEF，按照IP数据包的标准流程进行处理；</p>
<p>查看R4的LFIB表：</p>
<pre class="language-c" data-language="c"><code class="language-c">R4#sh mpls forwarding<span class="token operator">-</span>table
Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
Label      Label      or Tunnel Id     Switched      interface              
<span class="token number">16</span>         Pop Label  <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">17</span>         Pop Label  <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>  <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">18</span>         <span class="token number">17</span>         <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">19</span>         <span class="token number">19</span>         <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">20</span>         <span class="token number">18</span>         <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>  <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
```           
                
查看R4的IP路由表：
```c
R4#show ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override

Gateway of last resort is not set

        <span class="token number">1.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">04</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">48</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">2.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">04</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">48</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">3.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">04</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">5.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">5.5</span><span class="token number">.5</span><span class="token number">.5</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">32</span>
        <span class="token number">7.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
B        <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">34</span>
O     <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">04</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">48</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
O     <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">04</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span></code></pre>

<p>查看R4的CEF表：</p>
<pre class="language-c" data-language="c"><code class="language-c">R4#show ip cef <span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span> detail
<span class="token number">7.7</span><span class="token number">.7</span><span class="token number">.7</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> epoch <span class="token number">0</span><span class="token punctuation">,</span> flags rib only nolabel<span class="token punctuation">,</span> rib defined all labels
    recursive via <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.7</span>
    attached to FastEthernet0<span class="token operator">/</span><span class="token number">1</span>

<span class="token comment">//至此，ping包被按照普通IP数据包转发给了R7，echo reply包的转发交换方向相反，但过程相同；</span></code></pre>


<h1 id="实验结论："><a href="#实验结论：" class="headerlink" title="实验结论："></a>实验结论：</h1><ol>
<li>在分配标签时，标签可以以路由递归的方式被继承；</li>
<li>MPLS 不但可以解决BGP关闭同步后需要IBGP全互联的问题，更高效的是，MPLS可以让MPLS域内的P路由器不必运行BGP；</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_3/" class="post-title-link" itemprop="url">MPLS 实验3：MPLS LDP-IGP同步</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-14 22:28:41" itemprop="dateCreated datePublished" datetime="2014-03-14T22:28:41+08:00">2014-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>


<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="GNS3实验拓扑文件："><a href="#GNS3实验拓扑文件：" class="headerlink" title="GNS3实验拓扑文件："></a>GNS3实验拓扑文件：</h1><p><a href="topology.net">拓扑文件</a></p>
<h1 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h1><p><img src="/2014/MPLS_Lab_3/topo.png"></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-none"><code class="language-none">hostname R1
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 1.1.1.1 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.1 255.255.255.0
    ip ospf 1 area 0
    no shutdown
    mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.21.1 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
router ospf 1
    router-id 1.1.1.1
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-none"><code class="language-none">hostname R2
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 2.2.2.2 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.21.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
mpls ip
!
router ospf 1
    router-id 2.2.2.2
!
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>


<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1：R1和R2之间仅有唯一一条链路时的LDP-IGP同步"><a href="#实验1：R1和R2之间仅有唯一一条链路时的LDP-IGP同步" class="headerlink" title="实验1：R1和R2之间仅有唯一一条链路时的LDP-IGP同步"></a>实验1：R1和R2之间仅有唯一一条链路时的LDP-IGP同步</h2><p>将R1和R2之间的由F0&#x2F;1相连的链路禁用，只留下F0&#x2F;0的链路；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#shutdown

<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#shutdown</code></pre>

<p>查看R1的LDP邻居表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ldp nei
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token number">.52561</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">7</span><span class="token operator">/</span><span class="token number">7</span><span class="token punctuation">;</span> Downstream
        Up time<span class="token operator">:</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span>
        LDP discovery sources<span class="token operator">:</span>
            FastEthernet0<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>         <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
<span class="token comment">//可以看到，此时R1只有一个LDP邻居，即R2，并且他们之间只有一条链路，因为R1只在F0/0发现了LDP邻居；</span></code></pre>

<p>在R1和R2上启用LDP-IGP同步功能；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#mpls ldp sync

<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router ospf <span class="token number">1</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#mpls ldp sync</code></pre>

<p>查看R1上F0&#x2F;0的LDP和OSPF同步信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show ip ospf mpls ldp interface f0<span class="token operator">/</span><span class="token number">0</span>
FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    Process ID <span class="token number">1</span><span class="token punctuation">,</span> Area <span class="token number">0</span>
    LDP is not configured through LDP autoconfig
    LDP<span class="token operator">-</span>IGP Synchronization <span class="token operator">:</span> Required <span class="token comment">//接口f0/0的LDP-IGP同步状态为Required，说明LDP-IGP已经开启；</span>
    Holddown timer is not configured <span class="token comment">//LDP-IGP保持计时器没有配置；</span>
    Interface is up <span class="token comment">//接口为UP状态；</span></code></pre>
<h2 id="调试1："><a href="#调试1：" class="headerlink" title="调试1："></a>调试1：</h2><p>清楚MPLS LDP的邻接关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> clear mpls ldp neighbor <span class="token operator">*</span>
<span class="token comment">//注意：这两条命令切换要快，否则看不到现象；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show ip ospf mpls ldp interface f0<span class="token operator">/</span><span class="token number">0</span>
FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    Process ID <span class="token number">1</span><span class="token punctuation">,</span> Area <span class="token number">0</span>
    LDP is not configured through LDP autoconfig
    LDP<span class="token operator">-</span>IGP Synchronization <span class="token operator">:</span> Required
    Holddown timer is not configured
    Interface is up and sending maximum metric <span class="token comment">//接口已经UP，但由于LDP邻居被重置，所以OSPF将度量值用最大值来发送给邻居；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">16.371</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>CLEAR_NBRS<span class="token operator">:</span> Clear LDP <span class="token function">neighbors</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> by console
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">16.387</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHG<span class="token operator">:</span> LDP Neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> is <span class="token function">DOWN</span> <span class="token punctuation">(</span>User cleared session manually<span class="token punctuation">)</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">20.507</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHG<span class="token operator">:</span> LDP Neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> is UP
<span class="token comment">//LDP邻居又再度建立；</span></code></pre>

<p>调试MPLS LDP-IGP同步过程；</p>
<p>配置ACL 100以捕获R1发往R2的OSPF LSA；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#access<span class="token operator">-</span>list <span class="token number">100</span> permit ospf host <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> any</code></pre>
<p><strong>同时，开启抓包工具Wireshark，捕获F0&#x2F;0上的OSPF数据包；</strong></p>
<p>调试<code>debug mpls ldp igp sync</code> 和 <code>debug ip ospf lsa-generation 100</code>；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#debug ip ospf lsa<span class="token operator">-</span>generation <span class="token number">100</span>
OSPF LSA generation debugging is on <span class="token keyword">for</span> access list <span class="token number">100</span>
R1#debug mpls ldp igp sync
LDP<span class="token operator">-</span>IGP Synchronization debugging is on
R1#clear mpls ldp neighbor <span class="token operator">*</span>

R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">55.823</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>CLEAR_NBRS<span class="token operator">:</span> Clear LDP <span class="token function">neighbors</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> by console
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">55.831</span><span class="token operator">:</span> LDP<span class="token operator">-</span>SYNC<span class="token operator">:</span> Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span> OSPF <span class="token number">1</span><span class="token operator">:</span> notify <span class="token function">status</span> <span class="token punctuation">(</span>required<span class="token punctuation">,</span> not achieved<span class="token punctuation">,</span> delay<span class="token punctuation">,</span> holddown infinite<span class="token punctuation">)</span> internal <span class="token function">status</span> <span class="token punctuation">(</span>not achieved<span class="token punctuation">,</span> timer not running<span class="token punctuation">)</span>
<span class="token comment">//LDP-IGP未同步；</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">55.835</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">55.835</span><span class="token operator">:</span> LDP<span class="token operator">-</span>SYNC<span class="token operator">:</span> Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span> Adj being deleted<span class="token punctuation">,</span> sync_achieved goes down
<span class="token comment">//LDP邻接关系被删除，同步完成状态变为down；</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">55.843</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHG<span class="token operator">:</span> LDP Neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> is <span class="token function">DOWN</span> <span class="token punctuation">(</span>User cleared session manually<span class="token punctuation">)</span>
<span class="token comment">//LDP邻居关系Down；用户手动清除了会话；</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">56.335</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Build router LSA <span class="token keyword">for</span> area <span class="token number">0</span><span class="token punctuation">,</span> router ID <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> seq <span class="token number">0x80000059</span></code></pre>

<p><strong>在调试输出过程中飞快按下此命令，得到LDP-IGP同步过程中的OSPF Database中的一类LSA信息；</strong></p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip ospf database router

            OSPF Router with <span class="token function">ID</span> <span class="token punctuation">(</span><span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Process ID <span class="token number">1</span><span class="token punctuation">)</span>

                Router Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>

    LS age<span class="token operator">:</span> <span class="token number">2</span>
    Options<span class="token operator">:</span> <span class="token punctuation">(</span>No TOS<span class="token operator">-</span>capability<span class="token punctuation">,</span> DC<span class="token punctuation">)</span>
    LS Type<span class="token operator">:</span> Router Links
    Link State ID<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
    Advertising Router<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
    LS Seq Number<span class="token operator">:</span> <span class="token number">80000059</span>
    Checksum<span class="token operator">:</span> <span class="token number">0x814F</span>
    Length<span class="token operator">:</span> <span class="token number">48</span>
    Number of Links<span class="token operator">:</span> <span class="token number">2</span>

    Link connected to<span class="token operator">:</span> a Stub <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Network<span class="token operator">/</span>subnet number<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Network Mask<span class="token operator">:</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">1</span>

    Link connected to<span class="token operator">:</span> a Transit <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Designated Router address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Router Interface address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">65535</span> <span class="token comment">//注意LDP-IGP同步过程中，度量值变为了最大值65535；</span>


    LS age<span class="token operator">:</span> <span class="token number">3</span>
    Options<span class="token operator">:</span> <span class="token punctuation">(</span>No TOS<span class="token operator">-</span>capability<span class="token punctuation">,</span> DC<span class="token punctuation">)</span>
    LS Type<span class="token operator">:</span> Router Links
    Link State ID<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
    Advertising Router<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
    LS Seq Number<span class="token operator">:</span> <span class="token number">8000004</span>C
    Checksum<span class="token operator">:</span> <span class="token number">0x8B45</span>
    Length<span class="token operator">:</span> <span class="token number">48</span>
    Number of Links<span class="token operator">:</span> <span class="token number">2</span>

    Link connected to<span class="token operator">:</span> a Stub <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Network<span class="token operator">/</span>subnet number<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Network Mask<span class="token operator">:</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">1</span>

    Link connected to<span class="token operator">:</span> a Transit <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Designated Router address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Router Interface address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">65535</span><span class="token comment">//注意LDP-IGP同步过程中，度量值变为了最大值65535；</span>
        
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">59.543</span><span class="token operator">:</span> LDP<span class="token operator">-</span>SYNC<span class="token operator">:</span> Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> No session or session has not send initial update<span class="token punctuation">,</span> ignore adj joining event<span class="token punctuation">.</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">59.547</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHG<span class="token operator">:</span> LDP Neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> is UP
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">59.551</span><span class="token operator">:</span> LDP<span class="token operator">-</span>SYNC<span class="token operator">:</span> Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> session <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span> came up<span class="token punctuation">,</span> sync_achieved up
<span class="token comment">//LDP-IGP同步状态UP；</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">59.555</span><span class="token operator">:</span> LDP<span class="token operator">-</span>SYNC<span class="token operator">:</span> Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span> OSPF <span class="token number">1</span><span class="token operator">:</span> notify <span class="token function">status</span> <span class="token punctuation">(</span>required<span class="token punctuation">,</span> achieved<span class="token punctuation">,</span> no delay<span class="token punctuation">,</span> holddown infinite<span class="token punctuation">)</span> internal <span class="token function">status</span> <span class="token punctuation">(</span>achieved<span class="token punctuation">,</span> timer not running<span class="token punctuation">)</span>
<span class="token comment">//LDP-IGP同步完成；</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">59.555</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">00.055</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">1</span>
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">01.335</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Build router LSA <span class="token keyword">for</span> area <span class="token number">0</span><span class="token punctuation">,</span> router ID <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> seq <span class="token number">0x8000005A</span></code></pre>

<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip ospf database router

            OSPF Router with <span class="token function">ID</span> <span class="token punctuation">(</span><span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Process ID <span class="token number">1</span><span class="token punctuation">)</span>

                Router Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>

    LS age<span class="token operator">:</span> <span class="token number">649</span>
    Options<span class="token operator">:</span> <span class="token punctuation">(</span>No TOS<span class="token operator">-</span>capability<span class="token punctuation">,</span> DC<span class="token punctuation">)</span>
    LS Type<span class="token operator">:</span> Router Links
    Link State ID<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
    Advertising Router<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
    LS Seq Number<span class="token operator">:</span> <span class="token number">8000005</span>A
    Checksum<span class="token operator">:</span> <span class="token number">0x9D31</span>
    Length<span class="token operator">:</span> <span class="token number">48</span>
    Number of Links<span class="token operator">:</span> <span class="token number">2</span>

    Link connected to<span class="token operator">:</span> a Stub <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Network<span class="token operator">/</span>subnet number<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Network Mask<span class="token operator">:</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">1</span>

    Link connected to<span class="token operator">:</span> a Transit <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Designated Router address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Router Interface address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">1</span><span class="token comment">//注意LDP-IGP同步完成后，度量值恢复到正常的1；</span>


    LS age<span class="token operator">:</span> <span class="token number">650</span>
    Options<span class="token operator">:</span> <span class="token punctuation">(</span>No TOS<span class="token operator">-</span>capability<span class="token punctuation">,</span> DC<span class="token punctuation">)</span>
    LS Type<span class="token operator">:</span> Router Links
    Link State ID<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
    Advertising Router<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
    LS Seq Number<span class="token operator">:</span> <span class="token number">8000004</span>D
    Checksum<span class="token operator">:</span> <span class="token number">0xA727</span>
    Length<span class="token operator">:</span> <span class="token number">48</span>
    Number of Links<span class="token operator">:</span> <span class="token number">2</span>

    Link connected to<span class="token operator">:</span> a Stub <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Network<span class="token operator">/</span>subnet number<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Network Mask<span class="token operator">:</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">1</span>

    Link connected to<span class="token operator">:</span> a Transit <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Designated Router address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Router Interface address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">1</span>
<span class="token comment">//注意到，在OSPF邻居已经建立的情况下，OSPF并没有如预期的那样，因为LDP邻居关系的中断破裂（Down），而导致OSPF邻接关系的终端破裂（Down）；</span></code></pre>
<p>查看Wireshark在LDP-IGP收敛过程中捕获的数据包；<br>可以看到，LSA中的Metric和OSPF Database中一致；<br><img src="/2014/MPLS_Lab_3/pic1.png"><br><img src="/2014/MPLS_Lab_3/pic2.png"></p>
<p>继续调试<code>clear ip ospf process</code>：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#clear ip ospf process 
Reset ALL OSPF processes<span class="token operator">?</span> <span class="token punctuation">[</span>no<span class="token punctuation">]</span><span class="token operator">:</span> yes
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">09.559</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">09.559</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">1</span><span class="token punctuation">,</span> Nbr <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> on FastEthernet0<span class="token operator">/</span><span class="token number">0</span> from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">09.563</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">09.563</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling network LSA on FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">09.567</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">09.567</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">09.571</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">09.575</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">09.575</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">09.603</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">09.907</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">1</span><span class="token punctuation">,</span> Nbr <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> on FastEthernet0<span class="token operator">/</span><span class="token number">0</span> from LOADING to FULL<span class="token punctuation">,</span> Loading Done
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">09.911</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">10.059</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Build router LSA <span class="token keyword">for</span> area <span class="token number">0</span><span class="token punctuation">,</span> router ID <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> seq <span class="token number">0x80000001</span>
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">14.591</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">14.707</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">1</span><span class="token punctuation">,</span> LSID <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> Adv rtr <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x8000005A</span><span class="token punctuation">,</span> from <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">14.707</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Update router LSA <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">1</span> <span class="token number">8000005</span>A
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">14.711</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">15.059</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Build router LSA <span class="token keyword">for</span> area <span class="token number">0</span><span class="token punctuation">,</span> router ID <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> seq <span class="token number">0x8000005B</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">15.067</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSMAX<span class="token operator">:</span> Rcv Maxage LSA<span class="token punctuation">,</span> Type <span class="token number">1</span><span class="token punctuation">,</span> LSID <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> Adv rtr <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> age <span class="token number">3600</span><span class="token punctuation">,</span> seq <span class="token number">0x8000005A</span><span class="token punctuation">,</span> from <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">15.087</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">1</span>
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">20.059</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> No change in router LSA<span class="token punctuation">,</span> area <span class="token number">0</span>
<span class="token comment">//注意到，由于OSPF收敛迅速，所以LDP没有受到影响，甚至没有出现任何LDP日志信息；</span></code></pre>
<h2 id="调试2："><a href="#调试2：" class="headerlink" title="调试2："></a>调试2：</h2><p>禁用R2上F0&#x2F;0的MPLS，让R1和R2的LDP邻居关系断开，确保LDP会话晚于OSPF邻接关系建立；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">0</span>  
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#no mpls ip</code></pre>

<p>在R1上查看OSPF邻接关系；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show ip ospf neighbor
Neighbor ID     Pri   State           Dead Time   Address         Interface
<span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>           <span class="token number">1</span>   FULL<span class="token operator">/</span>DR         <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">36</span>    <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>    FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//注意：可以看到，正如调试1中验证的一样，在OSPF邻接关系已经建立的情况下，终止LDP的邻接关系并不会影响OSPF的邻接关系；</span></code></pre>

<p>此时，在经过将R2的F0&#x2F;0禁用MPLS之后，R1和R2的LDP邻居已经关系；<br>接下来，重置OSPF进程；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#debug ip ospf adj
OSPF adjacency debugging is on
R1#clear ip ospf process
Reset ALL OSPF processes<span class="token operator">?</span> <span class="token punctuation">[</span>no<span class="token punctuation">]</span><span class="token operator">:</span> yes
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.419</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Lo0<span class="token operator">:</span> Interface going Down
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.419</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Lo0<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> address <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> is dead<span class="token punctuation">,</span> state DOWN
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.423</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.423</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Interface going Down
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.423</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> is dead<span class="token punctuation">,</span> state DOWN
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.427</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">1</span><span class="token punctuation">,</span> Nbr <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> on FastEthernet0<span class="token operator">/</span><span class="token number">0</span> from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.427</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.431</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Neighbor change event
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.431</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> DR<span class="token operator">/</span>BDR election
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.431</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect BDR <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.435</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect DR <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.435</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect BDR <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.435</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect DR <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.439</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> DR<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token punctuation">.</span>
R1#<span class="token number">1</span> <span class="token punctuation">(</span>Id<span class="token punctuation">)</span>   BDR<span class="token operator">:</span> none 
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.439</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling network LSA on FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.443</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Remember old DR <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.443</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.443</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span> is dead<span class="token punctuation">,</span> state DOWN
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.447</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Neighbor change event
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.447</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> DR<span class="token operator">/</span>BDR election
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.447</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect BDR <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.451</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect DR <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.451</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect BDR <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.451</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect DR <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.455</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> DR<span class="token operator">:</span> none    BDR<span class="token operator">:</span> none 
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.455</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Flush network LSA immediately
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.459</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Remember old DR <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.459</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.459</span><span class="token operator">:</span> OS
R1#PF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.467</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Lo0<span class="token operator">:</span> Interface going Up
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.467</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.467</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">1</span><span class="token operator">:</span> Not sending Hellos until LDP session comes up<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span> remains down
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.471</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Not sending Hellos until LDP session comes up<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span> remains down
<span class="token comment">//直到LDP会话建立，否则OSPF不发送Hello消息，F0/0口保持DOWN；</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.927</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Build router LSA <span class="token keyword">for</span> area <span class="token number">0</span><span class="token punctuation">,</span> router ID <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> seq <span class="token number">0x80000001</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">16.943</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> We are not DR to build Net LSA
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">17.611</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Interface held DOWN waiting <span class="token keyword">for</span> LDP<span class="token comment">//为了等待LDP会话建立，OSPF保持接口为DOWN；</span>
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">18.923</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Rcv pkt  src <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> dst <span class="token number">224.0</span><span class="token number">.0</span><span class="token number">.5</span> id <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> type <span class="token number">5</span> if_state <span class="token number">0</span> <span class="token operator">:</span> ignored due to unknown neighbor
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">27.611</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Interface held DOWN waiting <span class="token keyword">for</span> LDP
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">37.611</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Interface held DOWN waiting <span class="token keyword">for</span> LDP
R1#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">47.611</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Interface held DOWN waiting <span class="token keyword">for</span> LDP<span class="token comment">//为了等待LDP会话建立，OSPF保持接口为DOWN；</span>
<span class="token comment">//可以看到LDP-IGP同步机制开始运作了！</span>
<span class="token comment">//注意：由于LDP会话关系建立在OSPF提供可达性的基础上，而OSPF邻接关系却要等待LDP会话首先建立，</span>
<span class="token comment">//所以此时OSPF和LDP会互相等待对方完成邻居关系的建立，而导致死循环，最终无论是OSPF还是LDP都无法建立邻居关系；</span></code></pre>

<p>查看OSPF接口F0&#x2F;0的信息：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show ip ospf interface f0<span class="token operator">/</span><span class="token number">0</span>
FastEthernet0<span class="token operator">/</span><span class="token number">0</span> is up<span class="token punctuation">,</span> line protocol is up 
    Internet Address <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> Area <span class="token number">0</span><span class="token punctuation">,</span> Attached via Interface Enable
    Process ID <span class="token number">1</span><span class="token punctuation">,</span> Router ID <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> Network Type BROADCAST<span class="token punctuation">,</span> Cost<span class="token operator">:</span> <span class="token number">1</span>
    Topology<span class="token operator">-</span>MTID    Cost    Disabled    Shutdown      Topology Name
        <span class="token number">0</span>           <span class="token number">1</span>         no          no            Base
    Enabled by interface config<span class="token punctuation">,</span> including secondary ip addresses
    Transmit Delay is <span class="token number">1</span> sec<span class="token punctuation">,</span> State <span class="token function">DOWN</span> <span class="token punctuation">(</span>waiting <span class="token keyword">for</span> LDP<span class="token punctuation">)</span><span class="token punctuation">,</span> Priority <span class="token number">1</span>
    No designated router on this network
    No backup designated router on this network
    Timer intervals configured<span class="token punctuation">,</span> Hello <span class="token number">10</span><span class="token punctuation">,</span> Dead <span class="token number">40</span><span class="token punctuation">,</span> Wait <span class="token number">40</span><span class="token punctuation">,</span> Retransmit <span class="token number">5</span>
    oob<span class="token operator">-</span>resync timeout <span class="token number">40</span></code></pre>

<p>配置命令<code>mpls ldp igp sync holddown msecs</code>，以告知 IGP 只等待配置命令中所规定的时间，一旦保持计时器超时，不管 LDP 会话是否建立，OSPF 都会建立邻接关系；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp igp sync holddown <span class="token operator">?</span>
    <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">2147483647</span><span class="token operator">></span>  Hold down time in milliseconds
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp igp sync holddown <span class="token number">5000</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01.743</span><span class="token operator">:</span> LDP<span class="token operator">-</span>SYNC<span class="token operator">:</span> Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span> OSPF <span class="token number">1</span><span class="token operator">:</span> notify <span class="token function">status</span> <span class="token punctuation">(</span>required<span class="token punctuation">,</span> not achieved<span class="token punctuation">,</span> delay<span class="token punctuation">,</span> holddown <span class="token number">5000</span><span class="token punctuation">)</span> internal <span class="token function">status</span> <span class="token punctuation">(</span>not achieved<span class="token punctuation">,</span> timer not running<span class="token punctuation">)</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01.743</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Rcv <span class="token keyword">int</span> status from LDP<span class="token operator">:</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">5000</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01.747</span><span class="token operator">:</span> LDP<span class="token operator">-</span>SYNC<span class="token operator">:</span> Fa0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span> OSPF <span class="token number">1</span><span class="token operator">:</span> notify <span class="token function">status</span> <span class="token punctuation">(</span>required<span class="token punctuation">,</span> not achieved<span class="token punctuation">,</span> delay<span class="token punctuation">,</span> holddown <span class="token number">5000</span><span class="token punctuation">)</span> internal <span class="token function">status</span> <span class="token punctuation">(</span>not achieved<span class="token punctuation">,</span> timer not running<span class="token punctuation">)</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01.747</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">1</span><span class="token operator">:</span> Rcv <span class="token keyword">int</span> status from LDP<span class="token operator">:</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">5000</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.743</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Interface going Up
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.743</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.747</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">1</span><span class="token operator">:</span> Interface is down
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.831</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> <span class="token number">2</span> Way Communication to <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token punctuation">,</span> state <span class="token number">2</span>WAY
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.831</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Backup seen event before WAIT timer
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.831</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> DR<span class="token operator">/</span>BDR election
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.835</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect BDR <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.835</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect DR <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.839</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect BDR <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.839</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect DR <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.839</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> DR<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">(</span>Id<span class="token punctuation">)</span>   BDR<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token punctuation">(</span>Id<span class="token punctuation">)</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.843</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Nbr <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span> Prepare dbase exchange
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.847</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Send DBD to <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> seq <span class="token number">0x2542</span> opt <span class="token number">0x52</span> flag <span class="token number">0x7</span> len <span class="token number">32</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.847</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token number">.891</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Rcv DBD from <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> seq <span class="token number">0x1A5A</span> opt <span class="token number">0x52</span> flag <span class="token number">0x7</span> len <span class="token number">32</span>  mtu <span class="token number">1500</span> state EXSTART
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.891</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> NBR Negotiation Done<span class="token punctuation">.</span> We are the SLAVE
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.895</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Nbr <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span> Summary list built<span class="token punctuation">,</span> size <span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.895</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Send DBD to <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> seq <span class="token number">0x1A5A</span> opt <span class="token number">0x52</span> flag <span class="token number">0x2</span> len <span class="token number">52</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.963</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Rcv DBD from <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> seq <span class="token number">0x1A5B</span> opt <span class="token number">0x52</span> flag <span class="token number">0x1</span> len <span class="token number">52</span>  mtu <span class="token number">1500</span> state EXCHANGE
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.967</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Exchange Done with <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.967</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Send LS REQ to <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> length <span class="token number">12</span> LSA count <span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">06.967</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Send DBD to <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> seq <span class="token number">0x1A5B</span> opt <span class="token number">0x52</span> flag <span class="token number">0x0</span> len <span class="token number">32</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">07.039</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Rcv LS UPD from <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> length <span class="token number">76</span> LSA count <span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">07.039</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Synchronized with <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token punctuation">,</span> state FULL
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">07.043</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">1</span><span class="token punctuation">,</span> Nbr <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> on FastEtherne
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#t0<span class="token operator">/</span><span class="token number">0</span> from LOADING to FULL<span class="token punctuation">,</span> Loading Done
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">07.043</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">07.047</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Rcv LS REQ from <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> length <span class="token number">36</span> LSA count <span class="token number">1</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">07.243</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Build router LSA <span class="token keyword">for</span> area <span class="token number">0</span><span class="token punctuation">,</span> router ID <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> seq <span class="token number">0x80000002</span> <span class="token comment">//注意此LSA的序列号；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">09.979</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Neighbor change event
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">09.983</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> DR<span class="token operator">/</span>BDR election
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">09.983</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect BDR <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">09.987</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> Elect DR <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">09.987</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> ADJ   Fa0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> DR<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">(</span>Id<span class="token punctuation">)</span>   BDR<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token punctuation">(</span>Id<span class="token punctuation">)</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">09.991</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Scheduling rtr LSA <span class="token keyword">for</span> area <span class="token number">0</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">10.491</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> Rate limit LSA generation <span class="token keyword">for</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">12.243</span><span class="token operator">:</span> OSPF<span class="token operator">-</span><span class="token number">1</span> LSGEN<span class="token operator">:</span> No change in router LSA<span class="token punctuation">,</span> area <span class="token number">0</span> 
<span class="token comment">//当holdtime超时后，虽然LDP会话还没有建立，OSPF却主动建立了邻接关系；</span></code></pre>

<p>查看R1的OSPF Database中1类LSA；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show ip ospf database router

            OSPF Router with <span class="token function">ID</span> <span class="token punctuation">(</span><span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Process ID <span class="token number">1</span><span class="token punctuation">)</span>

                Router Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>

    LS age<span class="token operator">:</span> <span class="token number">304</span>
    Options<span class="token operator">:</span> <span class="token punctuation">(</span>No TOS<span class="token operator">-</span>capability<span class="token punctuation">,</span> DC<span class="token punctuation">)</span>
    LS Type<span class="token operator">:</span> Router Links
    Link State ID<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
    Advertising Router<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
    LS Seq Number<span class="token operator">:</span> <span class="token number">80000002</span>
    Checksum<span class="token operator">:</span> <span class="token number">0x30F7</span>
    Length<span class="token operator">:</span> <span class="token number">48</span>
    Number of Links<span class="token operator">:</span> <span class="token number">2</span>

    Link connected to<span class="token operator">:</span> a Stub <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Network<span class="token operator">/</span>subnet number<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Network Mask<span class="token operator">:</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">1</span>

    Link connected to<span class="token operator">:</span> a Transit <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Designated Router address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Router Interface address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">65535</span> <span class="token comment">//接口为UP，OSPF正在发送最大度量值；</span>

    LS age<span class="token operator">:</span> <span class="token number">304</span>
    Options<span class="token operator">:</span> <span class="token punctuation">(</span>No TOS<span class="token operator">-</span>capability<span class="token punctuation">,</span> DC<span class="token punctuation">)</span>
    LS Type<span class="token operator">:</span> Router Links
    Link State ID<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
    Advertising Router<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
    LS Seq Number<span class="token operator">:</span> <span class="token number">80000059</span>
    Checksum<span class="token operator">:</span> <span class="token number">0x8F33</span>
    Length<span class="token operator">:</span> <span class="token number">48</span>
    Number of Links<span class="token operator">:</span> <span class="token number">2</span>

    Link connected to<span class="token operator">:</span> a Stub <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Network<span class="token operator">/</span>subnet number<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Network Mask<span class="token operator">:</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">1</span>

    Link connected to<span class="token operator">:</span> a Transit <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Designated Router address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Router Interface address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span></code></pre>

<p>查看R1上F0&#x2F;0的LDP和OSPF同步信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//备注：由于holdtime为5秒（5000毫秒），所以输入下一条命令，必须非常快！</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip ospf mpls ldp interface
Loopback0
    Process ID <span class="token number">1</span><span class="token punctuation">,</span> Area <span class="token number">0</span>
    LDP is not configured through LDP autoconfig
    LDP<span class="token operator">-</span>IGP Synchronization <span class="token operator">:</span> Not required
    Holddown timer is disabled
    Interface is up 
FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
    Process ID <span class="token number">1</span><span class="token punctuation">,</span> Area <span class="token number">0</span>
    LDP is not configured through LDP autoconfig
    LDP<span class="token operator">-</span>IGP Synchronization <span class="token operator">:</span> Required
    Holddown timer is configured <span class="token operator">:</span> <span class="token number">5000</span> msecs
    Holddown timer is not running
    Interface is down 
FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    Process ID <span class="token number">1</span><span class="token punctuation">,</span> Area <span class="token number">0</span>
    LDP is not configured through LDP autoconfig
    LDP<span class="token operator">-</span>IGP Synchronization <span class="token operator">:</span> Required
    Holddown timer is configured <span class="token operator">:</span> <span class="token number">5000</span> msecs <span class="token comment">//LDP-IGP同步保持计时器被配置为5000毫秒；</span>
    Holddown timer is running and is expiring in <span class="token number">1848</span> msecs<span class="token comment">//LDP-IGP保持计时器正在运行，并且将在1848毫秒后到期超时；</span>
    Interface is down and pending LDP <span class="token comment">//接口为Down，等待LDP；</span></code></pre>

<p>查看R1上F0&#x2F;0的LDP和OSPF同步信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip ospf mpls ldp interface f0<span class="token operator">/</span><span class="token number">0</span>
FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    Process ID <span class="token number">1</span><span class="token punctuation">,</span> Area <span class="token number">0</span>
    LDP is not configured through LDP autoconfig
    LDP<span class="token operator">-</span>IGP Synchronization <span class="token operator">:</span> Required
    Holddown timer is configured <span class="token operator">:</span> <span class="token number">5000</span> msecs
    Holddown timer is not running<span class="token comment">//LDP-IGP保持计时器未在运行，说明保持计时器已经超时；</span>
    Interface is up and sending maximum metric<span class="token comment">//接口为UP，OSPF正在发送最大度量值；</span></code></pre>
<blockquote>
<p>可以看到虽然OSPF邻接关系已经建立，但是由于LDP会话还没有建立，所以OSPF向邻居通告的度量值为最大值65535，在具有多条链路同时能够达到目的地的情况下，这一OSPF的这一动作确保此链路不会被用来转发数据；从而防止了到达该此链路的数据包不会因不能被打上标签，而导致数据包被丢弃；</p>
</blockquote>
<p>在R2上，将F0&#x2F;0口的mpls开启：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">0</span> 
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#mpls ip

<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">29</span><span class="token operator">:</span><span class="token number">53.575</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHG<span class="token operator">:</span> LDP Neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> is UP
<span class="token comment">//可以看到LDP邻居马上建立；</span></code></pre>

<p>查看R1的OSPF Database中1类LSA：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip ospf database router

            OSPF Router with <span class="token function">ID</span> <span class="token punctuation">(</span><span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Process ID <span class="token number">1</span><span class="token punctuation">)</span>

                Router Link <span class="token function">States</span> <span class="token punctuation">(</span>Area <span class="token number">0</span><span class="token punctuation">)</span>

    LS age<span class="token operator">:</span> <span class="token number">122</span>
    Options<span class="token operator">:</span> <span class="token punctuation">(</span>No TOS<span class="token operator">-</span>capability<span class="token punctuation">,</span> DC<span class="token punctuation">)</span>
    LS Type<span class="token operator">:</span> Router Links
    Link State ID<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
    Advertising Router<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
    LS Seq Number<span class="token operator">:</span> <span class="token number">80000003</span> <span class="token comment">//R1的OSPF进程更新了之前的Seq：80000002的LSA；</span>
    Checksum<span class="token operator">:</span> <span class="token number">0x4CD9</span>
    Length<span class="token operator">:</span> <span class="token number">48</span>
    Number of Links<span class="token operator">:</span> <span class="token number">2</span>

    Link connected to<span class="token operator">:</span> a Stub <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Network<span class="token operator">/</span>subnet number<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Network Mask<span class="token operator">:</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">1</span>

    Link connected to<span class="token operator">:</span> a Transit <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Designated Router address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Router Interface address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">//在更新后的Seq：80000003 LSA中，度量值被更改回正常的1；</span>

    LS age<span class="token operator">:</span> <span class="token number">1250</span>
    Options<span class="token operator">:</span> <span class="token punctuation">(</span>No TOS<span class="token operator">-</span>capability<span class="token punctuation">,</span> DC<span class="token punctuation">)</span>
    LS Type<span class="token operator">:</span> Router Links
    Link State ID<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
    Advertising Router<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
    LS Seq Number<span class="token operator">:</span> <span class="token number">80000059</span>
    Checksum<span class="token operator">:</span> <span class="token number">0x8F33</span>
    Length<span class="token operator">:</span> <span class="token number">48</span>
    Number of Links<span class="token operator">:</span> <span class="token number">2</span>

    Link connected to<span class="token operator">:</span> a Stub <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Network<span class="token operator">/</span>subnet number<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Network Mask<span class="token operator">:</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">1</span>

    Link connected to<span class="token operator">:</span> a Transit <span class="token function">Network</span>
        <span class="token punctuation">(</span>Link ID<span class="token punctuation">)</span> Designated Router address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        <span class="token punctuation">(</span>Link Data<span class="token punctuation">)</span> Router Interface address<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        Number of MTID metrics<span class="token operator">:</span> <span class="token number">0</span>
        TOS <span class="token number">0</span> Metrics<span class="token operator">:</span> <span class="token number">1</span></code></pre>

<p>查看R1上F0&#x2F;0的LDP和OSPF同步信息；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip ospf mpls ldp interface f0<span class="token operator">/</span><span class="token number">0</span>
FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    Process ID <span class="token number">1</span><span class="token punctuation">,</span> Area <span class="token number">0</span>
    LDP is not configured through LDP autoconfig
    LDP<span class="token operator">-</span>IGP Synchronization <span class="token operator">:</span> Required
    Holddown timer is configured <span class="token operator">:</span> <span class="token number">5000</span> msecs
    Holddown timer is not running
    Interface is up
<span class="token comment">//可以看到接口已经起来了，说明LDP和OSPF已经同步；</span></code></pre>


<h2 id="实验2：R1和R2之间仅有两条或多条链路时的LDP-IGP同步"><a href="#实验2：R1和R2之间仅有两条或多条链路时的LDP-IGP同步" class="headerlink" title="实验2：R1和R2之间仅有两条或多条链路时的LDP-IGP同步"></a>实验2：R1和R2之间仅有两条或多条链路时的LDP-IGP同步</h2><p>将R1和R2之间的由F0&#x2F;1相连的链路启用，让R1和R2之间形成双链路；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#no shutdown

<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#no shutdown</code></pre>

<p>查看R1的LDP邻居表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show mpls ldp neighbor
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token number">.52561</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">15</span><span class="token operator">/</span><span class="token number">15</span><span class="token punctuation">;</span> Downstream
        Up time<span class="token operator">:</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">36</span>
        LDP discovery sources<span class="token operator">:</span>
            FastEthernet0<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
            FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.2</span>
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>         <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>    <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.2</span> 
<span class="token comment">//可以看到，R1在F0/0和F0/1发现了LDP邻居；</span></code></pre>

<p>禁用R2上F0&#x2F;0的MPLS，让R1和R2的LDP邻居关系断开，确保LDP会话晚于OSPF邻接关系建立；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">0</span>  
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#no mpls ip</code></pre>

<p>此时，在经过将R2的F0&#x2F;0禁用MPLS之后，R1和R2的LDP邻居已经关系。接下来，重置OSPF进程：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#clear mpls ldp neighbor <span class="token operator">*</span>
R1# 
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">14.798</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>CLEAR_NBRS<span class="token operator">:</span> Clear LDP <span class="token function">neighbors</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> by console
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">14.810</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHG<span class="token operator">:</span> LDP Neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> is <span class="token function">DOWN</span> <span class="token punctuation">(</span>User cleared session manually<span class="token punctuation">)</span>
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">19.914</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHG<span class="token operator">:</span> LDP Neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> is UP
R1#clear ip ospf process
Reset ALL OSPF processes<span class="token operator">?</span> <span class="token punctuation">[</span>no<span class="token punctuation">]</span><span class="token operator">:</span> yes
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">27.098</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">1</span><span class="token punctuation">,</span> Nbr <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> on FastEthernet0<span class="token operator">/</span><span class="token number">1</span> from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">27.102</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">1</span><span class="token punctuation">,</span> Nbr <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> on FastEthernet0<span class="token operator">/</span><span class="token number">0</span> from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token operator">*</span>Mar <span class="token number">16</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">27.442</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">1</span><span class="token punctuation">,</span> Nbr <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> on FastEthernet0<span class="token operator">/</span><span class="token number">1</span> from LOADING to FULL<span class="token punctuation">,</span> Loading Done
<span class="token comment">//备注：快速输入命令查看R1接口F0/0的LDP与OSPF的同步信息；</span>
R1#sh ip ospf mpls ldp interface f0<span class="token operator">/</span><span class="token number">0</span>
FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    Process ID <span class="token number">1</span><span class="token punctuation">,</span> Area <span class="token number">0</span>
    LDP is not configured through LDP autoconfig
    LDP<span class="token operator">-</span>IGP Synchronization <span class="token operator">:</span> Required
    Holddown timer is configured <span class="token operator">:</span> <span class="token number">5000</span> msecs<span class="token comment">//LDP-IGP同步保持计时器被配置为5000毫秒；</span>
    Holddown timer is running and is expiring in <span class="token number">952</span> msecs<span class="token comment">//LDP-IGP保持计时器正在运行，并且将在952毫秒后到期超时；</span>
    Interface is down and pending LDP
<span class="token comment">//备注：快速输入命令查看R1接口F0/0的LDP与OSPF的同步信息；</span>
R1#sh ip ospf mpls ldp interface f0<span class="token operator">/</span><span class="token number">0</span>
FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    Process ID <span class="token number">1</span><span class="token punctuation">,</span> Area <span class="token number">0</span>
    LDP is not configured through LDP autoconfig
    LDP<span class="token operator">-</span>IGP Synchronization <span class="token operator">:</span> Required
    Holddown timer is configured <span class="token operator">:</span> <span class="token number">5000</span> msecs
    Holddown timer is not running<span class="token comment">//LDP-IGP保持计时器未在运行，说明保持计时器已经超时；</span>
    Interface is up and sending maximum metric<span class="token comment">//OSPF已经让接口UP，但却在发送最大度量值；</span>
<span class="token comment">//可以看到虽然OSPF邻接关系已经建立，但是由于LDP会话还没有建立，</span>
<span class="token comment">//所以OSPF向邻居通告的度量值为最大值65535，在具有多条链路同时能够达到目的地的情况下，</span>
<span class="token comment">//这一OSPF的这一动作确保此链路不会被用来转发数据；</span>
<span class="token comment">//从而防止了到达该此链路的数据包不会因不能被打上标签，而导致数据包被丢弃；</span></code></pre>

<p>查看R1的OSPF邻居表：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show ip ospf neighbor
Neighbor ID     Pri   State           Dead Time   Address         Interface
<span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>           <span class="token number">1</span>   FULL<span class="token operator">/</span>DR         <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">31</span>    <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.2</span>    FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>           <span class="token number">1</span>   FULL<span class="token operator">/</span>DR         <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">32</span>    <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>    FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token comment">//可以看到R1仍然从两个接口发现了OSPF邻居R2；</span></code></pre>

<p>查看R1的MPLS LDP邻居表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show mpls ldp neighbor
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token number">.64074</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">19</span><span class="token operator">/</span><span class="token number">19</span><span class="token punctuation">;</span> Downstream
        Up time<span class="token operator">:</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">03</span>
        LDP discovery sources<span class="token operator">:</span>
            FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.2</span>
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>         <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>    <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.2</span> 
<span class="token comment">//可以看到R1仅仅从F0/1发现了LDP邻居R2；</span></code></pre>

<p>查看R1的LFIB表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show mpls forwarding<span class="token operator">-</span>table
Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
Label      Label      or Tunnel Id     Switched      interface              
<span class="token number">16</span>         Pop Label  <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.2</span>
<span class="token comment">//可以看到仅有从F0/1学到标签；</span></code></pre>

<p>查看R1的IP路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override
                                                            
Gateway of last resort is not set
                                                            
        <span class="token number">1.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">2.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token comment">//虽然从两条链路学到路由，但是OSPF与LDP保持了一致，只使用其中走F0/1的路径；</span>
        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token comment">//注意：本来我以为虽然LFIB中只有走F0/1的一条出站路径，而路由表中会有两条OSPF路由，分别是从F0/0和F0/1学到的，但事实并非如此；</span>
<span class="token comment">//正是因为开启了LDP-IGP同步，所以造成了这样的结果；</span></code></pre>

<p>启用R2 f0&#x2F;0的MPLS；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">0</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#mpls ip</code></pre>

<p>查看R1上接口F0&#x2F;0的LDP-OSPF同步信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip ospf mpls ldp interface f0<span class="token operator">/</span><span class="token number">0</span>
FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
    Process ID <span class="token number">1</span><span class="token punctuation">,</span> Area <span class="token number">0</span>
    LDP is not configured through LDP autoconfig
    LDP<span class="token operator">-</span>IGP Synchronization <span class="token operator">:</span> Required
    Holddown timer is configured <span class="token operator">:</span> <span class="token number">5000</span> msecs
    Holddown timer is not running
    Interface is up
<span class="token comment">//注意：当R2的F0/0启用了MPLS后，R1的OSPF将接口F0/0度量值还原为了正常值；</span></code></pre>

<p>查看R1的LFIB表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls forwarding<span class="token operator">-</span>table
Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
Label      Label      or Tunnel Id     Switched      interface              
<span class="token number">16</span>         Pop Label  <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
            Pop Label  <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.2</span>
<span class="token comment">//当R2的F0/0启用了MPLS后，R1具有了两条等价的去往2.2.2.2的路径；</span></code></pre>

<p>查看R1的IP路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override

Gateway of last resort is not set

        <span class="token number">1.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">2.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">46</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token comment">//当LDP从F0/0和F0/1收到两条标签绑定信息后，路由表中同样有了两条路径；</span>
                        <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
```  
            
验证关闭LDP<span class="token operator">-</span>IGP同步后LFIB和IP路由表情况；
```c
<span class="token comment">//关闭LDP-IGP同步；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router os <span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no mpls ldp sync

<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#router os <span class="token number">1</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#no mpls ldp sync

<span class="token comment">//禁用R2上F0/0的MPLS；</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">0</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#no mpls ip</code></pre>

<p>查看R1的LIB表：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show mpls ip binding
    <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    <span class="token number">16</span>        lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">16</span>        
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
    <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span></code></pre>
<p>查看R1的LFIB表：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh mpls forwarding<span class="token operator">-</span>table
Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
Label      Label      or Tunnel Id     Switched      interface              
<span class="token number">16</span>         Pop Label  <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">1</span>      <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.2</span>
                No Label   <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span></code></pre>

<p>查看R1的IP路由表；</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#sh ip route
Codes<span class="token operator">:</span> L <span class="token operator">-</span> local<span class="token punctuation">,</span> C <span class="token operator">-</span> connected<span class="token punctuation">,</span> S <span class="token operator">-</span> <span class="token keyword">static</span><span class="token punctuation">,</span> R <span class="token operator">-</span> RIP<span class="token punctuation">,</span> M <span class="token operator">-</span> mobile<span class="token punctuation">,</span> B <span class="token operator">-</span> BGP
        D <span class="token operator">-</span> EIGRP<span class="token punctuation">,</span> EX <span class="token operator">-</span> EIGRP external<span class="token punctuation">,</span> O <span class="token operator">-</span> OSPF<span class="token punctuation">,</span> IA <span class="token operator">-</span> OSPF inter area 
        N1 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">1</span><span class="token punctuation">,</span> N2 <span class="token operator">-</span> OSPF NSSA external type <span class="token number">2</span>
        E1 <span class="token operator">-</span> OSPF external type <span class="token number">1</span><span class="token punctuation">,</span> E2 <span class="token operator">-</span> OSPF external type <span class="token number">2</span>
        i <span class="token operator">-</span> IS<span class="token operator">-</span>IS<span class="token punctuation">,</span> su <span class="token operator">-</span> IS<span class="token operator">-</span>IS summary<span class="token punctuation">,</span> L1 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> L2 <span class="token operator">-</span> IS<span class="token operator">-</span>IS level<span class="token operator">-</span><span class="token number">2</span>
        ia <span class="token operator">-</span> IS<span class="token operator">-</span>IS inter area<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token operator">-</span> candidate <span class="token keyword">default</span><span class="token punctuation">,</span> U <span class="token operator">-</span> per<span class="token operator">-</span>user <span class="token keyword">static</span> route
        o <span class="token operator">-</span> ODR<span class="token punctuation">,</span> P <span class="token operator">-</span> periodic downloaded <span class="token keyword">static</span> route<span class="token punctuation">,</span> H <span class="token operator">-</span> NHRP<span class="token punctuation">,</span> l <span class="token operator">-</span> LISP
        <span class="token operator">+</span> <span class="token operator">-</span> replicated route<span class="token punctuation">,</span> <span class="token operator">%</span> <span class="token operator">-</span> next hop override

Gateway of last resort is not set

        <span class="token number">1.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
C        <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> is directly connected<span class="token punctuation">,</span> Loopback0
        <span class="token number">2.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">32</span> is subnetted<span class="token punctuation">,</span> <span class="token number">1</span> subnets
O        <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
                        <span class="token punctuation">[</span><span class="token number">110</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> via <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">59</span><span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
L        <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
        <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is variably subnetted<span class="token punctuation">,</span> <span class="token number">2</span> subnets<span class="token punctuation">,</span> <span class="token number">2</span> masks
C        <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
L        <span class="token number">192.168</span><span class="token number">.21</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> is directly connected<span class="token punctuation">,</span> FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token comment">//注意：关闭LDP-IGP同步后，即使没有从F0/0口收到R2通告的标签，R1的路由表中还是出现两条去往2.2.2.2/32的等价路径；</span>
<span class="token comment">//如果这种情况出现是在MPLS VPN，AToM 或 VPLS环境中P路由器上，可以能会出现丢包现象；</span></code></pre>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_2/" class="post-title-link" itemprop="url">MPLS 实验2：MPLS LDP会话保护</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-14 22:23:41" itemprop="dateCreated datePublished" datetime="2014-03-14T22:23:41+08:00">2014-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>


<h1 id="理论：MPLS-LDP会话保护"><a href="#理论：MPLS-LDP会话保护" class="headerlink" title="理论：MPLS LDP会话保护"></a>理论：MPLS LDP会话保护</h1><p>在对两台直接连接LSR之间的LDP会话实施保护后，将会在这两台LSR之间建立基于目标的LDP会话。当这两台LSR之间的直连链路断开以后，只要这两台LSR之间存在可替代路径，基于目标的LDP会话将会得到维持。</p>
<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>Cisco IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h1><p><img src="/2014/MPLS_Lab_2/topo.png" alt="topology"></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-none"><code class="language-none">hostname R1
!
ip cef
!
multilink bundle-name authenticated
mpls label protocol ldp
!
interface Loopback0
    ip address 1.1.1.1 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.1 255.255.255.0
    ip ospf 1 area 0
    no shut
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.14.1 255.255.255.0
    ip ospf 1 area 0
    no shut
mpls ip
!
router ospf 1
    router-id 1.1.1.1
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R2"><a href="#R2" class="headerlink" title="R2:"></a>R2:</h2><pre class="language-none"><code class="language-none">hostname R2
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 2.2.2.2 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.2 255.255.255.0
    ip ospf 1 area 0
    no shut
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.2 255.255.255.0
    ip ospf 1 area 0
    no shut
mpls ip
!
router ospf 1
    router-id 2.2.2.2
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R3"><a href="#R3" class="headerlink" title="R3:"></a>R3:</h2><pre class="language-none"><code class="language-none">hostname R3
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 3.3.3.3 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.3 255.255.255.0
    ip ospf 1 area 0
    no shut
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.3 255.255.255.0
    ip ospf 1 area 0
    no shut
mpls ip
!
router ospf 1
    router-id 3.3.3.3
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>

<h2 id="R4"><a href="#R4" class="headerlink" title="R4:"></a>R4:</h2><pre class="language-none"><code class="language-none">hostname R4
!
ip cef
!
mpls label protocol ldp
!
interface Loopback0
    ip address 4.4.4.4 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.4 255.255.255.0
    ip ospf 1 area 0
    no shut
mpls ip
!
interface FastEthernet0&#x2F;1
    ip address 192.168.14.4 255.255.255.0
    ip ospf 1 area 0
    no shut
mpls ip
!
router ospf 1
    router-id 4.4.4.4
!
mpls ldp router-id Loopback0 force
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>


<h1 id="实验与调试："><a href="#实验与调试：" class="headerlink" title="实验与调试："></a>实验与调试：</h1><h2 id="实验1：两台LSR相互将对方配置为受MPLS-LDP会话保护的对等体；"><a href="#实验1：两台LSR相互将对方配置为受MPLS-LDP会话保护的对等体；" class="headerlink" title="实验1：两台LSR相互将对方配置为受MPLS LDP会话保护的对等体；"></a>实验1：两台LSR相互将对方配置为受MPLS LDP会话保护的对等体；</h2><p>配置ACL来指定需要被保护的LDP对等体；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip access<span class="token operator">-</span>list standard PROTECT_R4
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#permit host <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#exit</code></pre>

<p>配置MPLS LDP会话保护，并将其与指定需要保护的LDP对等体ACL相关联；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp session protection <span class="token keyword">for</span> PROTECT_R4 duration <span class="token operator">?</span>
    <span class="token operator">&lt;</span><span class="token number">30</span><span class="token operator">-</span><span class="token number">2147483</span><span class="token operator">></span>  Holdup time in seconds
    infinite      Protect session forever after loss of link discovery
<span class="token comment">//选项duration指出持续时间，持续时间指的是在LDP链路的邻接关系断掉以后，需要得到保护（基于目标的LDP会话）的周期时间；</span>

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp session protection <span class="token keyword">for</span> PROTECT_R4</code></pre>

<p>验证：查看R1的MPLS LDP邻居列表中邻居R4的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp nei <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> detail            
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.40199</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
        Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">61</span><span class="token operator">/</span><span class="token number">59</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">16</span>
        Up time<span class="token operator">:</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">56</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> Peer Id <span class="token number">1</span><span class="token punctuation">;</span>
        LDP discovery sources<span class="token operator">:</span>
          FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">;</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.4</span> 
            holdtime<span class="token operator">:</span> <span class="token number">15000</span> ms<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
          <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span>    <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.4</span>    
        Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
        Clients<span class="token operator">:</span> Dir Adj Client
        LDP Session Protection enabled<span class="token punctuation">,</span> state<span class="token operator">:</span> Incomplete <span class="token comment">//可以看到针对邻居4.4.4.4,LDP会话保护已经启用；但因R1端还未配置，所以状态为Incomplete；</span>
            acl<span class="token operator">:</span> PROTECT_R4<span class="token punctuation">,</span> duration<span class="token operator">:</span> <span class="token number">86400</span> seconds <span class="token comment">//持续保护时间为86400秒，即24小时；</span>
        Capabilities Sent<span class="token operator">:</span>
          <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
          <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
          <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        Capabilities Received<span class="token operator">:</span>
          <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
          <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
          <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>
<p>注意：根据《MPLS Fundamental》86页所述，默认的持续时间（Duration）为无限期，即永远，<br>但是经过试验发现，如果不指明选项duration，则持续保护时间为86400秒，即24小时；</p>
<p>而明确指定 duration 为 infinite（无限期）之后，持续保护时间才真正变为了 infinite（无限期）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp session protection <span class="token keyword">for</span> PROTECT_R4 duration infinite </code></pre>

<p>验证：查看R1的MPLS LDP邻居列表中邻居R4的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp nei <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> detail                           
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.40199</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
        Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">70</span><span class="token operator">/</span><span class="token number">69</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">16</span>
        Up time<span class="token operator">:</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> Peer Id <span class="token number">1</span><span class="token punctuation">;</span>
        LDP discovery sources<span class="token operator">:</span>
            FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">;</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.4</span> 
            holdtime<span class="token operator">:</span> <span class="token number">15000</span> ms<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span>    <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.4</span>    
        Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
        Clients<span class="token operator">:</span> Dir Adj Client
        LDP Session Protection enabled<span class="token punctuation">,</span> state<span class="token operator">:</span> Incomplete  <span class="token comment">//可以看到针对邻居4.4.4.4,LDP会话保护已经启用；但因R1端还未配置，所以状态为Incomplete；</span>
            acl<span class="token operator">:</span> PROTECT_R4<span class="token punctuation">,</span> duration<span class="token operator">:</span> infinite<span class="token comment">//持续保护时间为无限期，即永远保护；</span>
        Capabilities Sent<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        Capabilities Received<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>
<p>而当指定了duration为无限期（infinite）之后，持续保护时间才真正变为了infinite（无限期）；</p>
<p>验证：查看R4的MPLS LDP邻居列表中邻居R1的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp nei <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> detail
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span> <span class="token operator">-</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.40199</span>
        Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">85</span><span class="token operator">/</span><span class="token number">86</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">16</span>
        Up time<span class="token operator">:</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> Peer Id <span class="token number">1</span><span class="token punctuation">;</span>
        LDP discovery sources<span class="token operator">:</span>
            FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">;</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.1</span> 
            holdtime<span class="token operator">:</span> <span class="token number">15000</span> ms<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span>    <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.1</span>    <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>         
        Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
        Capabilities Sent<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        Capabilities Received<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>
<p>注意到，虽然此时R1上已经配置了针对邻居R4的LDP会话保护，但是由于R4上未做配置，所以在R4看来，仿佛这一切的一切并未发生过一般；</p>
<p>配置ACL来指定需要被保护的LDP对等体；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip access<span class="token operator">-</span>list standard PROTECT_R1
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#permit host <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#exit</code></pre>

<p>配置MPLS LDP会话保护，并将其与指定需要保护的LDP对等体ACL相关联；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp session protection <span class="token keyword">for</span> PROTECT_R1 duration infinite</code></pre>
<p>验证：查看R4的MPLS LDP邻居列表中邻居R1的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp nei <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> detail                           
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span> <span class="token operator">-</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.40199</span>
        Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">101</span><span class="token operator">/</span><span class="token number">103</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">16</span>
        Up time<span class="token operator">:</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> Peer Id <span class="token number">1</span><span class="token punctuation">;</span>
        LDP discovery sources<span class="token operator">:</span>
            FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">;</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.1</span> 
            holdtime<span class="token operator">:</span> <span class="token number">15000</span> ms<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms
            Targeted Hello <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token operator">-></span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> active<span class="token punctuation">,</span> passive<span class="token punctuation">;</span><span class="token comment">//基于目标的远程LDP会话已经建立；</span>
            holdtime<span class="token operator">:</span> infinite<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">10000</span> ms
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span>    <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.1</span>    <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>         
        Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
        Clients<span class="token operator">:</span> Dir Adj Client
        LDP Session Protection enabled<span class="token punctuation">,</span> state<span class="token operator">:</span> Ready <span class="token comment">//可以看到R4针对邻居R1的LDP会话保护已经开启，并且状态为Ready，表示已经做好会话保护准备；</span>
            acl<span class="token operator">:</span> PROTECT_R1<span class="token punctuation">,</span> duration<span class="token operator">:</span> infinite<span class="token comment">//持续保护时间为无限期，即永远保护；</span>
        Capabilities Sent<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        Capabilities Received<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>

<p>验证：查看R1的MPLS LDP邻居列表中邻居R4的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp nei <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> detail
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.40199</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
        Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">108</span><span class="token operator">/</span><span class="token number">106</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">16</span>
        Up time<span class="token operator">:</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> Peer Id <span class="token number">1</span><span class="token punctuation">;</span>
        LDP discovery sources<span class="token operator">:</span>
            FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">;</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.4</span> 
            holdtime<span class="token operator">:</span> <span class="token number">15000</span> ms<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms
            Targeted Hello <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token operator">-></span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span> active<span class="token punctuation">,</span> passive<span class="token punctuation">;</span><span class="token comment">//基于目标的远程LDP会话已经建立；</span>
            holdtime<span class="token operator">:</span> infinite<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">10000</span> ms
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span>    <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.4</span>    
        Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
        Clients<span class="token operator">:</span> Dir Adj Client
        LDP Session Protection enabled<span class="token punctuation">,</span> state<span class="token operator">:</span> Ready<span class="token comment">//可以看到R4针对邻居R1的LDP会话保护已经开启，并且状态为Ready，表示已经做好会话保护准备；</span>
            acl<span class="token operator">:</span> PROTECT_R4<span class="token punctuation">,</span> duration<span class="token operator">:</span> infinite<span class="token comment">//持续保护时间为无限期，即永远保护；</span>
        Capabilities Sent<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        Capabilities Received<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>

<p>调试：断开R1和R4之间的直连链路；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//将R1上与R4相连的F0/1口shutdown；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#shutdown
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">15</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">27.663</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>SP<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span> session hold up initiated  <span class="token comment">//LDP会话保护机制已经开始初始化；</span>
<span class="token operator">*</span>Mar <span class="token number">15</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">27.675</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">1</span><span class="token punctuation">,</span> Nbr <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> on FastEthernet0<span class="token operator">/</span><span class="token number">1</span> from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">15</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">29.619</span><span class="token operator">:</span> <span class="token operator">%</span>LINK<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>CHANGED<span class="token operator">:</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span> changed state to administratively down
<span class="token operator">*</span>Mar <span class="token number">15</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">30.619</span><span class="token operator">:</span> <span class="token operator">%</span>LINEPROTO<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>UPDOWN<span class="token operator">:</span> Line protocol on Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span> changed state to down</code></pre>

<p>验证：查看R1的MPLS LDP邻居列表中邻居R4的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp nei <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> detail
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.40199</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
        Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">120</span><span class="token operator">/</span><span class="token number">116</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">18</span>
        Up time<span class="token operator">:</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">32</span><span class="token operator">:</span><span class="token number">26</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> Peer Id <span class="token number">1</span><span class="token punctuation">;</span>
        LDP discovery sources<span class="token operator">:</span>
            Targeted Hello <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token operator">-></span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span> active<span class="token punctuation">,</span> passive<span class="token punctuation">;</span>
            holdtime<span class="token operator">:</span> infinite<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">10000</span> ms
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span>    <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.4</span>    
        Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
        Clients<span class="token operator">:</span> Dir Adj Client
        LDP Session Protection enabled<span class="token punctuation">,</span> state<span class="token operator">:</span> Protecting <span class="token comment">//LDP会话保护正在进行中，状态为Protecting；</span>
            acl<span class="token operator">:</span> PROTECT_R4<span class="token punctuation">,</span> duration<span class="token operator">:</span> infinite
        Capabilities Sent<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        Capabilities Received<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>
<p>查看R1的LIB表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ldp bindings
    lib entry<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">2</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">16</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">16</span>
    lib entry<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">8</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">16</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">17</span>
    lib entry<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">13</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">18</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">18</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">18</span>
    lib entry<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">16</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">20</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">20</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">4</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">19</span>
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">18</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">21</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">17</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">10</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">17</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">20</span>
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">14</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">19</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">19</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ip binding
    <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    <span class="token number">16</span>        lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>       
        out label<span class="token operator">:</span>    <span class="token number">16</span>        lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">16</span>        
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    <span class="token number">17</span>        lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">18</span>        
        out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">20</span>        
        out label<span class="token operator">:</span>    <span class="token number">20</span>        lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>       
        out label<span class="token operator">:</span>    <span class="token number">19</span>        lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     <span class="token number">21</span>        
        out label<span class="token operator">:</span>    <span class="token number">17</span>        lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     <span class="token number">17</span>        
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    <span class="token number">20</span>        lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     <span class="token number">19</span>        
        out label<span class="token operator">:</span>    <span class="token number">19</span>        lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>  
<span class="token comment">//可以看到，即便R1与R4的直连链路已经断开，但是R1的LIB表中仍然保留着通告自R4的标签绑定信息；</span></code></pre>
<p>验证：查看R4的MPLS LDP邻居列表中邻居R1的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp nei <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> detail
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span> <span class="token operator">-</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.40199</span>
        Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">117</span><span class="token operator">/</span><span class="token number">121</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">16</span>
        Up time<span class="token operator">:</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> Peer Id <span class="token number">1</span><span class="token punctuation">;</span>
        LDP discovery sources<span class="token operator">:</span>
            Targeted Hello <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token operator">-></span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> active<span class="token punctuation">,</span> passive<span class="token punctuation">;</span>
            holdtime<span class="token operator">:</span> infinite<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">10000</span> ms
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span>    <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>         
        Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
        Clients<span class="token operator">:</span> Dir Adj Client
        LDP Session Protection enabled<span class="token punctuation">,</span> state<span class="token operator">:</span> Protecting <span class="token comment">//LDP会话保护正在进行中，状态为Protecting；</span>
            acl<span class="token operator">:</span> PROTECT_R1<span class="token punctuation">,</span> duration<span class="token operator">:</span> infinite
        Capabilities Sent<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        Capabilities Received<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>

<p>查看R4到LIB表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ldp bindings
    lib entry<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">2</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">16</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">17</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
    lib entry<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">4</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">17</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">16</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">16</span>
    lib entry<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">6</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">18</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">18</span>
    lib entry<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">8</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">20</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">20</span>
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">10</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">19</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">19</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">12</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">18</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">21</span>
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">14</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">20</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">17</span>
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">16</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">19</span>

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ip binding
    <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">16</span>        
        out label<span class="token operator">:</span>    <span class="token number">17</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">17</span>        
        out label<span class="token operator">:</span>    <span class="token number">16</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    <span class="token number">16</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">18</span>        
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    <span class="token number">20</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>       
        out label<span class="token operator">:</span>    <span class="token number">20</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     <span class="token number">19</span>        
        out label<span class="token operator">:</span>    <span class="token number">19</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>       
        out label<span class="token operator">:</span>    <span class="token number">21</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     <span class="token number">20</span>        
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    <span class="token number">17</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>       
        out label<span class="token operator">:</span>    <span class="token number">19</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span> 
<span class="token comment">//可以看到，即便R1与R4的直连链路已经断开，但是R4的LIB表中仍然保留着通告自R1的标签绑定信息；</span></code></pre>

<p>调试：恢复R1和R4之间的链路连接；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#no shut
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">15</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">21.407</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>SP<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span> session recovery succeeded <span class="token comment">//R1与R4的会话恢复成功；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">15</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">23.279</span><span class="token operator">:</span> <span class="token operator">%</span>LINK<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span>UPDOWN<span class="token operator">:</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span> changed state to up
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">15</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">24.279</span><span class="token operator">:</span> <span class="token operator">%</span>LINEPROTO<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>UPDOWN<span class="token operator">:</span> Line protocol on Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span> changed state to up</code></pre>
<h2 id="实验2：两台LSR中只有一台支持LDP会话保护特性"><a href="#实验2：两台LSR中只有一台支持LDP会话保护特性" class="headerlink" title="实验2：两台LSR中只有一台支持LDP会话保护特性"></a>实验2：两台LSR中只有一台支持LDP会话保护特性</h2><p>要让 LDP 会话保护特性正常工作，你需要在两端的 LSR 上都启用该特性。如果其中一台 LSR 无法实现该特性的话，可以在另一台LSR上启用该特性，而无法启用 LDP 会话保护的 LSR 上需要通过配置命令 <code>mpls ldp discovery targeted-hello accept</code> 来接受基于目标的 LDP Discovery Hello报文。 </p>
<p>配置ACL指定接受其远程LDP会话LSR；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip access<span class="token operator">-</span>list standard ACCEPT_R1_REMOTE
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#permit host <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#exit</code></pre>

<p>配置R4接受来自ACCEPT_R1_REMOTE的远程LDP会话；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp discovery targeted<span class="token operator">-</span>hello accept from ACCEPT_R1_REMOTE    </code></pre>

<p>验证：查看R4的MPLS LDP邻居列表中邻居R1的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp nei <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> detail                              
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span> <span class="token operator">-</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.40199</span>
        Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">141</span><span class="token operator">/</span><span class="token number">146</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">16</span>
        Up time<span class="token operator">:</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">47</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> Peer Id <span class="token number">1</span><span class="token punctuation">;</span>
        LDP discovery sources<span class="token operator">:</span>
            FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">;</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.1</span> 
            holdtime<span class="token operator">:</span> <span class="token number">15000</span> ms<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms
            Targeted Hello <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token operator">-></span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> passive<span class="token punctuation">;</span> <span class="token comment">//R4被动接受来自R1的远程LDP会话；关键字passive表示R4是被动方，被动接受与R1的远程LDP会话关系：</span>
            holdtime<span class="token operator">:</span> <span class="token number">90000</span> ms<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">10000</span> ms
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span>    <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>         <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.1</span>    
        Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
        Capabilities Sent<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        Capabilities Received<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>

<p>验证：查看R1的MPLS LDP邻居列表中邻居R4的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ldp neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> detail
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.40199</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
        Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">146</span><span class="token operator">/</span><span class="token number">140</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">20</span>
        Up time<span class="token operator">:</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">35</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> Peer Id <span class="token number">1</span><span class="token punctuation">;</span>
        LDP discovery sources<span class="token operator">:</span>
            FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">;</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.4</span> 
            holdtime<span class="token operator">:</span> <span class="token number">15000</span> ms<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms
            Targeted Hello <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token operator">-></span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span> active<span class="token punctuation">,</span> passive<span class="token punctuation">;</span> <span class="token comment">//R1与R4已建立远程LDP会话；关键字active和passive表示R1是远程会话的主动发起方和被动接受方；</span>
            holdtime<span class="token operator">:</span> infinite<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">10000</span> ms
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span>    <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.4</span>    
        Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
        Clients<span class="token operator">:</span> Dir Adj Client
        LDP Session Protection enabled<span class="token punctuation">,</span> state<span class="token operator">:</span> Ready <span class="token comment">//R1上针对邻居R4的LDP会话保护已经启用；并且状态为Ready，表示已经做了会话保护准备；</span>
            acl<span class="token operator">:</span> PROTECT_R4<span class="token punctuation">,</span> duration<span class="token operator">:</span> infinite
        Capabilities Sent<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        Capabilities Received<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token comment">//可以看到，即使R4没有启用LDP会话保护特性，但只要R4接受来自R1基于目标的远程LDP会话报文，R1的LDP会话保护特性就可以正常运作；</span></code></pre>

<p>调试：断开R1与R4之间的链路连接；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//在R1上，将连接到R4的F0/1口shutdown；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">int</span> f0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#shutdown
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">15</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">34.939</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>SP<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span> session hold up initiated <span class="token comment">//R1上针对R4的LDP会话保护机制开始初始化；</span>
<span class="token operator">*</span>Mar <span class="token number">15</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">34.951</span><span class="token operator">:</span> <span class="token operator">%</span>OSPF<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>ADJCHG<span class="token operator">:</span> Process <span class="token number">1</span><span class="token punctuation">,</span> Nbr <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> on FastEthernet0<span class="token operator">/</span><span class="token number">1</span> from FULL to DOWN<span class="token punctuation">,</span> Neighbor Down<span class="token operator">:</span> Interface down or detached
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">15</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">36.899</span><span class="token operator">:</span> <span class="token operator">%</span>LINK<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>CHANGED<span class="token operator">:</span> Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span> changed state to administratively down
<span class="token operator">*</span>Mar <span class="token number">15</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">37.899</span><span class="token operator">:</span> <span class="token operator">%</span>LINEPROTO<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>UPDOWN<span class="token operator">:</span> Line protocol on Interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span> changed state to down</code></pre>

<p>验证：查看R1的MPLS LDP邻居列表中邻居R4的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp nei <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> detail  
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.40199</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
        Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">175</span><span class="token operator">/</span><span class="token number">168</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">22</span>
        Up time<span class="token operator">:</span> <span class="token number">02</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">35</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> Peer Id <span class="token number">1</span><span class="token punctuation">;</span>
        LDP discovery sources<span class="token operator">:</span>
            Targeted Hello <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token operator">-></span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span> active<span class="token punctuation">,</span> passive<span class="token punctuation">;</span>
            holdtime<span class="token operator">:</span> infinite<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">10000</span> ms
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span>    <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.4</span>    
        Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
        Clients<span class="token operator">:</span> Dir Adj Client
        LDP Session Protection enabled<span class="token punctuation">,</span> state<span class="token operator">:</span> Protecting <span class="token comment">//R1针对邻居R4的LDP会话保护状态变为Protecting；</span>
            acl<span class="token operator">:</span> PROTECT_R4<span class="token punctuation">,</span> duration<span class="token operator">:</span> infinite
        Capabilities Sent<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        Capabilities Received<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>

<p>查看R1的LIB表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp bindings
    lib entry<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">2</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">16</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">16</span>
    lib entry<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">8</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">16</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">17</span>
    lib entry<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">13</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">18</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">18</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">18</span>
    lib entry<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">16</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">20</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">20</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">4</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">19</span>
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">22</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">21</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">17</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">10</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">17</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">20</span>
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">14</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">19</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">19</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null

<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ip binding
    <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    <span class="token number">16</span>        lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>       
        out label<span class="token operator">:</span>    <span class="token number">16</span>        lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">16</span>        
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    <span class="token number">17</span>        lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">18</span>        
        out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">20</span>        
        out label<span class="token operator">:</span>    <span class="token number">20</span>        lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>       
        out label<span class="token operator">:</span>    <span class="token number">19</span>        lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     <span class="token number">21</span>        
        out label<span class="token operator">:</span>    <span class="token number">17</span>        lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     <span class="token number">17</span>        
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    <span class="token number">20</span>        lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     <span class="token number">19</span>        
        out label<span class="token operator">:</span>    <span class="token number">19</span>        lsr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>   
<span class="token comment">//注意到，由于LDP会话保护机制，R1的LIB表中仍然保留着R4通告来的标签；</span></code></pre>

<p>验证：查看R4的MPLS LDP邻居列表中邻居R1的详细信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ldp nei <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> detail
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span> <span class="token operator">-</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.40199</span>
        Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">201</span><span class="token operator">/</span><span class="token number">208</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">16</span>
        Up time<span class="token operator">:</span> <span class="token number">02</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> Peer Id <span class="token number">1</span><span class="token punctuation">;</span>
        LDP discovery sources<span class="token operator">:</span>
            Targeted Hello <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token operator">-></span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> passive<span class="token punctuation">;</span>
            holdtime<span class="token operator">:</span> <span class="token number">90000</span> ms<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">10000</span> ms
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span>    <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>         
        Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
        Capabilities Sent<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        Capabilities Received<span class="token operator">:</span>
            <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token comment">//虽然R4没有启用LDP会话保护，但是R4仍然和R1保持着基于目标的LDP远程会话；</span></code></pre>

<p>查看R4的LIB表；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ldp bindings
    lib entry<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">2</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">16</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">17</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
    lib entry<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">4</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">17</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">16</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">16</span>
    lib entry<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">6</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">18</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">18</span>
    lib entry<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">8</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">20</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">20</span>
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">10</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">19</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">19</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">12</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">18</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">21</span>
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">14</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">20</span>
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">17</span>
    lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">16</span>
        local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
        remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">19</span>

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ip binding
    <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">16</span>        
        out label<span class="token operator">:</span>    <span class="token number">17</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">17</span>        
        out label<span class="token operator">:</span>    <span class="token number">16</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    <span class="token number">16</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     <span class="token number">18</span>        
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    <span class="token number">20</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>       
        out label<span class="token operator">:</span>    <span class="token number">20</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     <span class="token number">19</span>        
        out label<span class="token operator">:</span>    <span class="token number">19</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.14</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>       
        out label<span class="token operator">:</span>    <span class="token number">21</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     <span class="token number">20</span>        
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
        out label<span class="token operator">:</span>    <span class="token number">17</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
    <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
        in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
        out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>       
        out label<span class="token operator">:</span>    <span class="token number">19</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>      
<span class="token comment">//注意到，虽然R4没有启用LDP会话保护机制，但是R4的LIB表中同样保留着R1通告来的标签；</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ifelif.cn/2014/MPLS_Lab_1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="filefi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经人谁写日记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正经人谁写日记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/MPLS_Lab_1/" class="post-title-link" itemprop="url">MPLS 实验1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-03-14 19:00:41" itemprop="dateCreated datePublished" datetime="2014-03-14T19:00:41+08:00">2014-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>

<h1 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h1><ul>
<li>模拟器：GNS3 0.8.6</li>
<li>路由器IOS：c7200-adventerprisek9-mz.151-4.M2.image</li>
</ul>
<h1 id="GNS3实验拓扑文件："><a href="#GNS3实验拓扑文件：" class="headerlink" title="GNS3实验拓扑文件："></a>GNS3实验拓扑文件：</h1><p><a href="topology.net">拓扑文件</a></p>
<h1 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h1><p><img src="/2014/MPLS_Lab_1/topo.png"></p>
<h1 id="基本预配置："><a href="#基本预配置：" class="headerlink" title="基本预配置："></a>基本预配置：</h1><h2 id="R1："><a href="#R1：" class="headerlink" title="R1："></a>R1：</h2><pre class="language-none"><code class="language-none">hostname R1
!
ip cef
!
interface Loopback0
    ip address 1.1.1.1 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.1 255.255.255.0
    ip ospf 1 area 0
    no shut
!
interface FastEthernet0&#x2F;1
    ip address 192.168.15.1 255.255.255.0
    no shut
!
router ospf 1
    router-id 1.1.1.1
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>
<h2 id="R2："><a href="#R2：" class="headerlink" title="R2："></a>R2：</h2><pre class="language-none"><code class="language-none">hostname R2
!
ip cef
!
interface Loopback0
    ip address 2.2.2.2 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.12.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.2 255.255.255.0
    ip ospf 1 area 0
    no shutdown
!
router ospf 1
    router-id 2.2.2.2
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>
<h2 id="R3："><a href="#R3：" class="headerlink" title="R3："></a>R3：</h2><pre class="language-none"><code class="language-none">hostname R3
!
ip cef
!
interface Loopback0
    ip address 3.3.3.3 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.3 255.255.255.0
    ip ospf 1 area 0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.23.3 255.255.255.0
    ip ospf 1 area 0
    no shutdown
!
router ospf 1
    router-id 3.3.3.3
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>
<h2 id="R4："><a href="#R4：" class="headerlink" title="R4："></a>R4：</h2><pre class="language-none"><code class="language-none">hostname R4
!
ip cef
!
interface Loopback0
    ip address 4.4.4.4 255.255.255.255
    ip ospf 1 area 0
!
interface FastEthernet0&#x2F;0
    ip address 192.168.34.4 255.255.255.0
    ip ospf 1 area 0
    no shutdown
!
interface FastEthernet0&#x2F;1
    ip address 192.168.47.4 255.255.255.0
    no shutdown
!
router ospf 1
    router-id 4.4.4.4
!
line con 0
    exec-timeout 0 0
    logging synchronous
!
end</code></pre>
<h1 id="实验与调试（本实验仅涉及AS1中的4台路由器）："><a href="#实验与调试（本实验仅涉及AS1中的4台路由器）：" class="headerlink" title="实验与调试（本实验仅涉及AS1中的4台路由器）："></a>实验与调试（本实验仅涉及AS1中的4台路由器）：</h1><h2 id="实验1：MPLS基本配置与验证：AS1作为MPLS域，在AS1中的所有路由器上运行MPLS；"><a href="#实验1：MPLS基本配置与验证：AS1作为MPLS域，在AS1中的所有路由器上运行MPLS；" class="headerlink" title="实验1：MPLS基本配置与验证：AS1作为MPLS域，在AS1中的所有路由器上运行MPLS；"></a>实验1：MPLS基本配置与验证：AS1作为MPLS域，在AS1中的所有路由器上运行MPLS；</h2><p>可以使用命令<code>mpls label protocol &#123;ldp | tdp&#125;</code> ,来指定标签分发协议；<br>可以看到支持两种标签分发协议，LDP和TDP，默认使用LDP作为标签分发协议；</p>
<pre class="language-none"><code class="language-none">R1(config)#mpls label protocol ?
 ldp  Use LDP (default)
 tdp  Use TDP

R1(config)#mpls label protocol ldp</code></pre>
<p>可以使用命令<code>mpls ldp router-id interface [force]</code>来强制改变LDP路由ID；<br>如果不指定LDP router-id则LDP router-id选举规则同 OSPF ；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//手动指定R1将l0接口地址作为LDP router-id的一部分，force选项表示立即生效；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp router<span class="token operator">-</span>id l0 force</code></pre>

<p>使用接口命令<code>mpls ip</code>，在R1所有已激活的接口上启用MPLS ：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#mpls ip</code></pre>

<p>可以看到在R1的loopback 0接口配置启用MPLS时，IOS日志提示回环接口不支持MPLS ：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#interface Loopback0
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#mpls ip
<span class="token operator">%</span> MPLS not supported on interface Loopback0</code></pre>


<p>在R2上，使用 LDP 作为 MPLS 标签分发协议，指定 loopback 0 作为 LDP 的 <code>router-id</code>，并使用接口命令 <code>mpls ip</code> ，在适当的的接口上启用 MPLS ；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls label protocol ldp
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp router<span class="token operator">-</span>id l0 force

<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#mpls ip

<span class="token operator">*</span>Mar  <span class="token number">1</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">05.223</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHG<span class="token operator">:</span> LDP Neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> is UP

<span class="token comment">// 可以看到LDP邻居变化日志提示，LDP邻居已经UP，邻居为1.1.1.1:0；</span>

<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#interface FastEthernet0<span class="token operator">/</span><span class="token number">1</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#mpls ip</code></pre>
<p>在R3上，使用LDP作为MPLS标签分发协议，指定loopback 0作为LDP的<code>router-id</code>，并使用接口命令<code>mpls ip</code>，在适当的的接口上启用MPLS；</p>
<pre class="language-none"><code class="language-none">R3(config)#mpls label protocol ldp
R3(config)#mpls ldp router-id l0 force

R3(config-if)#interface FastEthernet0&#x2F;0
R3(config-if)#mpls ip
R3(config-if)#interface FastEthernet0&#x2F;1
R3(config-if)#mpls ip</code></pre>

<p>在R4上，使用 LDP 作为 MPLS 标签分发协议，指定 loopback 0 作为 LDP 的<code>router-id</code>，并使用接口命令<code>mpls ip</code>，在适当的的接口上启用 MPLS ；</p>
<pre class="language-none"><code class="language-none">R4(config)#mpls label protocol ldp
R4(config)#mpls ldp router-id l0 force

R4(config-if)#interface FastEthernet0&#x2F;0
R4(config-if)#mpls ip</code></pre>

<p><strong>抓包查看分析LDP包结构：</strong><br><img src="/2014/MPLS_Lab_1/pic1.png"><br><img src="/2014/MPLS_Lab_1/pic2.png"><br>可以看到LDP hello包使用UDP进行封装，而Keep Alive包使用TCP进行封装；</p>
<p><strong>附件：</strong><a href="LDP.pcapng">Wireshark抓包文件</a></p>
<p>在 R1 上查看启用 MPLS 的接口：</p>
<pre class="language-none"><code class="language-none">R1(config)#do show mpls interface
Interface              IP            Tunnel   BGP Static Operational
FastEthernet0&#x2F;0        Yes (ldp)     No       No  No     Yes</code></pre>
<p>R1上只用<code>f0/0</code>启用了 MPLS ，可以看到 MPLS 使用 LDP 作为标签分发协议；</p>
<p>在R1上查看LDP邻居发现：</p>
<pre class="language-none"><code class="language-none">R1#show mpls ldp discovery 
 Local LDP Identifier:
  1.1.1.1:0
  Discovery Sources:
  Interfaces:
    FastEthernet0&#x2F;0 (ldp): xmit&#x2F;recv
      LDP Id: 2.2.2.2:0</code></pre>
<ul>
<li>可以看到R1本地的LDP标识符为<code>1.1.1.1:0</code>，其中LDP路由器标识符由两部分组成：<ul>
<li>其中第一部分为接口IP地址；</li>
<li>第二部分为LSR所使用的标签空间字节。如果为0则表示LSR是使用整个设备的标签空间，如果不为0则表示LSR是使用接口标签空间；</li>
</ul>
</li>
<li>还可以看出，R1在启用LDP的接口f0&#x2F;0上发现了LDP邻居;</li>
</ul>
<p>在R1上查看LDP邻居发现详细信息：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show mpls ldp discovery detail 
    Local LDP Identifier<span class="token operator">:</span>
    <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
    Discovery Sources<span class="token operator">:</span>
    Interfaces<span class="token operator">:</span>
        FastEthernet0<span class="token operator">/</span><span class="token number">0</span> <span class="token punctuation">(</span>ldp<span class="token punctuation">)</span><span class="token operator">:</span> xmit<span class="token operator">/</span>recv
            Enabled<span class="token operator">:</span> Interface config    
            Hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms<span class="token punctuation">;</span> Transport IP addr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>   <span class="token comment">//Discovery hello时间间隔为5秒；</span>
            LDP Id<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>
                Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">;</span> Transport IP addr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
                Hold time<span class="token operator">:</span> <span class="token number">15</span> sec<span class="token punctuation">;</span> Proposed local<span class="token operator">/</span>peer<span class="token operator">:</span> <span class="token number">15</span><span class="token operator">/</span><span class="token number">15</span> sec  <span class="token comment">//Discovery保持时间为15秒；</span>
                Reachable via <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span></code></pre>
<p>在R1上查看LDP邻居关系：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show mpls ldp neighbor 
    Peer LDP Ident<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
        TCP connection<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token number">.13634</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
        State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">643</span><span class="token operator">/</span><span class="token number">640</span><span class="token punctuation">;</span> Downstream
        Up time<span class="token operator">:</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">15</span>
        LDP discovery sources<span class="token operator">:</span>
            FastEthernet0<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>
        Addresses bound to peer LDP Ident<span class="token operator">:</span>
            <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>    <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span>    <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>   </code></pre>
<ul>
<li>可以看到R1有一个LDP邻居，并且邻居标识符为2.2.2.2:0；</li>
<li>而R1本地的LDP标识符为1.1.1.1:0;TCP连接为2.2.2.2的13634端口到1.1.1.1的646端口；</li>
<li>邻居已经建立了9个小时11分15秒；</li>
<li>LDP发现源为f0&#x2F;0接口，地址为f0&#x2F;0的接口地址192.168.12.2；</li>
</ul>
<p>在R1上<code>traceroute 4.4.4.4</code>：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> traceroute <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
Type escape sequence to abort<span class="token punctuation">.</span>
Tracing the route to <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
VRF info<span class="token operator">:</span> <span class="token punctuation">(</span>vrf in name<span class="token operator">/</span>id<span class="token punctuation">,</span> vrf out name<span class="token operator">/</span>id<span class="token punctuation">)</span>
    <span class="token number">1</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> <span class="token punctuation">[</span>MPLS<span class="token operator">:</span> Label <span class="token number">18</span> Exp <span class="token number">0</span><span class="token punctuation">]</span> <span class="token number">76</span> msec <span class="token number">80</span> msec <span class="token number">76</span> msec
    <span class="token number">2</span> <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.3</span> <span class="token punctuation">[</span>MPLS<span class="token operator">:</span> Label <span class="token number">18</span> Exp <span class="token number">0</span><span class="token punctuation">]</span> <span class="token number">96</span> msec <span class="token number">44</span> msec <span class="token number">68</span> msec
    <span class="token number">3</span> <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span> <span class="token number">120</span> msec <span class="token operator">*</span>  <span class="token number">116</span> msec</code></pre>
<p>可以看到 MPLS 已经生效，<code>traceroute</code>的 ICMP 包当前正是使用 MPLS 进行转发；</p>
<h2 id="实验2：MPLS-LDP自动配置；"><a href="#实验2：MPLS-LDP自动配置；" class="headerlink" title="实验2：MPLS LDP自动配置；"></a>实验2：MPLS LDP自动配置；</h2><p>在R4上查看启用MPLS的接口详细信息：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls interface detail
Interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span>
  IP labeling <span class="token function">enabled</span> <span class="token punctuation">(</span>ldp<span class="token punctuation">)</span><span class="token operator">:</span> 
   Interface config
  LSP Tunnel labeling not enabled
  BGP labeling not enabled
  MPLS operational
  MTU <span class="token operator">=</span> <span class="token number">1500</span>
<span class="token comment">//可以看到接口F0/0已经启用了LDP，并且是在接口下通过手动配置启用的；</span>

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token keyword">if</span><span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp discovery detail
 Local LDP Identifier<span class="token operator">:</span>
 <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>
 Discovery Sources<span class="token operator">:</span>
 Interfaces<span class="token operator">:</span>
  FastEthernet0<span class="token operator">/</span><span class="token number">0</span> <span class="token punctuation">(</span>ldp<span class="token punctuation">)</span><span class="token operator">:</span> xmit<span class="token operator">/</span>recv
   Enabled<span class="token operator">:</span> Interface config
   Hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms<span class="token punctuation">;</span> Transport IP addr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> 
   LDP Id<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>
    Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span><span class="token punctuation">;</span> Transport IP addr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>
    Hold time<span class="token operator">:</span> <span class="token number">15</span> sec<span class="token punctuation">;</span> Proposed local<span class="token operator">/</span>peer<span class="token operator">:</span> <span class="token number">15</span><span class="token operator">/</span><span class="token number">15</span> sec
    Reachable via <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span>
    Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
   Clients<span class="token operator">:</span> IPv4
<span class="token comment">//通过查看R4的LDP邻居发现详情也可以看到接口F0/0是通过在接口下手动配置启用的MPLS LDP；</span></code></pre>

<p>禁用之前在接口下启用的MPLS：</p>
<pre class="language-none"><code class="language-none">R4(config)#int f0&#x2F;0
R4(config-if)#no mpls ip</code></pre>

<p>在R4的OSPF路由器配置模式下启用MPLS LDP自动配置；</p>
<pre class="language-none"><code class="language-none">R4(config)#router ospf 1
R4(config-router)#mpls ldp autoconfig </code></pre>

<p>在R4上验证：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls interface detail
Interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span>
  IP labeling <span class="token function">enabled</span> <span class="token punctuation">(</span>ldp<span class="token punctuation">)</span><span class="token operator">:</span>
   IGP config
  LSP Tunnel labeling not enabled
  BGP labeling not enabled
  MPLS operational
  MTU <span class="token operator">=</span> <span class="token number">1500</span>
<span class="token comment">//可以看到，接口F0/0现在已经启用了LDP，但现在是通过IGP自动配置的方式启用的；</span>

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ldp discovery detail
 Local LDP Identifier<span class="token operator">:</span>
 <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>
 Discovery Sources<span class="token operator">:</span>
 Interfaces<span class="token operator">:</span>
  FastEthernet0<span class="token operator">/</span><span class="token number">0</span> <span class="token punctuation">(</span>ldp<span class="token punctuation">)</span><span class="token operator">:</span> xmit<span class="token operator">/</span>recv
   Enabled<span class="token operator">:</span> IGP config<span class="token punctuation">;</span>
   Hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms<span class="token punctuation">;</span> Transport IP addr<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> 
   LDP Id<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>
    Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span><span class="token punctuation">;</span> Transport IP addr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span>
    Hold time<span class="token operator">:</span> <span class="token number">15</span> sec<span class="token punctuation">;</span> Proposed local<span class="token operator">/</span>peer<span class="token operator">:</span> <span class="token number">15</span><span class="token operator">/</span><span class="token number">15</span> sec
    Reachable via <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span>
    Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
   Clients<span class="token operator">:</span> IPv4
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>router<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls interface detail
Interface FastEthernet0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span>
  IP labeling <span class="token function">enabled</span> <span class="token punctuation">(</span>ldp<span class="token punctuation">)</span><span class="token operator">:</span>
   IGP config
  LSP Tunnel labeling not enabled
  BGP labeling not enabled
  MPLS operational
  MTU <span class="token operator">=</span> <span class="token number">1500</span>
<span class="token comment">//可以看到，接口F0/0现在已经启用了LDP，但现在是通过IGP自动配置的方式启用的；</span></code></pre>
<blockquote>
<p>注意：MPLS LDP自动配置目前只支持OSPF；</p>
</blockquote>
<h2 id="实验3：修改MPLS-LDP-计时器；"><a href="#实验3：修改MPLS-LDP-计时器；" class="headerlink" title="实验3：修改MPLS LDP 计时器；"></a>实验3：修改MPLS LDP 计时器；</h2><p>可以使用命令<code>show mpls ldp parameters</code>查看 LDP 当前使用的计时器参数：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show mpls ldp parameters 
Protocol version<span class="token operator">:</span> <span class="token number">1</span>
Downstream label generic region<span class="token operator">:</span> min label<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">;</span> max label<span class="token operator">:</span> <span class="token number">100000</span>
Session hold time<span class="token operator">:</span> <span class="token number">180</span> sec<span class="token punctuation">;</span> keep alive interval<span class="token operator">:</span> <span class="token number">60</span> sec   <span class="token comment">//LDP TCP会话保持时间为180秒，LDP TCP会话Keep Alive消息发送间隔为60秒；</span>
Discovery hello<span class="token operator">:</span> holdtime<span class="token operator">:</span> <span class="token number">15</span> sec<span class="token punctuation">;</span> interval<span class="token operator">:</span> <span class="token number">5</span> sec  <span class="token comment">//LDP Discovery hello保持时间为15秒，hello消息发送时间间隔为5秒；</span>
Discovery targeted hello<span class="token operator">:</span> holdtime<span class="token operator">:</span> <span class="token number">90</span> sec<span class="token punctuation">;</span> interval<span class="token operator">:</span> <span class="token number">10</span> sec  <span class="token comment">//目标邻居Discovery hello保持时间为90秒，hello消息发送间隔为10秒；</span>
Downstream on Demand max hop count<span class="token operator">:</span> <span class="token number">255</span>
Downstream on Demand Path Vector Limit<span class="token operator">:</span> <span class="token number">255</span>
LDP <span class="token keyword">for</span> targeted sessions
LDP initial<span class="token operator">/</span>maximum backoff<span class="token operator">:</span> <span class="token number">15</span><span class="token operator">/</span><span class="token number">120</span> sec
LDP loop detection<span class="token operator">:</span> off</code></pre>

<p>在R1上修改MPLS LDP邻居发现hello 发送间隔和保持时间：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//将R1的MPLS LDP邻居发现hello时间间隔设置为10秒；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp discovery hello interval <span class="token number">10</span>
<span class="token comment">//将R1的MPLS LDP邻居发现保持时间设置为30秒；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp discovery hello holdtime <span class="token number">30</span></code></pre>

<p>在R1上验证MPLS LDP参数信息：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp parameter
LDP Feature Set Manager<span class="token operator">:</span> State Initialized
 LDP features<span class="token operator">:</span>
 Basic
 IP<span class="token operator">-</span>over<span class="token operator">-</span>MPLS
 TDP
 IGP<span class="token operator">-</span>Sync
 Auto<span class="token operator">-</span>Configuration
 TCP<span class="token operator">-</span>MD5<span class="token operator">-</span>Rollover
Protocol version<span class="token operator">:</span> <span class="token number">1</span>
Session hold time<span class="token operator">:</span> <span class="token number">180</span> sec<span class="token punctuation">;</span> keep alive interval<span class="token operator">:</span> <span class="token number">60</span> sec
Discovery hello<span class="token operator">:</span> holdtime<span class="token operator">:</span> <span class="token number">30</span> sec<span class="token punctuation">;</span> interval<span class="token operator">:</span> <span class="token number">10</span> sec
Discovery targeted hello<span class="token operator">:</span> holdtime<span class="token operator">:</span> <span class="token number">90</span> sec<span class="token punctuation">;</span> interval<span class="token operator">:</span> <span class="token number">10</span> sec
Downstream on Demand max hop count<span class="token operator">:</span> <span class="token number">255</span>
LDP <span class="token keyword">for</span> targeted sessions
LDP initial<span class="token operator">/</span>maximum backoff<span class="token operator">:</span> <span class="token number">15</span><span class="token operator">/</span><span class="token number">120</span> sec
LDP loop detection<span class="token operator">:</span> off
<span class="token comment">//可以看到R1的LDP Discovery计时器的hello interval被修改为30秒，holdtime被修改为10秒；</span></code></pre>

<p>验证LDP Discovery 计时器：</p>
<pre class="language-c" data-language="c"><code class="language-c">R1#show mpls ldp neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> detail
 Peer LDP Ident<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
  TCP connection<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token number">.42221</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
  Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
  State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">82</span><span class="token operator">/</span><span class="token number">81</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">16</span>
  Up time<span class="token operator">:</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">47</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> Peer Id <span class="token number">0</span><span class="token punctuation">;</span>
  LDP discovery sources<span class="token operator">:</span>
   FastEthernet0<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> 
   holdtime<span class="token operator">:</span> <span class="token number">15000</span> ms<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms
  Addresses bound to peer LDP Ident<span class="token operator">:</span>
   <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>    <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span>    <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>         
  Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
  Capabilities Sent<span class="token operator">:</span>
   <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  Capabilities Received<span class="token operator">:</span>
   <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

R1#show mpls ldp discovery detail
 Local LDP Identifier<span class="token operator">:</span>
 <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
 Discovery Sources<span class="token operator">:</span>
 Interfaces<span class="token operator">:</span>
  FastEthernet0<span class="token operator">/</span><span class="token number">0</span> <span class="token punctuation">(</span>ldp<span class="token punctuation">)</span><span class="token operator">:</span> xmit<span class="token operator">/</span>recv
   Enabled<span class="token operator">:</span> Interface config
   Hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms<span class="token punctuation">;</span> Transport IP addr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> 
   LDP Id<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span>
    Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span><span class="token punctuation">;</span> Transport IP addr<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
    Hold time<span class="token operator">:</span> <span class="token number">15</span> sec<span class="token punctuation">;</span> Proposed local<span class="token operator">/</span>peer<span class="token operator">:</span> <span class="token number">30</span><span class="token operator">/</span><span class="token number">15</span> sec
    Reachable via <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span>
    Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
   Clients<span class="token operator">:</span> IPv4
<span class="token comment">//可以看到邻居LSR的LDP Discovery hello interval为5秒,holdtime为15秒；</span>
<span class="token comment">//本地的Holdtime为30秒；</span></code></pre>

<p>在R1上修改LDP TCP会话保持时间设置为300秒：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp holdtime <span class="token number">300</span> 
<span class="token operator">%</span>Previously established sessions may not use the new holdtime<span class="token punctuation">.</span>
<span class="token comment">//要让新的保持时间立即生效，需要重置一下LDP邻居关系；</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> clear mpls ldp neighbor <span class="token operator">*</span></code></pre>
<blockquote>
<p>注意：LDP TCP会话保持时间被修改后，LDP会话的Keep Alive计时器值自动被修改为保持时间的1&#x2F;3；</p>
</blockquote>
<p>验证R1的MPLS LDP TCP会话保持时间：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp parameters
LDP Feature Set Manager<span class="token operator">:</span> State Initialized
 LDP features<span class="token operator">:</span>
 Basic
 IP<span class="token operator">-</span>over<span class="token operator">-</span>MPLS
 TDP
 IGP<span class="token operator">-</span>Sync
 Auto<span class="token operator">-</span>Configuration
 TCP<span class="token operator">-</span>MD5<span class="token operator">-</span>Rollover
Protocol version<span class="token operator">:</span> <span class="token number">1</span>
Session hold time<span class="token operator">:</span> <span class="token number">300</span> sec<span class="token punctuation">;</span> keep alive interval<span class="token operator">:</span> <span class="token number">100</span> sec
Discovery hello<span class="token operator">:</span> holdtime<span class="token operator">:</span> <span class="token number">30</span> sec<span class="token punctuation">;</span> interval<span class="token operator">:</span> <span class="token number">10</span> sec
Discovery targeted hello<span class="token operator">:</span> holdtime<span class="token operator">:</span> <span class="token number">90</span> sec<span class="token punctuation">;</span> interval<span class="token operator">:</span> <span class="token number">10</span> sec
Downstream on Demand max hop count<span class="token operator">:</span> <span class="token number">255</span>
LDP <span class="token keyword">for</span> targeted sessions
LDP initial<span class="token operator">/</span>maximum backoff<span class="token operator">:</span> <span class="token number">15</span><span class="token operator">/</span><span class="token number">120</span> sec
LDP loop detection<span class="token operator">:</span> off
<span class="token comment">//可以看到R1本地的LDP会话保持时间已经为300秒，其Keep Alive Interval自动被设置为100秒；</span></code></pre>

<p>查看邻居LDP对等体的MPLS LDP TCP会话保持时间：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> detail                         
 Peer LDP Ident<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
  TCP connection<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token number">.21743</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
  Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
  State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">15</span><span class="token operator">/</span><span class="token number">14</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">16</span>
  Up time<span class="token operator">:</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span> Peer Id <span class="token number">0</span><span class="token punctuation">;</span>
  LDP discovery sources<span class="token operator">:</span>
   FastEthernet0<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> 
   holdtime<span class="token operator">:</span> <span class="token number">15000</span> ms<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms
  Addresses bound to peer LDP Ident<span class="token operator">:</span>
   <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>    <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span>    <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>         
  Peer holdtime<span class="token operator">:</span> <span class="token number">180000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">60000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
  Capabilities Sent<span class="token operator">:</span>
   <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  Capabilities Received<span class="token operator">:</span>
   <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>
<ul>
<li>注意到邻居对等体的保持时间仍然为180秒，Keep Alive Interval仍然是60秒；其原因在于，和LDP Discovery计时器取较小值相同，LDP TCP会话计时器也取较小值；</li>
<li>由于刚刚修改LDP 会话保持时间为300秒，此值大于默认的180秒；</li>
</ul>
<p>修改R2的LDP TCP会话保持时间改为900秒：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp holdtime <span class="token number">900</span>
<span class="token operator">%</span>Previously established sessions may not use the new holdtime<span class="token punctuation">.</span>

<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> clear mpls ldp neighbor <span class="token operator">*</span></code></pre>

<p>可以看到R2本地的LDP TCP会话保持时间已经被设置为900秒，KA Interval自动被设置为300秒：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ldp parameters
LDP Feature Set Manager<span class="token operator">:</span> State Initialized
 LDP features<span class="token operator">:</span>
 Basic
 IP<span class="token operator">-</span>over<span class="token operator">-</span>MPLS
 TDP
 IGP<span class="token operator">-</span>Sync
 Auto<span class="token operator">-</span>Configuration
 TCP<span class="token operator">-</span>MD5<span class="token operator">-</span>Rollover
Protocol version<span class="token operator">:</span> <span class="token number">1</span>
Session hold time<span class="token operator">:</span> <span class="token number">900</span> sec<span class="token punctuation">;</span> keep alive interval<span class="token operator">:</span> <span class="token number">300</span> sec
Discovery hello<span class="token operator">:</span> holdtime<span class="token operator">:</span> <span class="token number">15</span> sec<span class="token punctuation">;</span> interval<span class="token operator">:</span> <span class="token number">5</span> sec
Discovery targeted hello<span class="token operator">:</span> holdtime<span class="token operator">:</span> <span class="token number">90</span> sec<span class="token punctuation">;</span> interval<span class="token operator">:</span> <span class="token number">10</span> sec
Downstream on Demand max hop count<span class="token operator">:</span> <span class="token number">255</span>
LDP <span class="token keyword">for</span> targeted sessions
LDP initial<span class="token operator">/</span>maximum backoff<span class="token operator">:</span> <span class="token number">15</span><span class="token operator">/</span><span class="token number">120</span> sec
LDP loop detection<span class="token operator">:</span> off</code></pre>
<p>回到R1上查看LDP 邻居对等体R2实际使用的LDP会话保持时间：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> detail
 Peer LDP Ident<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
  TCP connection<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token number">.37641</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
  Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
  State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">12</span><span class="token operator">/</span><span class="token number">12</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">16</span>
  Up time<span class="token operator">:</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">58</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">;</span> Peer Id <span class="token number">0</span><span class="token punctuation">;</span>
  LDP discovery sources<span class="token operator">:</span>
   FastEthernet0<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span> Src IP addr<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span> 
   holdtime<span class="token operator">:</span> <span class="token number">15000</span> ms<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">5000</span> ms
  Addresses bound to peer LDP Ident<span class="token operator">:</span>
   <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.2</span>    <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.2</span>    <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>         
  Peer holdtime<span class="token operator">:</span> <span class="token number">300000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">100000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
  Capabilities Sent<span class="token operator">:</span>
   <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  Capabilities Received<span class="token operator">:</span>
   <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>
<ul>
<li>可以看到虽然R2本地的LDP 会话保持时间已经被设置为900秒，但是在与R1协商后，由于R1的LDP会话保持时间300秒小于R2的900秒，所以R2使用300秒作为LDP会话保持时间；<blockquote>
<p><strong>注意，LDP邻居计时器可以不一致，当两台LDP邻居对等体在交换参数的时候，取较小的计时器值，Discovery计时器如此，LDP TCP会话保持时间亦如此，基于目标的LDP邻居会话同样如此；</strong></p>
</blockquote>
</li>
</ul>
<h2 id="实验4：LDP认证：在R1和R2之间配置LDP身份认证"><a href="#实验4：LDP认证：在R1和R2之间配置LDP身份认证" class="headerlink" title="实验4：LDP认证：在R1和R2之间配置LDP身份认证"></a>实验4：LDP认证：在R1和R2之间配置LDP身份认证</h2><p>为避免等待验证实验现象时间较长，修改LDP 会话保持时间为15秒：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp holdtime <span class="token number">15</span></code></pre>

<p>在R1上针对邻居2.2.2.2启用LDP认证：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span> password cisco</code></pre>

<p><strong>注意：实验中，发现如果不重置LDP邻居对等体关系，LDP身份认证配置无法生效；</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> clear mpls ldp nei <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>  
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">13</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">40.426</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>CLEAR_NBRS<span class="token operator">:</span> Clear LDP <span class="token function">neighbors</span> <span class="token punctuation">(</span><span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token punctuation">)</span> by console
<span class="token operator">*</span>Mar <span class="token number">13</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">40.466</span><span class="token operator">:</span> <span class="token operator">%</span>LDP<span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span>NBRCHG<span class="token operator">:</span> LDP Neighbor <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> is <span class="token function">DOWN</span> <span class="token punctuation">(</span>User cleared session manually<span class="token punctuation">)</span>
<span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#
<span class="token operator">*</span>Mar <span class="token number">13</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">42.822</span><span class="token operator">:</span> <span class="token operator">%</span>TCP<span class="token operator">-</span><span class="token number">6</span><span class="token operator">-</span>BADAUTH<span class="token operator">:</span> No MD5 digest from <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token punctuation">(</span><span class="token number">11164</span><span class="token punctuation">)</span> to <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">(</span><span class="token number">646</span><span class="token punctuation">)</span></code></pre>

<p>由于R2还未配置LDP认证，重置LDP邻居关系后，出现TCP认证报错日志，没有MD5摘要来自2.2.2.2：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//在R2上针对邻居1.1.1.1启用LDP认证；</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> password cisco    
<span class="token comment">//注意：实验中，发现如果不重置LDP邻居对等体关系，LDP身份认证配置无法生效；</span>
<span class="token function">R2</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> clear mpls ldp nei <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span></code></pre>

<h2 id="实验5：基于目标的LDP会话"><a href="#实验5：基于目标的LDP会话" class="headerlink" title="实验5：基于目标的LDP会话"></a>实验5：基于目标的LDP会话</h2><p>配置R1与R4建立基于目标的远程LDP会话</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//在R1上指定远程LDP邻居；</span>
 <span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> targeted
 <span class="token comment">//注意，如果一台LSR只配置命令mpls ldp neighbor ip-address targeted，则这台LSR为远程LDP会话的主动发起方；</span>

<span class="token comment">//设置的基于目标的LDP邻居会话Discovery Hello Interval和Holdtime；</span>
 <span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp discovery targeted<span class="token operator">-</span>hello interval <span class="token number">10</span>
 <span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp discovery targeted<span class="token operator">-</span>hello holdtime <span class="token number">30</span>

<span class="token comment">//配置R1只允许R4与自己建立远程LDP邻居，通过配置R1只接受R4发送给自己的Discovery Hello消息来实现；</span>
 <span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp discovery targeted<span class="token operator">-</span>hello accept from <span class="token number">1</span>
 <span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#access<span class="token operator">-</span>list <span class="token number">1</span> permit host <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>
 <span class="token comment">//注意，如果一台LSR只配置命令mpls ldp discovery targeted-hello accept from，则这台LSR为远程LDP会话的被动接受方；</span>
 <span class="token comment">//注意：当一台LSR只配置此命令，并不是说这台LSR只能接收主动发起方通告来的标签绑定信息，</span>
 <span class="token comment">//即使，一台LSR只配置了此命令，当其与远程LDP会话主动发起方建立LDP远程会话之后，</span>
 <span class="token comment">//被动接受方LSR也会向主动发起方LSR通告自己的入标签；</span></code></pre>

<p>在R4上指定远程LDP邻居；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> targeted

<span class="token comment">//配置R4只允许R1与自己建立远程LDP邻居，通过配置R4只接受R1发送给自己的Discovery Hello消息来实现；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp discovery targeted<span class="token operator">-</span>hello accept from <span class="token number">1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#access<span class="token operator">-</span>list <span class="token number">1</span> permit host <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>

<span class="token comment">//注意：如果一台LSR同时配置了命令mpls ldp discovery targeted-hello accept from和命令mpls ldp neighbor ip-address targeted，</span>
<span class="token comment">//则这台路由器既是远程基于目标LDP会话的主动发起方，同时也是被动接受方；</span></code></pre>

<p>验证R1基于目标LDP会话计时器配置</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> sh mpls ldp parameters               
LDP Feature Set Manager<span class="token operator">:</span> State Initialized
 LDP features<span class="token operator">:</span>
 Basic
 IP<span class="token operator">-</span>over<span class="token operator">-</span>MPLS
 TDP
 IGP<span class="token operator">-</span>Sync
 Auto<span class="token operator">-</span>Configuration
 TCP<span class="token operator">-</span>MD5<span class="token operator">-</span>Rollover
Protocol version<span class="token operator">:</span> <span class="token number">1</span>
Session hold time<span class="token operator">:</span> <span class="token number">15</span> sec<span class="token punctuation">;</span> keep alive interval<span class="token operator">:</span> <span class="token number">5</span> sec
Discovery hello<span class="token operator">:</span> holdtime<span class="token operator">:</span> <span class="token number">30</span> sec<span class="token punctuation">;</span> interval<span class="token operator">:</span> <span class="token number">10</span> sec
Discovery targeted hello<span class="token operator">:</span> holdtime<span class="token operator">:</span> <span class="token number">30</span> sec<span class="token punctuation">;</span> interval<span class="token operator">:</span> <span class="token number">10</span> sec
Accepting targeted hellos<span class="token punctuation">;</span> peer acl<span class="token operator">:</span> <span class="token number">1</span>
Downstream on Demand max hop count<span class="token operator">:</span> <span class="token number">255</span>
LDP <span class="token keyword">for</span> targeted sessions
LDP initial<span class="token operator">/</span>maximum backoff<span class="token operator">:</span> <span class="token number">15</span><span class="token operator">/</span><span class="token number">120</span> sec
LDP loop detection<span class="token operator">:</span> off
<span class="token comment">//可以看到R1本地基于目标的LDP会话Discovery Hello Interval为10秒，Holdtime为30秒；</span>
<span class="token comment">//R1接受基于目标的Hello消息，并且基于ACL1来进行远程邻居对等体过滤；</span></code></pre>

<p>在R1上查看MPLS LDP邻居R4的信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R1</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ldp neighbor <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> detail
 Peer LDP Ident<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>
  TCP connection<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.61631</span> <span class="token operator">-</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span>
  Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
  State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">75</span><span class="token operator">/</span><span class="token number">75</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">17</span>
  Up time<span class="token operator">:</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">44</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span> Peer Id <span class="token number">2</span><span class="token punctuation">;</span>
  LDP discovery sources<span class="token operator">:</span>
   Targeted Hello <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> <span class="token operator">-></span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span> active<span class="token punctuation">,</span> passive<span class="token punctuation">;</span><span class="token comment">//R1与R4已建立远程LDP会话；关键字active和passive表示R1是远程会话的主动发起方和被动接受方；</span>
   holdtime<span class="token operator">:</span> infinite<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">3333</span> ms
  Addresses bound to peer LDP Ident<span class="token operator">:</span>
   <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.4</span>    <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.4</span>    <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span>         
  Peer holdtime<span class="token operator">:</span> <span class="token number">15000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">5000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
  Clients<span class="token operator">:</span> Dir Adj Client
  Capabilities Sent<span class="token operator">:</span>
   <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  Capabilities Received<span class="token operator">:</span>
   <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>

<p>在R4上查看MPLS LDP邻居R1的信息；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ldp neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> detail
 Peer LDP Ident<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> Local LDP Ident <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">:</span><span class="token number">0</span>
  TCP connection<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token number">.646</span> <span class="token operator">-</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token number">.61631</span>
  Password<span class="token operator">:</span> not required<span class="token punctuation">,</span> none<span class="token punctuation">,</span> in use
  State<span class="token operator">:</span> Oper<span class="token punctuation">;</span> Msgs sent<span class="token operator">/</span>rcvd<span class="token operator">:</span> <span class="token number">86</span><span class="token operator">/</span><span class="token number">85</span><span class="token punctuation">;</span> Downstream<span class="token punctuation">;</span> Last TIB rev sent <span class="token number">17</span>
  Up time<span class="token operator">:</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">;</span> UID<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">;</span> Peer Id <span class="token number">2</span><span class="token punctuation">;</span>
  LDP discovery sources<span class="token operator">:</span>
   Targeted Hello <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> <span class="token operator">-></span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">,</span> active<span class="token punctuation">,</span> passive<span class="token punctuation">;</span><span class="token comment">//R1与R4已建立远程LDP会话；关键字active和passive表示R1是远程会话的主动发起方和被动接受方；</span>
   holdtime<span class="token operator">:</span> infinite<span class="token punctuation">,</span> hello interval<span class="token operator">:</span> <span class="token number">3333</span> ms
  Addresses bound to peer LDP Ident<span class="token operator">:</span>
   <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.1</span>    <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.1</span>    <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>         
  Peer holdtime<span class="token operator">:</span> <span class="token number">15000</span> ms<span class="token punctuation">;</span> KA interval<span class="token operator">:</span> <span class="token number">5000</span> ms<span class="token punctuation">;</span> Peer state<span class="token operator">:</span> estab
  Clients<span class="token operator">:</span> Dir Adj Client
  Capabilities Sent<span class="token operator">:</span>
   <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  Capabilities Received<span class="token operator">:</span>
   <span class="token punctuation">[</span><span class="token function">ICCP</span> <span class="token punctuation">(</span>type <span class="token number">0x0405</span><span class="token punctuation">)</span> MajVer <span class="token number">1</span> MinVer <span class="token number">0</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Dynamic <span class="token function">Announcement</span> <span class="token punctuation">(</span><span class="token number">0x0506</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span>Typed <span class="token function">Wildcard</span> <span class="token punctuation">(</span><span class="token number">0x050B</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>


<h2 id="实验6：控制LDP标签通告；"><a href="#实验6：控制LDP标签通告；" class="headerlink" title="实验6：控制LDP标签通告；"></a>实验6：控制LDP标签通告；</h2><p>配置MPLS LDP来向特定的LDP对等体通告或者不通告特定的标签；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//在R4上查看LIB;</span>
R4#show mpls ldp bindings
 lib entry<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">14</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">19</span>
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">18</span>
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
 lib entry<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">12</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">18</span>
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">17</span>
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">16</span>
 lib entry<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">8</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">16</span>
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">19</span>
 lib entry<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">2</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">16</span>
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">18</span>
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">16</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">20</span>
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">19</span>
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">17</span>
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">10</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">17</span>
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">17</span>
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">6</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">20</span>
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">4</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null

R4#show mpls ip binding
 <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> 
  in label<span class="token operator">:</span>     <span class="token number">19</span>        
  out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
  out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span> 
  in label<span class="token operator">:</span>     <span class="token number">18</span>        
  out label<span class="token operator">:</span>    <span class="token number">17</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
  out label<span class="token operator">:</span>    <span class="token number">16</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> 
  in label<span class="token operator">:</span>     <span class="token number">16</span>        
  out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
  out label<span class="token operator">:</span>    <span class="token number">19</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> 
  in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
  out label<span class="token operator">:</span>    <span class="token number">16</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>       
  out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  in label<span class="token operator">:</span>     <span class="token number">20</span>        
  out label<span class="token operator">:</span>    <span class="token number">19</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
  out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  in label<span class="token operator">:</span>     <span class="token number">17</span>        
  out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
  out label<span class="token operator">:</span>    <span class="token number">17</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
  out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>       
  out label<span class="token operator">:</span>    <span class="token number">20</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null</code></pre>


<p><strong>在R3上进行配置，让R3只将与环回口的前缀相绑定的标签通告给R4；</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//配置ACL以确定准许通告的特定前缀；</span>
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip access<span class="token operator">-</span>list standard PERMIT_LOOPBACK 
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#permit
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#permit host <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#permit host <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span>
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#permit host <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> 
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#exit

<span class="token comment">//配置ACL以确定特定的LDP对等体可以接收标签绑定信息；</span>
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip access<span class="token operator">-</span>list standard PEER_R4
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#permit host <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span> 
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#exit

<span class="token comment">//配置LDP不向外通告任何标签；</span>
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#no mpls ldp advertise<span class="token operator">-</span>labels

<span class="token comment">//配置LDP向对等体PEER_R4通告前缀PERMIT_LOOPBACK的标签绑定信息；</span>
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp advertise<span class="token operator">-</span>labels <span class="token keyword">for</span> PERMIT_LOOPBACK to PEER_R4

<span class="token comment">//查看R3的标签通告信息；</span>
<span class="token function">R3</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ldp bindings advertisement<span class="token operator">-</span>acls
Advertisement spec<span class="token operator">:</span>
 Prefix acl <span class="token operator">=</span> PERMIT_LOOPBACK<span class="token punctuation">;</span> Peer acl <span class="token operator">=</span> PEER_R4

lib entry<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">22</span>
 Advert <span class="token function">acl</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">:</span> Prefix acl PERMIT_LOOPBACK<span class="token punctuation">;</span> Peer acl PEER_R4
lib entry<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">23</span>
 Advert <span class="token function">acl</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">:</span> Prefix acl PERMIT_LOOPBACK<span class="token punctuation">;</span> Peer acl PEER_R4
lib entry<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">24</span>
 Advert <span class="token function">acl</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">:</span> Prefix acl PERMIT_LOOPBACK<span class="token punctuation">;</span> Peer acl PEER_R4
lib entry<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">25</span>
lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">26</span>
lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">27</span>
lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">28</span>
lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">29</span>
<span class="token comment">//可以看到R3基于ACL PERMIT_LOOPBACK来确定需要通告的与特定前缀相绑定的标签和可以接收标签绑定信息的LDP对等体PEER_R4；</span></code></pre>

<p>在R4上查看来自LDP对等体的标签绑定信息；</p>
<pre class="language-c" data-language="c"><code class="language-c">R4#show mpls ldp bindings neighbor <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> detail
 lib entry<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">14</span><span class="token punctuation">,</span> chkpt<span class="token operator">:</span> none
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">18</span>
 lib entry<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">12</span><span class="token punctuation">,</span> chkpt<span class="token operator">:</span> none
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">17</span>
 lib entry<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">8</span><span class="token punctuation">,</span> chkpt<span class="token operator">:</span> none
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
 lib entry<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">2</span>
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">16</span>
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">17</span>
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">10</span>
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">6</span>
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">4</span>
<span class="token comment">//可以看到R4确实只收到了与环回口前缀相绑定的标签；</span>

<span class="token comment">//查看R4的LIB；</span>
R4#show mpls ip binding
 <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> 
  in label<span class="token operator">:</span>     <span class="token number">19</span>        
  out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse  <span class="token comment">//inuse表示该标签已被放入LFIB表，并用来转发流量；</span>
  out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span> 
  in label<span class="token operator">:</span>     <span class="token number">18</span>        
  out label<span class="token operator">:</span>    <span class="token number">17</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
  out label<span class="token operator">:</span>    <span class="token number">16</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> 
  in label<span class="token operator">:</span>     <span class="token number">16</span>        
  out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
  out label<span class="token operator">:</span>    <span class="token number">19</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> 
  in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
  out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  in label<span class="token operator">:</span>     <span class="token number">20</span>        
  out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  in label<span class="token operator">:</span>     <span class="token number">17</span>        
  out label<span class="token operator">:</span>    <span class="token number">17</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
  out label<span class="token operator">:</span>    <span class="token number">20</span>        lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null
<span class="token comment">//可以看到虽然R3只向R4通告了环回口前缀的标签绑定信息，</span>
<span class="token comment">//但是由于R4和R1有远程目标对等体关系，所R4还是从R1哪里收到其他前缀的标签；</span>

<span class="token comment">//查看R4的LFIB；</span>
R4#show mpls forwarding<span class="token operator">-</span>table
Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
Label      Label      or Tunnel Id     Switched      interface              
<span class="token number">16</span>         Pop Label  <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">17</span>         No Label   <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>  <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">18</span>         <span class="token number">17</span>         <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">19</span>         <span class="token number">18</span>         <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span>       <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span>
<span class="token number">20</span>         No Label   <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>  <span class="token number">0</span>             Fa0<span class="token operator">/</span><span class="token number">0</span>      <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.3</span></code></pre>
<p><strong>配置MPLS LDP，使其有选择地过滤接收到的特定前缀标签绑定信息</strong></p>
<ul>
<li>配置R4仅仅接收R1环回口1.1.1.1&#x2F;32的标签绑定信息；</li>
</ul>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//配置ACL以确定准许接受的特定前缀；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#ip access<span class="token operator">-</span>list standard PERMIT_R1_LOOPBACK
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#permit host <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token operator">-</span>std<span class="token operator">-</span>nacl<span class="token punctuation">)</span>#exit
 
<span class="token comment">//针对LDP邻居R1和R3应用ACL以过滤接收到的特定前缀的绑定信息；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp neighbor <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span> labels accept PERMIT_R1_LOOPBACK
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#mpls ldp neighbor <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span> labels accept PERMIT_R1_LOOPBACK
  
<span class="token comment">//查看R4的LIB表，以验证实验配置；</span>
<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ldp bindings
 lib entry<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">14</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">19</span>
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> <span class="token number">18</span>
  remote binding<span class="token operator">:</span> lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> label<span class="token operator">:</span> imp<span class="token operator">-</span>null
 lib entry<span class="token operator">:</span> <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">12</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">18</span>
 lib entry<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">8</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">16</span>
 lib entry<span class="token operator">:</span> <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span><span class="token punctuation">,</span> rev <span class="token number">2</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">16</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">20</span>
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">10</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> <span class="token number">17</span>
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">6</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null
 lib entry<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">,</span> rev <span class="token number">4</span>
  local binding<span class="token operator">:</span>  label<span class="token operator">:</span> imp<span class="token operator">-</span>null

<span class="token function">R4</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>#<span class="token keyword">do</span> show mpls ip binding
 <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> 
  in label<span class="token operator">:</span>     <span class="token number">19</span>        
  out label<span class="token operator">:</span>    <span class="token number">18</span>        lsr<span class="token operator">:</span> <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">:</span><span class="token number">0</span>        inuse
  out label<span class="token operator">:</span>    imp<span class="token operator">-</span>null  lsr<span class="token operator">:</span> <span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">0</span>       
 <span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">32</span> 
  in label<span class="token operator">:</span>     <span class="token number">18</span>        
 <span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token operator">/</span><span class="token number">32</span> 
  in label<span class="token operator">:</span>     <span class="token number">16</span>        
 <span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">32</span> 
  in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
 <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  in label<span class="token operator">:</span>     <span class="token number">20</span>        
 <span class="token number">192.168</span><span class="token number">.23</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  in label<span class="token operator">:</span>     <span class="token number">17</span>        
 <span class="token number">192.168</span><span class="token number">.34</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null  
 <span class="token number">192.168</span><span class="token number">.47</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> 
  in label<span class="token operator">:</span>     imp<span class="token operator">-</span>null
<span class="token comment">//可以看到R4的LIB表中确实只有R1前缀1.1.1.1/32的标签绑定信息；</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">filefi</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script size="300" alpha="0.45" zIndex="-1" src="/plugins/ribbon.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/comments.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/schemes/muse.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/next-boot.min.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.11.1/source/js/third-party/search/local-search.min.js"></script>





  





</body>
</html>
